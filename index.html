<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="‰∏ì‰∏öÁöÑÈîÄÂîÆËÆ∞ÂΩïÁÆ°ÁêÜ‰∏éÁªüËÆ°ÂàÜÊûêÂπ≥Âè∞">
    <meta name="keywords" content="ÈîÄÂîÆÁÆ°ÁêÜ,ËÆ∞ÂΩïÁ≥ªÁªü,Êï∞ÊçÆÁªüËÆ°">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="theme-color" content="#4CAF50">
    
    <!-- ÊÄßËÉΩ‰ºòÂåñÔºöDNSÈ¢ÑËß£Êûê -->
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//unpkg.com">
    
    <!-- ÊÄßËÉΩ‰ºòÂåñÔºöÈ¢ÑËøûÊé•CDN -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    
    <!-- ÊÄßËÉΩ‰ºòÂåñÔºöÈ¢ÑÂä†ËΩΩÂÖ≥ÈîÆËµÑÊ∫ê -->
    <link rel="preload" as="style" href="data:text/css,body{visibility:hidden}" onload="this.rel='stylesheet'">
    
    <title>ÈîÄÂîÆËÆ∞ÂΩïÁÆ°ÁêÜÁ≥ªÁªü</title>
    
    <!-- ÊÄßËÉΩÁõëÊéßÔºöÈÅøÂÖçÈòªÂ°ûÊ∏≤ÊüìÁöÑËÑöÊú¨ -->
    <script>
        // ÊÄßËÉΩ‰ºòÂåñÔºöÊó©ÊúüÈîôËØØÊçïËé∑ÂíåÊÄßËÉΩÁõëÊéß
        window.addEventListener('error', function(e) {
            console.warn('ËÑöÊú¨Âä†ËΩΩÈîôËØØÔºàÂ∑≤ÂøΩÁï•Ôºâ:', e.filename, e.lineno, e.message);
        });
        
        // ÊÄßËÉΩ‰ºòÂåñÔºöÊ£ÄÊµãÊµèËßàÂô®ÊîØÊåÅ
        if (!window.requestAnimationFrame) {
            window.requestAnimationFrame = window.setTimeout;
        }
        if (!window.requestIdleCallback) {
            window.requestIdleCallback = function(fn, options) {
                return setTimeout(fn, (options && options.timeout) || 0);
            };
        }
        
        // ÊÄßËÉΩÊèêÁ§∫ÔºöÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        document.addEventListener('DOMContentLoaded', function() {
            document.body.style.visibility = 'visible';
            console.log('üöÄ È°µÈù¢Ê∏≤ÊüìÂÆåÊàêÔºåÂºÄÂßãÂàùÂßãÂåñ...');
        });
    </script>
    
    <!-- SupabaseÂÆ¢Êà∑Á´ØÂ∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    
    <!-- ÂºÇÊ≠•Âä†ËΩΩÂ§ñÈÉ®Â∫ìÔºåÈÅøÂÖçÈòªÂ°ûÈ°µÈù¢Ê∏≤Êüì -->
    <script async src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" 
            onerror="this.src='https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'"></script>
    <script async src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"
            onerror="this.src='https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js'"></script>
    <script>
        // Â§áÁî®ÁöÑhtml2canvasÂä†ËΩΩÊñπÊ°à
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof html2canvas === 'undefined') {
                    console.warn('‰∏ªË¶Åhtml2canvasÂ∫ìÂä†ËΩΩÂ§±Ë¥•ÔºåÂ∞ùËØïÂ§áÁî®CDN...');
                    
                    // Â∞ùËØïÂ§áÁî®CDN
                    const backupScript = document.createElement('script');
                    backupScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    backupScript.async = true;
                    backupScript.onload = function() {
                        console.log('‚úÖ html2canvasÂ∫ìÈÄöËøáÂ§áÁî®CDNÂä†ËΩΩÊàêÂäü');
                    };
                    backupScript.onerror = function() {
                        console.error('‚ùå ÊâÄÊúâhtml2canvas CDNÂùáÂä†ËΩΩÂ§±Ë¥•');
                        // ÊúÄÂêéÁöÑÂ§áÁî®ÊñπÊ°à
                        const finalScript = document.createElement('script');
                        finalScript.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
                        finalScript.async = true;
                        finalScript.onload = function() {
                            console.log('‚úÖ html2canvasÂ∫ìÈÄöËøáÂÆòÊñπCDNÂä†ËΩΩÊàêÂäü');
                        };
                        document.head.appendChild(finalScript);
                    };
                    document.head.appendChild(backupScript);
                }
            }, 2000);
        });
    </script>
    <script async src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"
            onerror="this.src='https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'"></script>
    <style>
        /* ÊÄßËÉΩ‰ºòÂåñÔºöÂÖ≥ÈîÆCSSÂÜÖËÅîÔºåÂéãÁº©Ê†ºÂºè */
        *{margin:0;padding:0;box-sizing:border-box}
        body{font:16px/1.4 'Microsoft YaHei',sans-serif;background:linear-gradient(135deg,#f8f9fa,#ffffff);min-height:100vh;padding:20px;-webkit-font-smoothing:antialiased}
        .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden;will-change:transform}
        .header{background:linear-gradient(135deg,#ff4757,#ff3742);color:#fff;padding:30px;text-align:center;position:relative}
        .header h1{font-size:2.5em;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
        .header p{font-size:1.2em;opacity:.9}

        /* ËÆ§ËØÅÁïåÈù¢Ê†∑Âºè */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .auth-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: authAppear 0.5s ease-out;
        }

        @keyframes authAppear {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: #333;
            margin-bottom: 8px;
            font-size: 24px;
        }

        .auth-header p {
            color: #666;
            font-size: 14px;
        }

        .auth-form .form-group {
            margin-bottom: 20px;
        }

        .auth-form label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .auth-form input,
        .auth-form select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .auth-form input:focus,
        .auth-form select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-switch {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin: 0;
        }

        .auth-switch a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .auth-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
            display: none;
        }

        .auth-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .auth-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .user-status {
            position: absolute;
            top: 15px;
            right: 20px;
            background: linear-gradient(135deg, #ff4757, #ff3742);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .sync-btn {
            background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 8px;
        }

        .sync-btn:hover {
            background: linear-gradient(135deg, #30d158 0%, #32d760 100%);
            transform: translateY(-1px);
        }

        .sync-btn:active {
            transform: rotate(180deg);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        /* ÂñúÊä•ÂºπÁ™óÊ†∑Âºè - ËãπÊûúÈ£éÊ†ºÈáçÊñ∞ËÆæËÆ° */
        .celebration-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            animation: modalBackdropFadeIn 0.3s ease-out;
        }

        @keyframes modalBackdropFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .celebration-content {
            position: relative;
            background: 
                linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin: 2vh auto;
            padding: 0;
            border-radius: 28px;
            width: 90vw;
            max-width: 360px;
            height: auto;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 
                0 24px 48px rgba(0, 0, 0, 0.15),
                0 12px 24px rgba(0, 0, 0, 0.08),
                0 6px 12px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.08);
            animation: celebrationAppear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            will-change: transform, opacity;
        }

        @keyframes celebrationAppear {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .celebration-header {
            background: linear-gradient(135deg, #ff0022 0%, #fa5a5a 100%);
            color: white;
            padding: 24px 20px 28px;
            text-align: center;
            position: relative;
            overflow: hidden;
            height: auto;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            border-radius: 28px 28px 0 0;
        }

        .celebration-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.15) 0%, transparent 60%),
                radial-gradient(circle at 70% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .celebration-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            font-weight: 600;
            width: 32px;
            height: 32px;
            border-radius: 16px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .celebration-close:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }

        .celebration-copy {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
            font-weight: 600;
            width: 32px;
            height: 32px;
            border-radius: 16px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .celebration-copy:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }

        .celebration-copy:active {
            transform: scale(0.95);
        }

        .celebration-close:active {
            transform: scale(0.95);
        }

        .celebration-main-title {
            font-size: 32px;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            margin: 0 0 8px 0;
            z-index: 3;
            position: relative;
            letter-spacing: -0.5px;
            line-height: 1.1;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
        }

        .celebration-trophy {
            font-size: 22px;
            margin: 0 0 8px 0;
            z-index: 3;
            position: relative;
            animation: trophyFloat 3s ease-in-out infinite;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.1));
        }

        @keyframes trophyFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-6px); }
        }

        .celebration-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 10px 0;
            z-index: 2;
            position: relative;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            line-height: 1.3;
            opacity: 0.9;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
        }

        .celebration-motto {
            font-size: 13px;
            font-weight: 500;
            color: white;
            margin: 0;
            z-index: 2;
            position: relative;
            letter-spacing: 0.3px;
            padding: 8px 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
        }

        .celebration-body {
            padding: 16px;
            background: rgba(255, 255, 255, 0.95);
            color: #1d1d1f;
            flex: 0;
            overflow: visible;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-radius: 0 0 28px 28px;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
        }

        .celebration-body::-webkit-scrollbar {
            display: none;
        }

        .celebration-time {
            text-align: center;
            font-size: 13px;
            color: #8e8e93;
            margin: 0;
            padding: 10px 16px;
            background: rgba(142, 142, 147, 0.08);
            border-radius: 12px;
            border: 1px solid rgba(142, 142, 147, 0.12);
            flex-shrink: 0;
            font-weight: 500;
        }

        .celebration-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* ‰∏ªË¶Å‰ø°ÊÅØÂå∫Âüü - ËãπÊûúÈ£éÊ†º */
        .celebration-main-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 0;
        }

        .celebration-highlight-amount {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f94141 0%, #f54c4c 100%);
            border-radius: 16px;
            color: white;
            box-shadow: 0 8px 24px rgba(52, 199, 89, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .amount-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .amount-value {
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            letter-spacing: -0.5px;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
        }

        .celebration-key-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .key-info-item {
            text-align: center;
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .key-label {
            display: block;
            font-size: 11px;
            color: #8e8e93;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .key-value {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #1d1d1f;
            word-break: break-all;
            line-height: 1.2;
        }

        /* ÂûÇÁõ¥Â∏ÉÂ±Ä - ËãπÊûúÈ£éÊ†º */
        .celebration-three-columns {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 0;
        }

        .celebration-column {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 1px 8px rgba(0, 0, 0, 0.04);
        }

        .column-title {
            font-size: 12px;
            font-weight: 600;
            color: #007AFF;
            margin: 0 0 6px 0;
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
        }

        /* Ëø∑‰Ω†‰ø°ÊÅØÁΩëÊ†º - ËãπÊûúÈ£éÊ†º */
        .mini-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
        }

        .mini-info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 4px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.04);
            text-align: center;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.02);
        }

        .mini-label {
            font-size: 10px;
            color: #8e8e93;
            font-weight: 500;
            margin-bottom: 3px;
        }

        .mini-value {
            font-size: 11px;
            font-weight: 600;
            color: #1d1d1f;
            word-break: break-all;
            line-height: 1.1;
        }

        /* ÁªüËÆ°È´ò‰∫ÆÂå∫Âüü - ËãπÊûúÈ£éÊ†º */
        .stats-highlight {
            display: flex;
            align-items: stretch;
            gap: 12px;
        }

        .stat-big {
            flex: 1;
            padding: 16px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .stat-number {
            font-size: 20px;
            font-weight: 700;
            color: #007AFF;
            margin-bottom: 4px;
            word-break: break-all;
            line-height: 1.1;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
        }

        .stat-desc {
            font-size: 11px;
            color: #8e8e93;
            font-weight: 500;
        }

        .stat-small-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 80px;
        }

        .stat-small {
            padding: 8px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.02);
        }

        /* ÁÆÄÂåñÁªüËÆ°Â∏ÉÂ±Ä - ‰∏§ÂàóÊ®™Âêë */
        .stats-simple {
            display: flex;
            gap: 6px;
        }

        .stat-item {
            flex: 1;
            padding: 8px 6px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
        }

        .stat-item .stat-number {
            font-size: 15px;
            font-weight: 700;
            color: #007AFF;
            margin-bottom: 2px;
            word-break: break-all;
            line-height: 1.1;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
        }

        .stat-item .stat-desc {
            font-size: 10px;
            color: #8e8e93;
            font-weight: 500;
        }

        /* Ê®™Âêë‰∏öÁª©Âç°ÁâáÂ∏ÉÂ±Ä */
        .performance-cards {
            display: flex;
            gap: 8px;
            flex: 0;
        }

        .performance-card {
            flex: 1;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        }

        .card-title {
            font-size: 12px;
            font-weight: 600;
            color: #007AFF;
            margin: 0 0 8px 0;
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
        }

        .card-stats {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .card-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.02);
        }

        .card-stat-number {
            font-size: 14px;
            font-weight: 700;
            color: #007AFF;
            margin-bottom: 2px;
            word-break: break-all;
            line-height: 1.1;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
        }

        .card-stat-desc {
            font-size: 10px;
            color: #8e8e93;
            font-weight: 500;
        }

        /* 9:16 ÂºπÁ™óÂìçÂ∫îÂºèÊ†∑Âºè */
        @media (max-width: 400px) {
            .celebration-content {
                width: 95vw;
                max-width: 340px;
                margin: 1vh auto;
            }
            
            .celebration-header {
                padding: 20px 20px 24px;
                min-height: 110px;
            }
            
            .celebration-main-title {
                font-size: 28px;
                letter-spacing: -0.3px;
            }
            
            .celebration-body {
                padding: 14px;
                gap: 10px;
            }
            
            .amount-value {
                font-size: 22px;
            }
            
            .mini-info-item {
                padding: 5px 3px;
            }
            
            .mini-label {
                font-size: 9px;
            }
            
            .mini-value {
                font-size: 10px;
            }
            
            .stat-item {
                padding: 7px 5px;
            }
            
            .stat-item .stat-number {
                font-size: 13px;
            }
            
            .stat-item .stat-desc {
                font-size: 9px;
            }
            
            .performance-cards {
                gap: 6px;
            }
            
            .performance-card {
                padding: 8px;
            }
            
            .card-title {
                font-size: 11px;
                margin-bottom: 6px;
            }
            
            .card-stats {
                gap: 4px;
            }
            
            .card-stat-item {
                padding: 4px;
            }
            
            .card-stat-number {
                font-size: 12px;
            }
            
            .card-stat-desc {
                font-size: 9px;
            }
        }

        @media (max-height: 700px) {
            .celebration-content {
                max-height: 85vh;
                margin: 1vh auto;
            }
            
            .celebration-header {
                min-height: 100px;
                padding: 18px 20px 22px;
            }
            
            .celebration-main-title {
                font-size: 28px;
            }
            
            .celebration-body {
                padding: 14px;
                gap: 10px;
            }
            
            .stat-item {
                padding: 6px 4px;
            }
            
            .stat-item .stat-number {
                font-size: 12px;
            }
            
            .stat-item .stat-desc {
                font-size: 9px;
            }
            
            .performance-card {
                padding: 10px;
            }
            
            .card-stat-item {
                padding: 5px;
            }
            
            .card-stat-number {
                font-size: 11px;
            }
            
            .card-stat-desc {
                font-size: 8px;
            }
        }

        @media (max-height: 600px) {
            .celebration-content {
                max-height: 80vh;
                margin: 1vh auto;
            }
            
            .celebration-header {
                min-height: 90px;
                padding: 16px 20px 20px;
            }
            
            .celebration-main-title {
                font-size: 26px;
            }
            
            .celebration-body {
                padding: 12px;
                gap: 8px;
            }
            
            .stat-item {
                padding: 5px 3px;
            }
            
            .stat-item .stat-number {
                font-size: 11px;
            }
            
            .stat-item .stat-desc {
                font-size: 8px;
            }
            
            .performance-card {
                padding: 8px;
            }
            
            .card-stats {
                gap: 3px;
            }
            
            .card-stat-item {
                padding: 3px;
            }
            
            .card-stat-number {
                font-size: 10px;
            }
            
            .card-stat-desc {
                font-size: 7px;
            }
        }

        .stat-small-num {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #34c759;
            word-break: break-all;
            line-height: 1.1;
            margin-bottom: 2px;
        }

        .stat-small-desc {
            display: block;
            font-size: 10px;
            color: #8e8e93;
            font-weight: 500;
        }

        /* Â§áÊ≥®‰ø°ÊÅØ - ËãπÊûúÈ£éÊ†º */
        .celebration-remarks {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 204, 0, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(255, 204, 0, 0.2);
            margin: 0;
        }

        .remarks-label {
            font-size: 14px;
            flex-shrink: 0;
        }

        .remarks-text {
            font-size: 12px;
            color: #1d1d1f;
            line-height: 1.3;
            word-break: break-all;
            font-weight: 500;
        }

        /* ÁßªÂä®Á´Ø‰ºòÂåñ - ËãπÊûúÈ£éÊ†º */
        @media (max-width: 480px) {
            .celebration-header {
                min-height: 100px;
                padding: 16px 20px 20px;
                border-radius: 20px 20px 0 0;
            }
            
            .celebration-main-title {
                font-size: 28px;
                letter-spacing: -0.3px;
            }
            
            .celebration-trophy {
                font-size: 24px;
                margin: 0 0 8px 0;
            }
            
            .celebration-title {
                font-size: 13px;
            }
            
            .celebration-motto {
                font-size: 11px;
                padding: 5px 12px;
            }
            
            .celebration-body {
                padding: 20px;
                gap: 12px;
                border-radius: 0 0 20px 20px;
            }
            
            .celebration-close {
                width: 28px;
                height: 28px;
                font-size: 14px;
                top: 14px;
                right: 14px;
                border-radius: 14px;
            }

            .celebration-key-info {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .key-info-item {
                padding: 10px 6px;
            }

            .amount-value {
                font-size: 24px;
            }

            .stat-number {
                font-size: 18px;
            }
            
            .performance-cards {
                gap: 6px;
            }
            
            .performance-card {
                padding: 8px;
            }
            
            .card-title {
                font-size: 10px;
                margin-bottom: 4px;
            }
            
            .card-stats {
                gap: 3px;
            }
            
            .card-stat-item {
                padding: 3px;
            }
            
            .card-stat-number {
                font-size: 11px;
            }
            
            .card-stat-desc {
                font-size: 8px;
            }
        }

        /* ÊÄßËÉΩ‰ºòÂåñ */
        .celebration-modal * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ÊªöÂä®Êù°ÁæéÂåñ - ËãπÊûúÈ£éÊ†º */
        .celebration-body::-webkit-scrollbar {
            width: 4px;
        }

        .celebration-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .celebration-body::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
        }

        .celebration-body::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        .celebration-footer {
            padding: 8px 15px;
            text-align: center;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            flex-shrink: 0;
        }

        .celebration-close {
            background: linear-gradient(135deg, #FF6B6B, #FF4757);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .celebration-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .celebration-fireworks {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            animation: fireworks 2s infinite;
        }

        @keyframes fireworks {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }



        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 100%;
            overflow: hidden;
        }

        .left-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            width: 350px;
            max-width: 350px;
        }

        .right-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            min-width: 0;
            overflow: hidden;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px 10px 0;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        /* ÂÖ∂‰ªñÂú∞Êñπ‰ΩøÁî®ÁöÑÊ¨°Ë¶ÅÊåâÈíÆÊ†∑Âºè */
        .btn.btn-secondary:not(.action-buttons .btn-secondary) {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }

        .statistics {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #ff4757;
        }

        .statistics h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: bold;
            color: #666;
        }

        .stat-value {
            color: #ff4757;
            font-weight: bold;
        }

        .table-container {
            background: white;
            border-radius: 0 0 10px 10px;
            overflow-x: auto;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-height: 600px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
            table-layout: fixed;
        }

        th {
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            font-size: 14px;
        }

        /* ËÆæÁΩÆÂêÑÂàóÁöÑÂõ∫ÂÆöÂÆΩÂ∫¶ */
        th:nth-child(1), td:nth-child(1) { width: 90px; }  /* Êî∂Ê¨æÊó•Êúü */
        th:nth-child(2), td:nth-child(2) { width: 70px; }  /* ÂÆ¢Êà∑Âêç */
        th:nth-child(3), td:nth-child(3) { width: 80px; }  /* ÂÆ¢Êà∑Êù•Ê∫ê */
        th:nth-child(4), td:nth-child(4) { width: 80px; }  /* ‰∏öÂä°Á±ªÂûã */
        th:nth-child(5), td:nth-child(5) { width: 90px; }  /* Êî∂ÂÖ•ÈáëÈ¢ù */
        th:nth-child(6), td:nth-child(6) { width: 70px; }  /* Êî∂ÂÖ•Á±ªÂûã */
        th:nth-child(7), td:nth-child(7) { width: 70px; }  /* ÈîÄÂîÆ‰∫∫Âëò */
        th:nth-child(8), td:nth-child(8) { width: 90px; }  /* ÂêàÂêåÈáëÈ¢ù */
        th:nth-child(9), td:nth-child(9) { width: 100px; } /* Â§áÊ≥® */
        th:nth-child(10), td:nth-child(10) { width: 60px; } /* Êìç‰Ωú */

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 13px;
            vertical-align: middle;
        }

        /* Â§áÊ≥®ÂàóÁâπÊÆäÂ§ÑÁêÜ - Èº†Ê†áÊÇ¨ÂÅúÊòæÁ§∫ÂÆåÊï¥ÂÜÖÂÆπ */
        td:nth-child(9) {
            position: relative;
            cursor: pointer;
        }

        td:nth-child(9):hover {
            overflow: visible;
            white-space: normal;
            background: #fff3cd;
            z-index: 5;
            border: 1px solid #ffc107;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            max-width: 200px;
            min-width: 120px;
        }

        /* Âà†Èô§ÊåâÈíÆÊ†∑Âºè‰ºòÂåñ */
        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #d32f2f;
            transform: scale(1.05);
        }

        /* Ë°®Ê†ºÂ∑•ÂÖ∑Ê†èÊ†∑Âºè */
        .table-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #e9ecef;
            gap: 15px;
        }

        .table-info {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            background: #ff4757;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-small:hover {
            background: #ff3742;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* ÊêúÁ¥¢ÂäüËÉΩÊ†∑Âºè */
        .table-search {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #customerSearchInput {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 180px;
            outline: none;
            transition: all 0.3s ease;
        }

        #customerSearchInput:focus {
            border-color: #ff4757;
            box-shadow: 0 0 0 2px rgba(255, 71, 87, 0.2);
        }

        .search-btn {
            background: #4CAF50 !important;
        }

        .search-btn:hover {
            background: #45a049 !important;
        }

        .clear-search-btn {
            background: #666 !important;
        }

        .clear-search-btn:hover {
            background: #555 !important;
        }

        /* ÊêúÁ¥¢È´ò‰∫ÆÊ†∑Âºè */
        .search-highlight {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }

        .search-no-results {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 768px) {
            .table-toolbar {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }

            .table-search {
                justify-content: center;
            }

            #customerSearchInput {
                width: 200px;
            }

            .table-info {
                text-align: center;
            }
        }

        /* ÂÆ¢Êà∑Êù•Ê∫êÁªüËÆ°ÂàÜÊûêÊ†∑Âºè */
        .customer-source-analysis {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            padding: 10px;
        }

        .source-stat-card {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .source-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff4757, #ff6b7a);
        }

        .source-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .source-icon {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .source-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .source-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .source-percentage {
            font-size: 10px;
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
        }

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 1200px) {
            .customer-source-analysis {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
        }

        @media (max-width: 768px) {
            .customer-source-analysis {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .source-stat-card {
                padding: 12px;
            }
            
            .source-number {
                font-size: 20px;
            }
        }

        /* Êú™Êî∂Ê¨æÁªüËÆ°Ê†∑Âºè */
        .unpaid-stats {
            max-height: 300px;
            overflow-y: auto;
        }

        .unpaid-summary {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .unpaid-total {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .unpaid-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .unpaid-detail {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 4px solid #FF9800;
        }

        .unpaid-customer {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .unpaid-amounts {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .contract-amount {
            color: #666;
        }

        .received-amount {
            color: #4CAF50;
        }

        .unpaid-amount {
            color: #FF9800;
            font-weight: bold;
        }



        tr:hover td {
            background-color: #f5f5f5;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .daily-summary {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .daily-summary h3 {
            margin-bottom: 15px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: #f8f9fa;
            color: #666;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
            color: white;
        }

        .tab.protected-tab {
            position: relative;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 3px solid #ff4757;
        }

        .tab.protected-tab:hover {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(255, 71, 87, 0.3);
        }

        .tab.protected-tab.active {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            color: white;
            border-left: 3px solid #ff3742;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .export-section {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
        }

        /* ÁªüËÆ°ÁΩëÊ†ºÊ†∑Âºè */
        .statistics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 300px 1fr;
                gap: 15px;
                padding: 15px;
            }
            
            .left-panel {
                width: 300px;
                max-width: 300px;
                padding: 15px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 10px;
            }
            
            .left-panel {
                width: 100%;
                max-width: 100%;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            table {
                font-size: 12px;
                min-width: 750px;
            }
            
            th {
                padding: 8px 4px;
                font-size: 12px;
            }
            
            td {
                padding: 8px 4px;
                font-size: 11px;
            }
            
            /* ÁßªÂä®Á´ØÂêÑÂàóÂÆΩÂ∫¶Ë∞ÉÊï¥ */
            th:nth-child(1), td:nth-child(1) { width: 75px; }
            th:nth-child(2), td:nth-child(2) { width: 60px; }
            th:nth-child(3), td:nth-child(3) { width: 70px; }
            th:nth-child(4), td:nth-child(4) { width: 70px; }
            th:nth-child(5), td:nth-child(5) { width: 80px; }
            th:nth-child(6), td:nth-child(6) { width: 60px; }
            th:nth-child(7), td:nth-child(7) { width: 60px; }
            th:nth-child(8), td:nth-child(8) { width: 80px; }
            th:nth-child(9), td:nth-child(9) { width: 85px; }
            th:nth-child(10), td:nth-child(10) { width: 50px; }
            
            .statistics-grid {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }
        }

        .highlight {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .settings-item {
            background: white;
            padding: 15px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #ff4757;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .settings-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        .settings-item-content {
            flex: 1;
            font-weight: 500;
            color: #333;
        }

        .settings-item-actions {
            display: flex;
            gap: 8px;
        }

        .settings-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .settings-section h3 {
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ff4757;
            color: #333;
            font-size: 1.2em;
        }

        .add-form {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .add-form input, .add-form select {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .add-form button {
            white-space: nowrap;
            padding: 10px 20px;
            font-size: 14px;
        }

        .items-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-style: italic;
        }

        .item-index {
            background: #e9ecef;
            color: #666;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 10px;
            min-width: 24px;
            text-align: center;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .ladder-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ladder-item input {
            width: 100px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            margin: 0 2px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 130px;
            margin: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 15px;
        }

        /* ‰∏ªË¶ÅÊåâÈíÆ - Á∫¢Ëâ≤Ê∏êÂèòÔºåÊúÄÈáçË¶Å */
        .btn-primary {
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
        }

        /* Ê¨°Ë¶ÅÊåâÈíÆ - ‰∏≠Á≠âËâ≤Ë∞É */
        .btn-secondary {
            background: linear-gradient(135deg, #81C784 0%, #66BB6A 100%);
            color: white;
            font-weight: 500;
            box-shadow: 0 3px 8px rgba(129, 199, 132, 0.25);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(129, 199, 132, 0.35);
        }

        /* Á¨¨‰∏âÁ∫ßÊåâÈíÆ - ÊúÄÊµÖËâ≤Ë∞É */
        .btn-tertiary {
            background: linear-gradient(135deg, #A5D6A7 0%, #8BC34A 100%);
            color: #2E7D32;
            font-weight: normal;
            box-shadow: 0 2px 6px rgba(165, 214, 167, 0.2);
        }

        .btn-tertiary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(165, 214, 167, 0.3);
            background: linear-gradient(135deg, #8BC34A 0%, #7CB342 100%);
            color: white;
        }

        /* ÂØºÂá∫ÊåâÈíÆÊ†∑Âºè */
        .export-buttons .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 14px;
            padding: 12px 16px;
        }

        /* ÁªüËÆ°ÂàÜÊûêÊ®°ÂùóÊ†∑Âºè */
        .analytics-dashboard {
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.3);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .dashboard-header h3 {
            margin: 0;
            font-size: 1.4em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .time-selector select {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
        }

        .time-selector select option {
            background: #333;
            color: white;
        }

        /* KPI Âç°ÁâáÁΩëÊ†º */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        @media (max-width: 900px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        .kpi-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            background: rgba(255,255,255,0.2);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .kpi-icon {
            font-size: 2.5em;
            opacity: 0.9;
        }

        .kpi-content {
            flex: 1;
        }

        .kpi-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .kpi-change {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            background: rgba(76, 175, 80, 0.3);
            display: inline-block;
        }

        .kpi-change.negative {
            background: rgba(244, 67, 54, 0.3);
        }

        /* ÂàÜÊûêÁü©Èòµ */
        .analytics-matrix {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ÂõæË°®ÁΩëÊ†ºÂ∏ÉÂ±Ä */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .chart-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .chart-card.wide {
            grid-column: span 2;
        }

        .chart-header {
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .chart-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
        }

        .chart-header h4 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .chart-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .chart-body {
            padding: 20px;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .analysis-row {
            width: 100%;
        }

        .analysis-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .analysis-card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .analysis-card.insight {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .card-header {
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .analysis-card.insight .card-header {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }

        .card-icon {
            font-size: 1.2em;
            margin-right: 10px;
        }

        .card-header h4 {
            margin: 0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }

        .card-toggle {
            cursor: pointer;
            font-size: 1.5em;
            font-weight: bold;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .card-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .card-content {
            padding: 20px;
            transition: all 0.3s ease;
        }

        .card-content.collapsed {
            display: none;
        }

        /* Ë∂ãÂäøÂàÜÊûêÁΩëÊ†º */
        .trend-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .trend-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .trend-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .trend-chart {
            min-height: 120px;
        }

        /* ‰∏öÂä°ÁªìÊûÑÁΩëÊ†º */
        .business-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .business-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .business-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
            font-size: 14px;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 2px solid #ff4757;
        }

        .business-stats {
            max-height: 200px;
            overflow-y: auto;
        }

        /* Âõ¢ÈòüÂàÜÊûê */
        .team-summary {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #ff4757;
        }

        .team-ranking {
            display: grid;
            gap: 10px;
        }

        .team-member {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .team-member:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .member-rank {
            background: #ff4757;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .member-info {
            flex: 1;
            margin-left: 12px;
        }

        .member-name {
            font-weight: bold;
            color: #333;
        }

        .member-performance {
            font-size: 12px;
            color: #666;
        }

        .member-amount {
            font-weight: bold;
            color: #ff4757;
            font-size: 16px;
        }

        /* ÂÆ¢Êà∑ÂàÜÊûêÁΩëÊ†º */
        .customer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .customer-metrics, .customer-segments, .top-customers {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        /* Êô∫ËÉΩÊ¥ûÂØü */
        .insights-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .insight-item {
            background: linear-gradient(90deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 4px solid #f39c12;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .insight-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .insight-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #f39c12, #e67e22);
        }

        .insight-icon {
            font-size: 1.2em;
            margin-right: 8px;
        }

        .insight-text {
            font-size: 14px;
            line-height: 1.4;
            color: #333;
        }

        /* Á¥ßÂáëÁöÑÁªüËÆ°È°π */
        .stat-item-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 3px 0;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
            transition: all 0.3s ease;
        }

        .stat-item-compact:hover {
            background: #f0f8f0;
            transform: scale(1.02);
        }

        .stat-label-compact {
            font-size: 13px;
            color: #555;
            font-weight: 500;
        }

        .stat-value-compact {
            font-size: 13px;
            color: #4CAF50;
            font-weight: bold;
        }

        .stat-percentage {
            font-size: 11px;
            color: #666;
            margin-left: 5px;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                flex: none;
                min-width: 100%;
                margin-bottom: 8px;
            }
            
            .export-buttons {
                grid-template-columns: 1fr !important;
            }

            .kpi-grid {
                grid-template-columns: 1fr 1fr;
            }

            .trend-grid {
                grid-template-columns: 1fr;
            }

            .business-grid {
                grid-template-columns: 1fr;
            }

            .customer-grid {
                grid-template-columns: 1fr;
            }

            .kpi-card {
                padding: 15px;
            }

            .kpi-icon {
                font-size: 2em;
            }

            .kpi-value {
                font-size: 1.4em;
            }
        }

        @media (max-width: 480px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .analytics-dashboard {
                padding: 15px;
            }

            .card-content {
                padding: 15px;
            }
        }
        
        /* Êñ∞Â¢ûÊ†∑Âºè */
        .insight-item {
            display: flex;
            align-items: flex-start;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #28a745;
            transition: all 0.2s ease;
        }
        
        .insight-item:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            transform: translateX(3px);
        }
        
        .insight-icon {
            font-size: 16px;
            margin-right: 10px;
            margin-top: 1px;
            flex-shrink: 0;
        }
        
        .insight-text {
            flex: 1;
            font-size: 13px;
            line-height: 1.4;
            color: #495057;
        }
        
        .team-member {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        
        .team-member:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }
        
        .member-rank {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            margin-right: 12px;
        }
        
        .member-info {
            flex: 1;
        }
        
        .member-name {
            font-weight: 600;
            color: #343a40;
            font-size: 14px;
        }
        
        .member-performance {
            font-size: 11px;
            color: #6c757d;
            margin-top: 2px;
        }
        
        .member-amount {
            font-weight: 600;
            color: #28a745;
            font-size: 14px;
        }
        
        /* ÂõæË°®ÂÆπÂô®Ê†∑Âºè */
        .chart-container {
            position: relative;
        }
        
        .chart-container.wide {
            grid-column: span 2;
        }
        
        /* È•ºÂõæÊ†∑Âºè */
        .pie-chart {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            position: relative;
            margin: 0 auto 15px;
            background: conic-gradient(from 0deg, #FF6B6B, #4ECDC4, #45B7D1, #96CEB4, #FFEAA7, #DDA0DD);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: rotate(-90deg);
        }
        
        .chart-legend.compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 6px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 11px;
            padding: 4px 6px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .legend-item:hover {
            background: #e9ecef;
            transform: scale(1.02);
        }
        
        .legend-color {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
            flex-shrink: 0;
        }
        
        .legend-label {
            flex: 1;
            font-weight: 500;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .legend-value {
            font-weight: 600;
            color: #4CAF50;
            font-size: 10px;
        }
        
        /* ÁéØÂΩ¢ÂõæÊ†∑Âºè */
        .donut-chart-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .donut-chart {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            position: relative;
            background: conic-gradient(from 0deg, 
                #FF6B6B 0deg 72deg,
                #4ECDC4 72deg 144deg,
                #45B7D1 144deg 216deg,
                #96CEB4 216deg 288deg,
                #FFEAA7 288deg 360deg
            );
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: rotate(-90deg);
        }
        
        .donut-chart::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 50%;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(90deg);
            text-align: center;
            z-index: 2;
        }
        
        .center-value {
            font-size: 16px;
            font-weight: 700;
            color: #4CAF50;
            margin-bottom: 2px;
        }
        
        .center-label {
            font-size: 10px;
            color: #666;
            font-weight: 500;
        }
        
        /* ‰∏öÁª©ÊéíÂêçÊ†∑Âºè */
        .performance-ranking {
            padding: 10px 0;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #ddd;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .ranking-item:hover {
            background: #f0f7ff;
            transform: translateX(2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .ranking-item:nth-child(1) {
            border-left-color: #ff4757;
            background: linear-gradient(135deg, #fff5f5, #f8f9fa);
        }
        
        .ranking-item:nth-child(2) {
            border-left-color: #45B7D1;
            background: linear-gradient(135deg, #f0f8ff, #f8f9fa);
        }
        
        .ranking-item:nth-child(3) {
            border-left-color: #4ECDC4;
            background: linear-gradient(135deg, #f0fffe, #f8f9fa);
        }
        
        .ranking-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff4757, #ff3742);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .ranking-item:nth-child(2) .ranking-number {
            background: linear-gradient(135deg, #45B7D1, #2196F3);
        }
        
        .ranking-item:nth-child(3) .ranking-number {
            background: linear-gradient(135deg, #4ECDC4, #26A69A);
        }
        
        .ranking-item:nth-child(n+4) .ranking-number {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }
        
        .ranking-info {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        
        .ranking-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
            min-width: 60px;
        }
        
        .ranking-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .ranking-amount {
            font-weight: bold;
            color: #ff4757;
            font-size: 16px;
        }
        
        .ranking-count {
            color: #666;
            font-size: 14px;
            background: rgba(255,71,87,0.1);
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .ranking-empty {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 14px;
        }
        
        /* Èò∂Ê¢ØÂõæÊ†∑Âºè */
        .step-chart {
            height: 130px;
            display: flex;
            align-items: end;
            gap: 3px;
            padding: 10px;
            justify-content: center;
        }
        
        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 25px;
        }
        
        .step-bar {
            width: 100%;
            background: linear-gradient(to top, #FF9800, #FFC107);
            border-radius: 2px 2px 0 0;
            position: relative;
            transition: all 0.3s ease;
            min-height: 10px;
            box-shadow: 0 2px 6px rgba(255, 152, 0, 0.3);
        }
        
        .step-bar:nth-child(odd) {
            background: linear-gradient(to top, #2196F3, #64B5F6);
            box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
        }
        
        .step-bar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(255, 152, 0, 0.4);
        }
        
        .step-label {
            margin-top: 4px;
            font-size: 9px;
            color: #666;
            text-align: center;
            font-weight: 500;
            max-width: 30px;
            line-height: 1.1;
        }
        
        /* Ê†ëÁä∂ÂõæÊ†∑Âºè */
        .treemap-container {
            padding: 10px;
        }
        
        .treemap-chart {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 4px;
            height: 180px;
        }
        
        .treemap-item {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .treemap-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .treemap-item:nth-child(2) { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .treemap-item:nth-child(3) { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .treemap-item:nth-child(4) { background: linear-gradient(135deg, #a8edea, #fed6e3); }
        .treemap-item:nth-child(5) { background: linear-gradient(135deg, #ff9a9e, #fecfef); }
        
        .treemap-label {
            font-size: 10px;
            margin-bottom: 2px;
        }
        
        .treemap-value {
            font-size: 12px;
            font-weight: bold;
        }
        
        

        
        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 15px;
            }
            
            .chart-card.wide {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .chart-body {
                padding: 15px;
                min-height: 140px;
            }
            
            .chart-header {
                padding: 12px 16px;
            }
            
            .chart-header h4 {
                font-size: 14px;
            }
            
            .pie-chart, .donut-chart {
                width: 120px;
            }
            
            /* ÁßªÂä®Á´Ø‰∏öÁª©ÊéíÂêçÊ†∑Âºè */
            .ranking-item {
                padding: 10px 12px;
                margin-bottom: 6px;
            }
            
            .ranking-number {
                width: 26px;
                height: 26px;
                font-size: 12px;
                margin-right: 12px;
            }
            
            .ranking-info {
                gap: 10px;
                flex-direction: column;
                align-items: flex-start;
            }
            
            .ranking-name {
                font-size: 14px;
                min-width: auto;
            }
            
            .ranking-stats {
                gap: 15px;
                width: 100%;
                justify-content: space-between;
            }
            
            .ranking-amount {
                font-size: 14px;
            }
            
            .ranking-count {
                font-size: 12px;
            }
            
            .pie-chart, .donut-chart {
                height: 120px;
            }
            
            .bar-chart {
                height: 120px;
                gap: 8px;
            }
            
            .step-chart {
                height: 100px;
            }
            
            .legend-item {
                font-size: 10px;
                padding: 3px 5px;
            }
        }
    </style>
</head>
<body>
    <!-- ÁôªÂΩïÊ®°ÊÄÅÊ°Ü -->
    <div id="authModal" class="auth-modal">
        <div class="auth-content">
            <div class="auth-header">
                <h2>üè¢ ÈîÄÂîÆÁÆ°ÁêÜÁ≥ªÁªü</h2>
                <p>ËØ∑ÁôªÂΩïÊÇ®ÁöÑË¥¶Êà∑</p>
            </div>
            
            <!-- ÁôªÂΩïË°®Âçï -->
            <div id="loginForm" class="auth-form">
                <div class="form-group">
                    <label for="loginEmail">ÈÇÆÁÆ±Âú∞ÂùÄ</label>
                    <input type="email" id="loginEmail" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">ÂØÜÁ†Å</label>
                    <input type="password" id="loginPassword" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" required>
                </div>
                <button type="button" onclick="handleLogin()" class="auth-btn">ÁôªÂΩï</button>
                <p class="auth-switch">
                    ËøòÊ≤°ÊúâË¥¶Êà∑Ôºü<a href="#" onclick="showRegisterForm()">Á´ãÂç≥Ê≥®ÂÜå</a>
                </p>
            </div>
            
            <!-- Ê≥®ÂÜåË°®Âçï -->
            <div id="registerForm" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label for="registerEmail">ÈÇÆÁÆ±Âú∞ÂùÄ</label>
                    <input type="email" id="registerEmail" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">ÂØÜÁ†Å</label>
                    <input type="password" id="registerPassword" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†ÅÔºàËá≥Â∞ë6‰ΩçÔºâ" required>
                </div>
                <div class="form-group">
                    <label for="registerName">ÂßìÂêç</label>
                    <input type="text" id="registerName" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂßìÂêç" required>
                </div>
                <div class="form-group">
                    <label for="registerRole">ËßíËâ≤</label>
                    <select id="registerRole" required>
                        <option value="sales">ÈîÄÂîÆ‰∫∫Âëò</option>
                        <option value="manager">ÈîÄÂîÆÁªèÁêÜ</option>
                        <option value="admin">ÁÆ°ÁêÜÂëò</option>
                    </select>
                </div>
                <button type="button" onclick="handleRegister()" class="auth-btn">Ê≥®ÂÜå</button>
                <p class="auth-switch">
                    Â∑≤ÊúâË¥¶Êà∑Ôºü<a href="#" onclick="showLoginForm()">Á´ãÂç≥ÁôªÂΩï</a>
                </p>
            </div>
            
            <div id="authMessage" class="auth-message"></div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <h1>üè¢ ÈîÄÂîÆËÆ∞ÂΩïÁÆ°ÁêÜÁ≥ªÁªü</h1>
            <p>‰∏ì‰∏öÁöÑÈîÄÂîÆÊï∞ÊçÆÁÆ°ÁêÜ‰∏éÁªüËÆ°ÂàÜÊûêÂπ≥Âè∞</p>
            <div class="user-status" id="userStatus">
                <span id="currentUser">Âä†ËΩΩ‰∏≠...</span>
                <button class="sync-btn" onclick="syncDataWithCloud()" title="ÂêåÊ≠•‰∫ëÁ´ØÊï∞ÊçÆ">üîÑ</button>
                <button class="logout-btn" onclick="handleLogout()">ÈÄÄÂá∫ÁôªÂΩï</button>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <h2>üìù ÂΩïÂÖ•ÈîÄÂîÆÊï∞ÊçÆ</h2>
                <form id="salesForm">
                    <div class="form-group">
                        <label for="date">Êî∂Ê¨æÊó•Êúü:</label>
                        <input type="date" id="date" required>
                    </div>

                    <div class="form-group">
                        <label for="customer">ÂÆ¢Êà∑Âêç:</label>
                        <input type="text" id="customer" placeholder="ËØ∑ËæìÂÖ•ÂÆ¢Êà∑ÂßìÂêç" required>
                    </div>

                    <div class="form-group">
                        <label for="customerSource">ÂÆ¢Êà∑Êù•Ê∫ê:</label>
                        <select id="customerSource" required>
                            <option value="">ËØ∑ÈÄâÊã©ÂÆ¢Êà∑Êù•Ê∫ê</option>
                            <!-- ÈÄâÈ°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="businessType">‰∏öÂä°Á±ªÂûã:</label>
                        <select id="businessType" required>
                            <option value="">ËØ∑ÈÄâÊã©‰∏öÂä°Á±ªÂûã</option>
                            <!-- ÈÄâÈ°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="amount">Êî∂ÂÖ•ÈáëÈ¢ù:</label>
                        <input type="number" id="amount" placeholder="ËØ∑ËæìÂÖ•ÈáëÈ¢ù" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label for="incomeType">Êî∂ÂÖ•Á±ªÂûã:</label>
                        <select id="incomeType" required>
                            <option value="">ËØ∑ÈÄâÊã©Êî∂ÂÖ•Á±ªÂûã</option>
                            <!-- ÈÄâÈ°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="salesperson">ÈîÄÂîÆ‰∫∫Âëò:</label>
                        <select id="salesperson" required>
                            <option value="">ËØ∑ÈÄâÊã©ÈîÄÂîÆ‰∫∫Âëò</option>
                            <!-- ÈÄâÈ°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="contractAmount">ÂêàÂêåÈáëÈ¢ù:</label>
                        <input type="number" id="contractAmount" placeholder="ËØ∑ËæìÂÖ•ÂêàÂêåÈáëÈ¢ù" step="0.01">
                    </div>

                    <div class="form-group">
                        <label for="remarks">Â§áÊ≥®:</label>
                        <input type="text" id="remarks" placeholder="ËØ∑ËæìÂÖ•Â§áÊ≥®‰ø°ÊÅØ">
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn btn-primary">
                            <span>‚ûï</span>
                            <span>Ê∑ªÂä†ËÆ∞ÂΩï</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="generateDailySummary()">
                            <span>üìä</span>
                            <span>ÁîüÊàêÊó•Êä•</span>
                        </button>
                        <button type="button" class="btn btn-tertiary" onclick="clearAllData()">
                            <span>üóëÔ∏è</span>
                            <span>Ê∏ÖÁ©∫Êï∞ÊçÆ</span>
                        </button>
                    </div>
                </form>

                <div class="daily-summary" id="dailySummary" style="display:none;">
                    <h3>üìà ‰ªäÊó•ÂÖ•Ë¥¶ÁªüËÆ°</h3>
                    <div id="summaryContent"></div>
                    <button class="btn" onclick="copyToClipboard()">
                        <span>üìã</span>
                        <span>Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø</span>
                    </button>
                </div>
            </div>

            <div class="right-panel">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('records')">üìã ÈîÄÂîÆËÆ∞ÂΩï</button>
                    <button class="tab protected-tab" onclick="showTab('statistics')">üìä ÁªüËÆ°ÂàÜÊûê üîí</button>
                    <button class="tab protected-tab" onclick="showTab('salary')">üí∞ Â∑•ËµÑËÆ°ÁÆó üîí</button>
                    <button class="tab protected-tab" onclick="showTab('settings')">‚öôÔ∏è Á≥ªÁªüËÆæÁΩÆ üîí</button>
                </div>

                <div id="records" class="tab-content active">
                    <div class="statistics">
                        <h3>üìà ÂÆûÊó∂ÁªüËÆ°</h3>
                        <div class="stat-item">
                            <span class="stat-label">‰ªäÊó•ÊÄªÂÖ•Ë¥¶:</span>
                            <span class="stat-value" id="todayTotal">¬•0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Êú¨ÊúàÊÄªÂÖ•Ë¥¶:</span>
                            <span class="stat-value" id="monthTotal">¬•0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ËÆ∞ÂΩïÊÄªÊï∞:</span>
                            <span class="stat-value" id="recordCount">0</span>
                        </div>
                    </div>

                    <!-- Ë°®Ê†ºÂ∑•ÂÖ∑Ê†è -->
                    <div class="table-toolbar">
                        <div class="table-info">
                            <span id="tableRecordCount">ÂÖ± 0 Êù°ËÆ∞ÂΩï</span>
                        </div>
                        <div class="table-search">
                            <input type="text" id="customerSearchInput" placeholder="ÊêúÁ¥¢ÂÆ¢Êà∑Âêç..." title="ËæìÂÖ•ÂÆ¢Êà∑ÂêçËøõË°åÊêúÁ¥¢">
                            <button class="btn-small search-btn" onclick="searchCustomer()" title="ÊêúÁ¥¢ÂÆ¢Êà∑">
                                üîç ÊêúÁ¥¢
                            </button>
                            <button class="btn-small clear-search-btn" onclick="clearSearch()" title="Ê∏ÖÈô§ÊêúÁ¥¢" style="display: none;">
                                ‚ùå Ê∏ÖÈô§
                            </button>
                        </div>

                    </div>

                    <div class="table-container">
                        <table id="salesTable">
                            <thead>
                                <tr>
                                    <th>Êî∂Ê¨æÊó•Êúü</th>
                                    <th>ÂÆ¢Êà∑Âêç</th>
                                    <th>ÂÆ¢Êà∑Êù•Ê∫ê</th>
                                    <th>‰∏öÂä°Á±ªÂûã</th>
                                    <th>Êî∂ÂÖ•ÈáëÈ¢ù</th>
                                    <th>Êî∂ÂÖ•Á±ªÂûã</th>
                                    <th>ÈîÄÂîÆ‰∫∫Âëò</th>
                                    <th>ÂêàÂêåÈáëÈ¢ù</th>
                                    <th>Â§áÊ≥®</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="statistics" class="tab-content">
                    <!-- Ê†∏ÂøÉÊåáÊ†á‰ª™Ë°®Êùø -->
                    <div class="analytics-dashboard">
                        <div class="dashboard-header">
                            <h3>üìä Ê†∏ÂøÉ‰∏öÁª©ÊåáÊ†á</h3>
                            <div class="time-selector">
                                <select id="analyticsPeriod" onchange="updateAnalyticsPeriod()">
                                    <option value="month">Êú¨Êúà</option>
                                    <option value="quarter">Êú¨Â≠£Â∫¶</option>
                                    <option value="year">Êú¨Âπ¥Â∫¶</option>
                                    <option value="all">ÂÖ®ÈÉ®</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ÂÖ≥ÈîÆÊåáÊ†áÂç°Áâá -->
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <div class="kpi-icon">üí∞</div>
                                <div class="kpi-content">
                                    <div class="kpi-label">ÊÄªÊî∂ÂÖ•</div>
                                    <div class="kpi-value" id="kpiTotalRevenue">¬•0</div>
                                    <div class="kpi-change" id="kpiRevenueChange">+0%</div>
                                </div>
                            </div>
                            
                            <div class="kpi-card">
                                <div class="kpi-icon">üìà</div>
                                <div class="kpi-content">
                                    <div class="kpi-label">Êàê‰∫§Á¨îÊï∞</div>
                                    <div class="kpi-value" id="kpiTotalDeals">0</div>
                                    <div class="kpi-change" id="kpiDealsChange">+0%</div>
                                </div>
                            </div>
                            
                            <div class="kpi-card">
                                <div class="kpi-icon">üë•</div>
                                <div class="kpi-content">
                                    <div class="kpi-label">Ê¥ªË∑ÉÈîÄÂîÆ</div>
                                    <div class="kpi-value" id="kpiActiveSales">0‰∫∫</div>
                                    <div class="kpi-change" id="kpiSalesChange">+0%</div>
                                </div>
                            </div>
                            
                            <div class="kpi-card">
                                <div class="kpi-icon">üéØ</div>
                                <div class="kpi-content">
                                    <div class="kpi-label">Á∫øÁ¥¢Êàê‰∫§</div>
                                    <div class="kpi-value" id="kpiLeadConversion">0Á¨î</div>
                                    <div class="kpi-change" id="kpiLeadChange">+0%</div>
                                </div>
                            </div>
                            
                            <div class="kpi-card">
                                <div class="kpi-icon">üí≥</div>
                                <div class="kpi-content">
                                    <div class="kpi-label">Ê¨†Ê¨æÊÄªÈáëÈ¢ù</div>
                                    <div class="kpi-value" id="kpiUnpaidAmount">¬•0</div>
                                    <div class="kpi-change" id="kpiUnpaidAmountChange">+0%</div>
                                </div>
                            </div>
                            
                            <div class="kpi-card">
                                <div class="kpi-icon">üìã</div>
                                <div class="kpi-content">
                                    <div class="kpi-label">Ê¨†Ê¨æÊï∞Èáè</div>
                                    <div class="kpi-value" id="kpiUnpaidCount">0Á¨î</div>
                                    <div class="kpi-change" id="kpiUnpaidCountChange">+0%</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÂàÜÊûêÊ®°ÂùóÁü©Èòµ -->
                    <div class="analytics-matrix">
                        <!-- Ë∂ãÂäøÂàÜÊûê -->
                        <div class="analysis-row">
                            <div class="analysis-card compact">
                                <div class="card-header">
                                    <span class="card-icon">üìà</span>
                                    <h4>Ë∂ãÂäøÂàÜÊûê</h4>
                                    <div class="card-toggle" onclick="toggleCardContent('trends')">‚àí</div>
                                </div>
                                <div class="card-content" id="trendsContent">
                                    <div class="trend-grid">
                                        <div class="trend-item">
                                            <div class="trend-title">ÊúàÂ∫¶Ë∂ãÂäø</div>
                                            <div class="trend-chart" id="monthlyTrends"></div>
                                        </div>
                                        <div class="trend-item">
                                            <div class="trend-title">Âë®Â∫¶Ë°®Áé∞</div>
                                            <div class="trend-chart" id="weeklyTrends"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>



                        <!-- ÂõæË°®ÂàÜÊûêÂå∫Âüü -->
                        <div class="charts-grid">
                            <!-- Á¨¨‰∏ÄË°åÔºöÈ•ºÂõæÂíåÁéØÂΩ¢Âõæ -->
                            <div class="chart-card pie-chart-card">
                                <div class="chart-header">
                                    <h4>üç∞ ‰∏öÂä°Á±ªÂûãÂàÜÂ∏É</h4>
                                    <span class="chart-badge">È•ºÂõæ</span>
                                </div>
                                <div class="chart-body">
                                    <div class="pie-chart" id="businessTypePieChart"></div>
                                    <div class="chart-legend compact" id="pieChartLegend"></div>
                                </div>
                            </div>

                            <div class="chart-card donut-chart-card wide">
                                <div class="chart-header">
                                    <h4>üë• ÂÆ¢Êà∑Êù•Ê∫êÁªüËÆ°ÂàÜÊûê</h4>
                                    <span class="chart-badge">Êù•Ê∫êÂàÜÂ∏É</span>
                                </div>
                                <div class="chart-body">
                                    <div class="customer-source-analysis" id="customerSourceAnalysis">
                                        <!-- ÂÆ¢Êà∑Êù•Ê∫êÁªüËÆ°ÂàÜÊûêÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                                    </div>
                                </div>
                            </div>

                            <!-- Á¨¨‰∫åË°åÔºö‰∏öÁª©ÊéíÂêç -->
                            <div class="chart-card bar-chart-card wide">
                                <div class="chart-header">
                                    <h4>üèÜ ‰∏öÁª©ÊéíÂêç</h4>
                                    <span class="chart-badge">ÊéíË°åÊ¶ú</span>
                                </div>
                                <div class="chart-body">
                                    <div class="performance-ranking" id="teamPerformanceRanking"></div>
                                </div>
                            </div>

                            <!-- Á¨¨‰∏âË°åÔºöÈò∂Ê¢ØÂõæÂíåÊ†ëÁä∂Âõæ -->
                            <div class="chart-card step-chart-card">
                                <div class="chart-header">
                                    <h4>üí∞ Êú™Êî∂Ê¨æÁªüËÆ°</h4>
                                    <span class="chart-badge">Ê¨†Ê¨æÂàÜÊûê</span>
                                </div>
                                <div class="chart-body">
                                    <div class="unpaid-stats" id="unpaidStats">
                                        <!-- Êú™Êî∂Ê¨æÁªüËÆ°Â∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                                    </div>
                                </div>
                            </div>


                        </div>

                        <!-- Êô∫ËÉΩÊ¥ûÂØü -->
                        <div class="analysis-row">
                            <div class="analysis-card insight">
                                <div class="card-header">
                                    <span class="card-icon">üîç</span>
                                    <h4>Êô∫ËÉΩÊ¥ûÂØü</h4>
                                    <div class="card-toggle" onclick="toggleCardContent('insights')">‚àí</div>
                                </div>
                                <div class="card-content" id="insightsContent">
                                    <div class="insights-list" id="smartInsights"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="salary" class="tab-content">
                    <div class="statistics">
                        <h3>üí∞ Â∑•ËµÑËÆ°ÁÆóËØ¶ÊÉÖ</h3>
                        <div id="salaryDetails"></div>
                    </div>
                </div>

                <div id="settings" class="tab-content">
                    <!-- ‰∏öÂä°Á±ªÂûãÁÆ°ÁêÜ -->
                    <div class="settings-section">
                        <h3>üìù ‰∏öÂä°Á±ªÂûãÁÆ°ÁêÜ</h3>
                        <div class="add-form">
                            <input type="text" id="newBusinessType" placeholder="ËØ∑ËæìÂÖ•Êñ∞ÁöÑ‰∏öÂä°Á±ªÂûã">
                            <button class="btn" onclick="addBusinessType()">
                                <span>‚ûï</span>
                                <span>Ê∑ªÂä†</span>
                            </button>
                        </div>
                        <div class="items-list" id="businessTypesList"></div>
                    </div>

                    <!-- Êî∂ÂÖ•Á±ªÂûãÁÆ°ÁêÜ -->
                    <div class="settings-section">
                        <h3>üíº Êî∂ÂÖ•Á±ªÂûãÁÆ°ÁêÜ</h3>
                        <div class="add-form">
                            <input type="text" id="newIncomeType" placeholder="ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊî∂ÂÖ•Á±ªÂûã">
                            <button class="btn" onclick="addIncomeType()">
                                <span>‚ûï</span>
                                <span>Ê∑ªÂä†</span>
                            </button>
                        </div>
                        <div class="items-list" id="incomeTypesList"></div>
                    </div>

                    <!-- ÂÆ¢Êà∑Êù•Ê∫êÁÆ°ÁêÜ -->
                    <div class="settings-section">
                        <h3>üîó ÂÆ¢Êà∑Êù•Ê∫êÁÆ°ÁêÜ</h3>
                        <div class="add-form">
                            <input type="text" id="newCustomerSource" placeholder="ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂÆ¢Êà∑Êù•Ê∫ê">
                            <button class="btn" onclick="addCustomerSource()">
                                <span>‚ûï</span>
                                <span>Ê∑ªÂä†</span>
                            </button>
                        </div>
                        <div class="items-list" id="customerSourcesList"></div>
                    </div>

                    <!-- ÈîÄÂîÆ‰∫∫ÂëòÁÆ°ÁêÜ -->
                    <div class="settings-section">
                        <h3>üë• ÈîÄÂîÆ‰∫∫ÂëòÁÆ°ÁêÜ</h3>
                        <div class="add-form">
                            <input type="text" id="newSalesperson" placeholder="ÂßìÂêç">
                            <input type="number" id="newBaseSalary" placeholder="Âü∫Á°ÄÂ∑•ËµÑ">
                            <select id="newCommissionType" onchange="toggleCommissionInput()">
                                <option value="fixed">Âõ∫ÂÆöÊØî‰æã</option>
                                <option value="ladder">Èò∂Ê¢ØÂºè</option>
                            </select>
                            <input type="number" id="newFixedRate" placeholder="ÊèêÊàê%" step="0.1" min="0">
                            <button class="btn" onclick="addSalesperson()">
                                <span>‚ûï</span>
                                <span>Ê∑ªÂä†‰∫∫Âëò</span>
                            </button>
                        </div>
                        <div class="items-list" id="salespersonList"></div>
                    </div>

                    <!-- Á≥ªÁªüÊìç‰Ωú -->
                    <div class="settings-section">
                        <h3>üîß Á≥ªÁªüÊìç‰Ωú</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn" onclick="loadSettingsData()">
                                <span>üîÑ</span>
                                <span>Âà∑Êñ∞Êï∞ÊçÆ</span>
                            </button>
                            <button class="btn btn-secondary" onclick="forceRefreshAll()">
                                <span>‚ö°</span>
                                <span>Âº∫Âà∂Âà∑Êñ∞</span>
                            </button>
                            <button class="btn btn-warning" onclick="fixDataConsistency()">
                                <span>üîß</span>
                                <span>‰øÆÂ§çÊï∞ÊçÆ</span>
                            </button>
                            <button class="btn btn-tertiary" onclick="debugSettingsData()">
                                <span>üîç</span>
                                <span>Ë∞ÉËØïÊ£ÄÊü•</span>
                            </button>
                            <button class="btn btn-danger" onclick="resetAllSettings()">
                                <span>üîÑ</span>
                                <span>ÈáçÁΩÆÊâÄÊúâËÆæÁΩÆ</span>
                            </button>
                            <button class="btn btn-secondary" onclick="exportSettings()">
                                <span>üì§</span>
                                <span>ÂØºÂá∫ËÆæÁΩÆ</span>
                            </button>
                            <button class="btn btn-tertiary" onclick="document.getElementById('importSettingsFile').click()">
                                <span>üì•</span>
                                <span>ÂØºÂÖ•ËÆæÁΩÆ</span>
                            </button>
                        </div>
                        <input type="file" id="importSettingsFile" accept=".json" style="display:none" onchange="importSettings()">
                    </div>
                </div>

                <div class="export-section">
                    <h3>üì§ Êï∞ÊçÆÂØºÂá∫</h3>
                    <div class="export-buttons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-secondary" onclick="exportToExcel()">
                            <span>üìä</span>
                            <span>ÂØºÂá∫Excel</span>
                        </button>
                        <button class="btn btn-warning" onclick="exportToPDF()">
                            <span>üìÑ</span>
                            <span>ÂØºÂá∫PDF</span>
                        </button>
                        <button class="btn btn-tertiary" onclick="exportToCSV()">
                            <span>üìã</span>
                            <span>ÂØºÂá∫CSV</span>
                        </button>
                        <button class="btn" onclick="backupData()">
                            <span>üíæ</span>
                            <span>Â§á‰ªΩÊï∞ÊçÆ</span>
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                            <span>üì•</span>
                            <span>ÂØºÂÖ•Êï∞ÊçÆ</span>
                        </button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData()">
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; font-size: 12px; color: #666;">
                        üí° <strong>ÂØºÂá∫ËØ¥ÊòéÔºö</strong><br>
                        ‚Ä¢ <strong>ExcelÊ†ºÂºèÔºö</strong>ÂåÖÂê´3‰∏™Â∑•‰ΩúË°®ÔºàÈîÄÂîÆËÆ∞ÂΩï+Â∑•ËµÑËÆ°ÁÆó+ÁªüËÆ°Ê±áÊÄªÔºâÔºåÊîØÊåÅÂÆåÊï¥Ë¥¢Âä°Êï∞ÊçÆ„ÄÇÂ¶ÇÂØºÂá∫Â§±Ë¥•‰ºöËá™Âä®Êèê‰æõÁÆÄÂåñÁâà<br>
                        ‚Ä¢ <strong>PDFÊ†ºÂºèÔºö</strong>ÂåÖÂê´ÂÆåÊï¥Êä•Ë°®ÔºåÈÄÇÂêàÊâìÂç∞ÂíåÂ≠òÊ°£<br>
                        ‚Ä¢ <strong>CSVÊ†ºÂºèÔºö</strong>Á∫ØÊï∞ÊçÆÊ†ºÂºèÔºåÈÄÇÂêàÊï∞ÊçÆÂàÜÊûêÂíåÂØºÂÖ•ÂÖ∂‰ªñÁ≥ªÁªü<br>
                        <span style="color: #ff6b6b;">‚ö†Ô∏è È¶ñÊ¨°‰ΩøÁî®ËØ∑Á°Æ‰øùÁΩëÁªúËøûÊé•Ê≠£Â∏∏Ôºå‰ª•Âä†ËΩΩÂøÖË¶ÅÁªÑ‰ª∂</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Èò∂Ê¢ØÂºèÊèêÊàêÁºñËæëÊ®°ÊÄÅÊ°Ü -->
    <div id="ladderModal" class="modal">
        <div class="modal-content">
            <h3>üéØ ÁºñËæëÈò∂Ê¢ØÂºèÊèêÊàê</h3>
            <p>ÈîÄÂîÆ‰∫∫ÂëòÔºö<span id="currentEditPerson"></span></p>
            <div style="background: #e7f3ff; padding: 15px; margin-bottom: 15px; border-radius: 5px; font-size: 12px;">
                <strong>üí° Èò∂Ê¢ØÂºèÊèêÊàêËØ¥ÊòéÔºö</strong><br>
                ‚Ä¢ ÈááÁî®Á¥ØËøõÂºèËÆ°ÁÆóÔºå‰ΩéÈîÄÂîÆÈ¢ùÈÉ®ÂàÜÊåâ‰ΩéÊØî‰æãÔºåÈ´òÈîÄÂîÆÈ¢ùÈÉ®ÂàÜÊåâÈ´òÊØî‰æã<br>
                ‚Ä¢ <strong>Ê†áÂáÜÈò∂Ê¢ØÔºö</strong><br>
                „ÄÄ„ÄÄ‚â§ 3‰∏áÂÖÉÔºö6%<br>
                „ÄÄ„ÄÄ3‰∏á-10‰∏áÂÖÉÔºö15%ÔºàÂâç3‰∏á‰ªçÊåâ6%Ôºâ<br>
                „ÄÄ„ÄÄ10‰∏á-20‰∏áÂÖÉÔºö20%ÔºàÂâçÈù¢ÈÉ®ÂàÜÊåâÂéüÊØî‰æãÔºâ<br>
                „ÄÄ„ÄÄ> 20‰∏áÂÖÉÔºö25%ÔºàÂâçÈù¢ÈÉ®ÂàÜÊåâÂéüÊØî‰æãÔºâ<br>
                ‚Ä¢ <strong>‰∏æ‰æãÔºö</strong>ÈîÄÂîÆ8‰∏áÂÖÉ = 3‰∏á√ó6% + 5‰∏á√ó15% = 1800+7500 = 9300ÂÖÉ
            </div>
            <div id="ladderEditor"></div>
            <div style="margin: 15px 0;">
                <button class="btn" onclick="addLadderLevel()">‚ûï Ê∑ªÂä†Èò∂Ê¢Ø</button>
                <button class="btn btn-secondary" onclick="setStandardLadder()">üéØ ËÆæÁΩÆÊ†áÂáÜÈò∂Ê¢Ø</button>
                <button class="btn btn-tertiary" onclick="clearAllLadders()">üóëÔ∏è Ê∏ÖÁ©∫Èò∂Ê¢Ø</button>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn" onclick="saveLadderSettings()">üíæ ‰øùÂ≠ò</button>
                <button class="btn btn-secondary" onclick="closeLadderModal()">‚ùå ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <script>
        // SupabaseÈÖçÁΩÆ - ËØ∑ÊõøÊç¢‰∏∫ÊÇ®ÁöÑÂÆûÈôÖÈÖçÁΩÆ
        const SUPABASE_URL = 'https://telnhaacebduhkhqbvla.supabase.co'; // ÊõøÊç¢‰∏∫ÊÇ®ÁöÑSupabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRlbG5oYWFjZWJkdWhraHFidmxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1MDA5MzMsImV4cCI6MjA2NjA3NjkzM30.XEWYm_6FMh-JhFriN2ux4zyPgi1-DXxyd25s065jqV4'; // ÊõøÊç¢‰∏∫ÊÇ®ÁöÑSupabaseÂåøÂêçÂØÜÈí•
        
        // ÂÖ®Â±ÄÂèòÈáè
        let supabase = null;
        let currentUser = null;
        let isSupabaseReady = false;
        
        // ÂàùÂßãÂåñSupabaseÂÆ¢Êà∑Á´Ø
        function initializeSupabase() {
            try {
                if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    isSupabaseReady = true;
                    console.log('‚úÖ SupabaseÂÆ¢Êà∑Á´ØÂ∑≤ÂàùÂßãÂåñ');
                    checkAuthStatus();
                } else {
                    // SupabaseÂ∫ìËøòÊ≤°Âä†ËΩΩÂÆåÊàêÔºåÁ®çÂêéÈáçËØï
                    setTimeout(initializeSupabase, 100);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è SupabaseÂàùÂßãÂåñÂ§±Ë¥•ÔºåÂ∞Ü‰ΩøÁî®Êú¨Âú∞Ê®°Âºè:', error);
                showAuthError('ËøûÊé•ÊúçÂä°Âô®Â§±Ë¥•ÔºåÂ∑≤ÂàáÊç¢Âà∞Á¶ªÁ∫øÊ®°Âºè');
                showMainApp(); // ÈôçÁ∫ßÂà∞Êú¨Âú∞Ê®°Âºè
            }
        }

        // ÊÄßËÉΩ‰ºòÂåñÔºöÂª∂ËøüÂàùÂßãÂåñÊï∞ÊçÆÔºåÂáèÂ∞ëÈ¶ñÊ¨°Âä†ËΩΩÊó∂Èó¥
        let salesData = null;
        let systemSettings = null;
        
        // ÊáíÂä†ËΩΩÈîÄÂîÆÊï∞ÊçÆ
        function getSalesData() {
            if (salesData === null) {
                salesData = JSON.parse(localStorage.getItem('salesData')) || [];
            }
            return salesData;
        }
        
        // ÊáíÂä†ËΩΩÁ≥ªÁªüËÆæÁΩÆ
        function getSystemSettings() {
            if (systemSettings === null) {
                systemSettings = JSON.parse(localStorage.getItem('systemSettings')) || {};
                
                // Á°Æ‰øùÊâÄÊúâÂøÖÈúÄÂ≠óÊÆµÈÉΩÂ≠òÂú®ÔºåÂ¶ÇÊûúÁº∫Â§±ÂàôÊ∑ªÂä†ÈªòËÆ§ÂÄº
                let needsSave = false;
                if (!systemSettings.businessTypes) {
                    systemSettings.businessTypes = ['Âí®ËØ¢ÊúçÂä°', 'Âí®ËØ¢È¶ñÊ¨æ', 'Âí®ËØ¢Â∞æÊ¨æ', 'Èô™Ë∑ëÊúçÂä°', 'Èô™Ë∑ëÈ¶ñ‰ªò', 'Èô™Ë∑ëÂ∞æÊ¨æ', 'ÂüπËÆ≠ÊúçÂä°', 'ÂüπËÆ≠Âç†‰Ωç', 'ÂÖ∂‰ªñ'];
                    needsSave = true;
                }
                if (!systemSettings.incomeTypes) {
                    systemSettings.incomeTypes = ['ÊäºÈáë', 'ÂüπËÆ≠Êî∂ÂÖ•', 'Êó•Á≠æÊî∂ÂÖ•', 'Ëã±Á≠æÊî∂ÂÖ•', 'ÁæéÁ≠æÊî∂ÂÖ•', 'Âä†Á≠æÊî∂ÂÖ•', 'Êæ≥Á≠æÊî∂ÂÖ•', 'Âí®ËØ¢Êî∂ÂÖ•', 'Êó•ÁßüÊî∂ÂÖ•', 'ÂÖ∂‰ªñÊî∂ÂÖ•'];
                    needsSave = true;
                }
                if (!systemSettings.customerSources) {
                    systemSettings.customerSources = ['Ëá™ÊúâÂÆ¢Êà∑', 'ËøêËê•Á∫øÁ¥¢', 'ËøêËê•ËΩ¨‰ªãÁªç', 'ÂÆ¢Êà∑ËΩ¨‰ªãÁªç', 'ÁÆ°ÁêÜÂÜÖÊé®'];
                    needsSave = true;
                }
                if (!systemSettings.salespeople) {
                    systemSettings.salespeople = [
                        { name: 'ÂÜØÊâøËäë', baseSalary: 5500, commissionType: 'fixed', fixedRate: 0.06, ladderRates: [] },
                        { name: 'ÊùéÂ¶ç', baseSalary: 5500, commissionType: 'fixed', fixedRate: 0.06, ladderRates: [] },
                        { name: 'Â∫ûÈî¶Â™ö', baseSalary: 5500, commissionType: 'fixed', fixedRate: 0.06, ladderRates: [] },
                        { name: 'ÈÇπÂπ≥', baseSalary: 5500, commissionType: 'fixed', fixedRate: 0.06, ladderRates: [] },
                        { name: 'Áéã‰∏úËæâ', baseSalary: 5500, commissionType: 'fixed', fixedRate: 0.06, ladderRates: [] },
                        { name: 'Âº†ÁéâÊ∂µ', baseSalary: 5500, commissionType: 'fixed', fixedRate: 0.06, ladderRates: [] },
                        { name: 'ÊùéÂç†Ëã±', baseSalary: 5500, commissionType: 'fixed', fixedRate: 0.06, ladderRates: [] },
                        { name: 'ÊùéÊ°ÇÁé≤', baseSalary: 5500, commissionType: 'fixed', fixedRate: 0.06, ladderRates: [] }
                    ];
                    needsSave = true;
                }
                
                // Âè™ÊúâÂú®ÈúÄË¶ÅÊó∂Êâç‰øùÂ≠ò
                if (needsSave) {
                    localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
                }
            }
            return systemSettings;
        }
        
        // ‰øùÂ≠òÁ≥ªÁªüËÆæÁΩÆ
        function saveSystemSettings() {
            if (systemSettings !== null) {
                localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
            }
        }
        
        // ‰øùÂ≠òÈîÄÂîÆÊï∞ÊçÆ
        function saveSalesData() {
            if (salesData !== null) {
                localStorage.setItem('salesData', JSON.stringify(salesData));
            }
        }
        
        let currentEditPersonIndex = -1;

        // ÊÄßËÉΩ‰ºòÂåñÔºöÊ£ÄÊü•Â§ñÈÉ®Â∫ìÂä†ËΩΩÁä∂ÊÄÅÂπ∂Êèê‰æõÈôçÁ∫ßÊñπÊ°à
        function checkLibrariesLoaded() {
            const libStatus = {
                xlsx: typeof XLSX !== 'undefined',
                html2canvas: typeof html2canvas !== 'undefined',
                jsPDF: typeof window.jspdf !== 'undefined'
            };
            
            // ËÆ∞ÂΩïÂ∫ìÂä†ËΩΩÁä∂ÊÄÅ‰ΩÜ‰∏çÂΩ±ÂìçÁî®Êà∑‰ΩìÈ™å
            if (!libStatus.xlsx) {
                console.info('XLSXÂ∫ìÊú™Âä†ËΩΩÔºåExcelÂØºÂá∫Â∞Ü‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°à');
            }
            if (!libStatus.html2canvas) {
                console.info('html2canvasÂ∫ìÊú™Âä†ËΩΩÔºåPDFÂØºÂá∫Â∞Ü‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°à');
            }
            if (!libStatus.jsPDF) {
                console.info('jsPDFÂ∫ìÊú™Âä†ËΩΩÔºåPDFÂØºÂá∫Â∞Ü‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°à');
            }
            
            return libStatus;
        }
        
        // ÊÄßËÉΩ‰ºòÂåñÔºöÂª∂ËøüÂä†ËΩΩÊú™Âä†ËΩΩÁöÑÂ∫ì
        function ensureLibraryLoaded(libName) {
            return new Promise((resolve) => {
                if (libName === 'xlsx' && typeof XLSX !== 'undefined') {
                    resolve(true);
                } else if (libName === 'html2canvas' && typeof html2canvas !== 'undefined') {
                    resolve(true);
                } else if (libName === 'jspdf' && typeof window.jspdf !== 'undefined') {
                    resolve(true);
                } else {
                    // Â∫ìÊú™Âä†ËΩΩÔºåÂ∞ùËØïÈáçÊñ∞Âä†ËΩΩÊàñ‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°à
                    console.warn(`${libName}Â∫ìÊú™Âä†ËΩΩÔºå‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°à`);
                    resolve(false);
                }
            });
        }

        // ====== ËÆ§ËØÅÁõ∏ÂÖ≥ÂáΩÊï∞ ======
        
        // Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ
        async function checkAuthStatus() {
            if (!isSupabaseReady) {
                setTimeout(checkAuthStatus, 500);
                return;
            }
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session) {
                    currentUser = session.user;
                    console.log('‚úÖ Áî®Êà∑Â∑≤ÁôªÂΩï:', currentUser.email);
                    await loadUserProfile();
                    showMainApp();
                } else {
                    console.log('‚ÑπÔ∏è Áî®Êà∑Êú™ÁôªÂΩïÔºåÊòæÁ§∫ÁôªÂΩïÁïåÈù¢');
                    showAuthModal();
                }
            } catch (error) {
                console.error('Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅÂ§±Ë¥•:', error);
                showAuthError('ËÆ§ËØÅÊ£ÄÊü•Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }
        
        // ÊòæÁ§∫ËÆ§ËØÅÊ®°ÊÄÅÊ°Ü
        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
        }
        
        // ÊòæÁ§∫‰∏ªÂ∫îÁî®
        function showMainApp() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            initializeMainApp();
        }
        
        // ÂàùÂßãÂåñ‰∏ªÂ∫îÁî®
        async function initializeMainApp() {
            try {
                // ËÆæÁΩÆÈªòËÆ§Êó•Êúü
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                
                // ÂàùÂßãÂåñÁ≥ªÁªüËÆæÁΩÆÂíåÊï∞ÊçÆ
                getSystemSettings();
                updateFormOptions();
                toggleCommissionInput();
                
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                showToast('Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...', 'info');
                
                // ‰ºòÂÖà‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆÔºåÁÑ∂ÂêéÂêåÊ≠•
                await loadSalesRecordsFromDatabase();
                
                // ÈùôÈªòÂêåÊ≠•ÔºàÈ¶ñÊ¨°Âä†ËΩΩÊó∂‰∏çÊòæÁ§∫ÂêåÊ≠•ÊèêÁ§∫Ôºâ
                if (isSupabaseReady && currentUser) {
                    const { data: cloudData } = await supabase
                        .from('sales_records')
                        .select('*')
                        .eq('user_id', currentUser.id);
                    
                    if (cloudData && cloudData.length > 0) {
                        console.log(`‚úÖ ‰ªé‰∫ëÁ´ØÂä†ËΩΩ‰∫Ü ${cloudData.length} Êù°ËÆ∞ÂΩï`);
                    }
                }
                
                // Âä†ËΩΩÁïåÈù¢Êï∞ÊçÆ
                loadTableData();
                updateStatistics();
                updateSalaryDetails();
                
                // ÊòæÁ§∫ÂÆåÊàêÁä∂ÊÄÅ
                showToast('‚úÖ Á≥ªÁªüÂä†ËΩΩÂÆåÊàê', 'success');
                console.log('‚úÖ ‰∏ªÂ∫îÁî®ÂàùÂßãÂåñÂÆåÊàê');
                
            } catch (error) {
                console.error('‚ùå ‰∏ªÂ∫îÁî®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                showToast('ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'error');
            }
        }
        
        // ÊòæÁ§∫/ÈöêËóèË°®Âçï
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            clearAuthMessage();
        }
        
        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearAuthMessage();
        }
        
        // Â§ÑÁêÜÁôªÂΩï
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAuthError('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÁôªÂΩï‰ø°ÊÅØ');
                return;
            }
            
            if (!isSupabaseReady) {
                showAuthError('Á≥ªÁªüÊ≠£Âú®ÂàùÂßãÂåñÔºåËØ∑Á®çÂêéÂÜçËØï');
                return;
            }
            
            setAuthLoading(true);
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    throw error;
                }
                
                currentUser = data.user;
                console.log('‚úÖ ÁôªÂΩïÊàêÂäü:', currentUser.email);
                showAuthSuccess('ÁôªÂΩïÊàêÂäüÔºåÊ≠£Âú®Ë∑≥ËΩ¨...');
                
                setTimeout(async () => {
                    await loadUserProfile();
                    showMainApp();
                }, 1000);
                
            } catch (error) {
                console.error('ÁôªÂΩïÂ§±Ë¥•:', error);
                let errorMessage = 'ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÈÇÆÁÆ±ÂíåÂØÜÁ†Å';
                
                if (error.message.includes('Invalid login credentials')) {
                    errorMessage = 'ÈÇÆÁÆ±ÊàñÂØÜÁ†ÅÈîôËØØ';
                } else if (error.message.includes('Email not confirmed')) {
                    errorMessage = 'ËØ∑ÂÖàÈ™åËØÅÊÇ®ÁöÑÈÇÆÁÆ±';
                }
                
                showAuthError(errorMessage);
            } finally {
                setAuthLoading(false);
            }
        }
        
        // Â§ÑÁêÜÊ≥®ÂÜå
        async function handleRegister() {
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const name = document.getElementById('registerName').value.trim();
            const role = document.getElementById('registerRole').value;
            
            if (!email || !password || !name || !role) {
                showAuthError('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÊ≥®ÂÜå‰ø°ÊÅØ');
                return;
            }
            
            if (password.length < 6) {
                showAuthError('ÂØÜÁ†ÅËá≥Â∞ëÈúÄË¶Å6‰ΩçÂ≠óÁ¨¶');
                return;
            }
            
            if (!isSupabaseReady) {
                showAuthError('Á≥ªÁªüÊ≠£Âú®ÂàùÂßãÂåñÔºåËØ∑Á®çÂêéÂÜçËØï');
                return;
            }
            
            setAuthLoading(true);
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: name,
                            role: role
                        }
                    }
                });
                
                if (error) {
                    throw error;
                }
                
                console.log('‚úÖ Ê≥®ÂÜåÊàêÂäü:', data.user?.email);
                showAuthSuccess('Ê≥®ÂÜåÊàêÂäüÔºÅËØ∑Ê£ÄÊü•ÈÇÆÁÆ±È™åËØÅÈìæÊé•ÔºåÈ™åËØÅÂêéÂç≥ÂèØÁôªÂΩï„ÄÇ');
                
                // Ëá™Âä®ÂàáÊç¢Âà∞ÁôªÂΩïË°®Âçï
                setTimeout(() => {
                    showLoginForm();
                    document.getElementById('loginEmail').value = email;
                }, 2000);
                
            } catch (error) {
                console.error('Ê≥®ÂÜåÂ§±Ë¥•:', error);
                let errorMessage = 'Ê≥®ÂÜåÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';
                
                if (error.message.includes('already registered')) {
                    errorMessage = 'ËØ•ÈÇÆÁÆ±Â∑≤Ë¢´Ê≥®ÂÜåÔºåËØ∑‰ΩøÁî®ÂÖ∂‰ªñÈÇÆÁÆ±';
                } else if (error.message.includes('Password should be')) {
                    errorMessage = 'ÂØÜÁ†ÅÊ†ºÂºè‰∏çÁ¨¶ÂêàË¶ÅÊ±Ç';
                }
                
                showAuthError(errorMessage);
            } finally {
                setAuthLoading(false);
            }
        }
        
        // Â§ÑÁêÜÁôªÂá∫
        async function handleLogout() {
            if (!isSupabaseReady) return;
            
            try {
                await supabase.auth.signOut();
                currentUser = null;
                console.log('‚úÖ Â∑≤ÁôªÂá∫');
                showAuthModal();
                
                // Ê∏ÖÁêÜÊú¨Âú∞Êï∞ÊçÆ
                salesData = null;
                systemSettings = null;
                
            } catch (error) {
                console.error('ÁôªÂá∫Â§±Ë¥•:', error);
                alert('ÁôªÂá∫Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢');
            }
        }
        
        // Âä†ËΩΩÁî®Êà∑ËµÑÊñô
        async function loadUserProfile() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
                    throw error;
                }
                
                // Êõ¥Êñ∞Áî®Êà∑Áä∂ÊÄÅÊòæÁ§∫
                const userStatusElement = document.getElementById('currentUser');
                if (userStatusElement) {
                    const userName = data?.full_name || currentUser.user_metadata?.full_name || currentUser.email;
                    const userRole = data?.role || currentUser.user_metadata?.role || 'sales';
                    userStatusElement.textContent = `${userName} (${getRoleDisplayName(userRole)})`;
                }
                
            } catch (error) {
                console.error('Âä†ËΩΩÁî®Êà∑ËµÑÊñôÂ§±Ë¥•:', error);
            }
        }
        
        // Ëé∑ÂèñËßíËâ≤ÊòæÁ§∫ÂêçÁß∞
        function getRoleDisplayName(role) {
            switch (role) {
                case 'admin': return 'ÁÆ°ÁêÜÂëò';
                case 'manager': return 'ÈîÄÂîÆÁªèÁêÜ';
                case 'sales': return 'ÈîÄÂîÆ‰∫∫Âëò';
                default: return 'Áî®Êà∑';
            }
        }
        
        // ÊòæÁ§∫ËÆ§ËØÅÈîôËØØ
        function showAuthError(message) {
            const messageElement = document.getElementById('authMessage');
            messageElement.textContent = message;
            messageElement.className = 'auth-message error';
            messageElement.style.display = 'block';
            
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }
        
        // ÊòæÁ§∫ËÆ§ËØÅÊàêÂäü
        function showAuthSuccess(message) {
            const messageElement = document.getElementById('authMessage');
            messageElement.textContent = message;
            messageElement.className = 'auth-message success';
            messageElement.style.display = 'block';
        }
        
        // Ê∏ÖÈô§ËÆ§ËØÅÊ∂àÊÅØ
        function clearAuthMessage() {
            const messageElement = document.getElementById('authMessage');
            messageElement.style.display = 'none';
        }
        
        // ËÆæÁΩÆËÆ§ËØÅÂä†ËΩΩÁä∂ÊÄÅ
        function setAuthLoading(loading) {
            const loginBtn = document.querySelector('#loginForm .auth-btn');
            const registerBtn = document.querySelector('#registerForm .auth-btn');
            
            if (loading) {
                if (loginBtn) {
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'ÁôªÂΩï‰∏≠...';
                }
                if (registerBtn) {
                    registerBtn.disabled = true;
                    registerBtn.textContent = 'Ê≥®ÂÜå‰∏≠...';
                }
            } else {
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'ÁôªÂΩï';
                }
                if (registerBtn) {
                    registerBtn.disabled = false;
                    registerBtn.textContent = 'Ê≥®ÂÜå';
                }
            }
        }

        // ÊÄßËÉΩ‰ºòÂåñÔºöÈ°µÈù¢Âä†ËΩΩÊó∂ÂàÜÈò∂ÊÆµÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('È°µÈù¢ÂºÄÂßãÂàùÂßãÂåñ...');
            
            // Á´ãÂç≥ÂàùÂßãÂåñSupabase
            initializeSupabase();
        });

        // ====== Êï∞ÊçÆÂ∫ìÊìç‰ΩúÂáΩÊï∞ ======
        
        // ‰øùÂ≠òÈîÄÂîÆËÆ∞ÂΩïÂà∞Êï∞ÊçÆÂ∫ì
        async function saveSalesRecordToDatabase(record) {
            if (!isSupabaseReady || !currentUser) {
                console.warn('SupabaseÊú™Â∞±Áª™ÊàñÁî®Êà∑Êú™ÁôªÂΩïÔºå‰ªÖ‰øùÂ≠òÂà∞Êú¨Âú∞');
                return false;
            }
            
            try {
                const { data, error } = await supabase
                    .from('sales_records')
                    .insert([{
                        ...record,
                        user_id: currentUser.id,
                        created_by: currentUser.email
                    }]);
                
                if (error) throw error;
                
                console.log('‚úÖ ÈîÄÂîÆËÆ∞ÂΩïÂ∑≤‰øùÂ≠òÂà∞‰∫ëÁ´Ø');
                return true;
                
            } catch (error) {
                console.error('‚ùå ‰øùÂ≠òÈîÄÂîÆËÆ∞ÂΩïÂà∞‰∫ëÁ´ØÂ§±Ë¥•:', error);
                return false;
            }
        }
        
        // ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÈîÄÂîÆËÆ∞ÂΩï
        async function loadSalesRecordsFromDatabase() {
            if (!isSupabaseReady || !currentUser) {
                console.warn('SupabaseÊú™Â∞±Áª™ÊàñÁî®Êà∑Êú™ÁôªÂΩïÔºå‰ΩøÁî®Êú¨Âú∞Êï∞ÊçÆ');
                return getSalesData();
            }
            
            try {
                const { data, error } = await supabase
                    .from('sales_records')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                console.log(`‚úÖ ‰ªé‰∫ëÁ´ØÂä†ËΩΩ‰∫Ü ${data.length} Êù°ÈîÄÂîÆËÆ∞ÂΩï`);
                
                // ÂêàÂπ∂‰∫ëÁ´ØÊï∞ÊçÆÂíåÊú¨Âú∞Êï∞ÊçÆ
                salesData = data || [];
                localStorage.setItem('salesData', JSON.stringify(salesData));
                
                return salesData;
                
            } catch (error) {
                console.error('‚ùå ‰ªé‰∫ëÁ´ØÂä†ËΩΩÈîÄÂîÆËÆ∞ÂΩïÂ§±Ë¥•:', error);
                return getSalesData(); // ÈôçÁ∫ßÂà∞Êú¨Âú∞Êï∞ÊçÆ
            }
        }
        
        // Âà†Èô§ÈîÄÂîÆËÆ∞ÂΩïÔºà‰∫ëÁ´Ø + Êú¨Âú∞Ôºâ
        async function deleteSalesRecord(recordId) {
            if (!recordId) return false;
            
            // ÂÖà‰ªéÊú¨Âú∞Âà†Èô§
            const localData = getSalesData();
            const localIndex = localData.findIndex(item => item.id == recordId);
            if (localIndex !== -1) {
                localData.splice(localIndex, 1);
                localStorage.setItem('salesData', JSON.stringify(localData));
            }
            
            // ÂÜç‰ªé‰∫ëÁ´ØÂà†Èô§
            if (isSupabaseReady && currentUser) {
                try {
                    const { error } = await supabase
                        .from('sales_records')
                        .delete()
                        .eq('id', recordId)
                        .eq('user_id', currentUser.id);
                    
                    if (error) throw error;
                    console.log('‚úÖ ‰∫ëÁ´ØËÆ∞ÂΩïÂ∑≤Âà†Èô§');
                    
                } catch (error) {
                    console.error('‚ùå Âà†Èô§‰∫ëÁ´ØËÆ∞ÂΩïÂ§±Ë¥•:', error);
                }
            }
            
            return true;
        }
        
        // Êï∞ÊçÆÂêåÊ≠•ÔºöÂêàÂπ∂Êú¨Âú∞Âíå‰∫ëÁ´ØÊï∞ÊçÆ
        async function syncDataWithCloud() {
            if (!isSupabaseReady || !currentUser) {
                showToast('ËØ∑ÂÖàÁôªÂΩïË¥¶Êà∑', 'error');
                return;
            }
            
            // ÊòæÁ§∫ÂêåÊ≠•Áä∂ÊÄÅ
            const syncBtn = document.querySelector('.sync-btn');
            const originalText = syncBtn.innerHTML;
            syncBtn.innerHTML = 'üîÑ';
            syncBtn.style.animation = 'spin 1s linear infinite';
            syncBtn.disabled = true;
            
            try {
                console.log('üîÑ ÂºÄÂßãÊï∞ÊçÆÂêåÊ≠•...');
                showToast('Ê≠£Âú®ÂêåÊ≠•Êï∞ÊçÆ...', 'info');
                
                // 1. Ëé∑Âèñ‰∫ëÁ´ØÊï∞ÊçÆ
                const { data: cloudData, error } = await supabase
                    .from('sales_records')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                // 2. Ëé∑ÂèñÊú¨Âú∞Êï∞ÊçÆ
                const localData = getSalesData();
                
                // 3. ÂêàÂπ∂Êï∞ÊçÆÔºà‰ª•‰∫ëÁ´ØÊï∞ÊçÆ‰∏∫ÂáÜÔºåË°•ÂÖÖÊú¨Âú∞Áã¨ÊúâÊï∞ÊçÆÔºâ
                const cloudIds = new Set(cloudData.map(item => item.id));
                const localOnlyData = localData.filter(item => !cloudIds.has(item.id));
                
                // 4. ‰∏ä‰º†Êú¨Âú∞Áã¨ÊúâÊï∞ÊçÆÂà∞‰∫ëÁ´Ø
                if (localOnlyData.length > 0) {
                    const uploadData = localOnlyData.map(item => ({
                        ...item,
                        user_id: currentUser.id,
                        created_by: currentUser.email
                    }));
                    
                    const { error: uploadError } = await supabase
                        .from('sales_records')
                        .insert(uploadData);
                    
                    if (uploadError) throw uploadError;
                    console.log(`‚úÖ ‰∏ä‰º†‰∫Ü ${localOnlyData.length} Êù°Êú¨Âú∞ËÆ∞ÂΩïÂà∞‰∫ëÁ´Ø`);
                    showToast(`Â∑≤‰∏ä‰º† ${localOnlyData.length} Êù°Êú¨Âú∞ËÆ∞ÂΩïÂà∞‰∫ëÁ´Ø`, 'success');
                }
                
                // 5. Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
                const mergedData = [...cloudData, ...localOnlyData];
                salesData = mergedData;
                localStorage.setItem('salesData', JSON.stringify(salesData));
                
                console.log(`‚úÖ Êï∞ÊçÆÂêåÊ≠•ÂÆåÊàêÔºåÂÖ± ${mergedData.length} Êù°ËÆ∞ÂΩï`);
                
                // 6. Âà∑Êñ∞ÁïåÈù¢
                loadTableData();
                updateStatistics();
                updateSalaryDetails();
                
                // ÊòæÁ§∫ÂêåÊ≠•ÊàêÂäü‰ø°ÊÅØ
                const cloudCount = cloudData.length;
                const localCount = localOnlyData.length;
                if (localCount > 0) {
                    showToast(`‚úÖ ÂêåÊ≠•ÂÆåÊàêÔºÅ‰∫ëÁ´Ø${cloudCount}Êù°Ôºå‰∏ä‰º†${localCount}Êù°`, 'success');
                } else {
                    showToast(`‚úÖ ÂêåÊ≠•ÂÆåÊàêÔºÅ‰∫ëÁ´ØÂÖ±${cloudCount}Êù°ËÆ∞ÂΩï`, 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Êï∞ÊçÆÂêåÊ≠•Â§±Ë¥•:', error);
                let errorMessage = 'Êï∞ÊçÆÂêåÊ≠•Â§±Ë¥•';
                
                if (error.message.includes('network')) {
                    errorMessage = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú';
                } else if (error.message.includes('unauthorized')) {
                    errorMessage = 'ËÆ§ËØÅÂ§±Ë¥•ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï';
                } else {
                    errorMessage = 'Êï∞ÊçÆÂêåÊ≠•Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';
                }
                
                showToast(errorMessage, 'error');
            } finally {
                // ÊÅ¢Â§çÂêåÊ≠•ÊåâÈíÆÁä∂ÊÄÅ
                syncBtn.innerHTML = originalText;
                syncBtn.style.animation = '';
                syncBtn.disabled = false;
            }
        }

        // Ë°®ÂçïÊèê‰∫§Â§ÑÁêÜÔºàÊîπËøõÁâàÔºâ
        document.getElementById('salesForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                id: Date.now(), // ‰ΩøÁî®Êó∂Èó¥Êà≥‰Ωú‰∏∫ÂîØ‰∏ÄID
                date: document.getElementById('date').value,
                customer: document.getElementById('customer').value,
                customerSource: document.getElementById('customerSource').value,
                businessType: document.getElementById('businessType').value,
                amount: parseFloat(document.getElementById('amount').value),
                incomeType: document.getElementById('incomeType').value,
                salesperson: document.getElementById('salesperson').value,
                contractAmount: parseFloat(document.getElementById('contractAmount').value) || 0,
                remarks: document.getElementById('remarks').value
            };

            // ÂÖàÊ∑ªÂä†Âà∞Êú¨Âú∞Êï∞ÊçÆ
            getSalesData().push(formData);
            localStorage.setItem('salesData', JSON.stringify(getSalesData()));
            
            // Á´ãÂç≥Êõ¥Êñ∞ÁïåÈù¢
            loadTableData();
            updateStatistics();
            updateSalaryDetails();
            
            // ÂºÇÊ≠•‰øùÂ≠òÂà∞‰∫ëÁ´Ø
            saveSalesRecordToDatabase(formData);
            
            // Â¶ÇÊûúÂΩìÂâçÂú®ÁªüËÆ°ÂàÜÊûêÊ†áÁ≠æÔºåÂàôÊõ¥Êñ∞ÁªüËÆ°
            if (document.getElementById('statistics').classList.contains('active')) {
                setTimeout(() => updateAllStatistics(), 50);
            }
            
            // ÊòæÁ§∫ÂñúÊä•ÂºπÁ™ó
            showCelebrationModal(formData);
            
            // ÈáçÁΩÆË°®Âçï
            this.reset();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
        });

        // ÊÄßËÉΩ‰ºòÂåñÔºöÁºìÂ≠òÂíåÈò≤ÈáçÂ§çÊ∏≤Êüì
        let lastTableDataHash = null;
        let lastTableRenderTime = 0;
        
        // Âä†ËΩΩË°®Ê†ºÊï∞ÊçÆÔºàÊ∑ªÂä†ÁºìÂ≠òÊú∫Âà∂Ôºâ
        function loadTableData() {
            const currentData = getSalesData();
            const currentHash = JSON.stringify(currentData);
            const now = Date.now();
            
            // Èò≤ÊäñÔºö100msÂÜÖ‰∏çÈáçÂ§çÊ∏≤Êüì
            if (now - lastTableRenderTime < 100) {
                return;
            }
            
            // ÁºìÂ≠òÔºöÂ¶ÇÊûúÊï∞ÊçÆÊ≤°ÂèòÂåñÂàô‰∏çÈáçÊñ∞Ê∏≤Êüì
            if (currentHash === lastTableDataHash) {
                return;
            }
            
            lastTableDataHash = currentHash;
            lastTableRenderTime = now;
            
            const tbody = document.getElementById('salesTableBody');
            tbody.innerHTML = '';
            
            // ÊåâÊó•ÊúüÂÄíÂ∫èÊéíÂàó
            const sortedData = currentData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // ÊÄßËÉΩ‰ºòÂåñÔºö‰ΩøÁî®DocumentFragmentÊâπÈáèÊèíÂÖ•DOM
            const fragment = document.createDocumentFragment();
            const today = new Date().toISOString().split('T')[0];
            
            // ÈôêÂà∂ÊòæÁ§∫Êï∞ÈáèÔºåÈÅøÂÖçÂ§ßÊï∞ÊçÆÈáèÊó∂Âç°È°ø
            const maxDisplayCount = 1000;
            const displayData = sortedData.slice(0, maxDisplayCount);
            
            displayData.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.customer}</td>
                    <td>${record.customerSource || '-'}</td>
                    <td>${record.businessType}</td>
                    <td>¬•${record.amount.toLocaleString()}</td>
                    <td>${record.incomeType}</td>
                    <td>${record.salesperson}</td>
                    <td>¬•${record.contractAmount.toLocaleString()}</td>
                    <td title="${record.remarks || '-'}">${record.remarks || '-'}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteRecord(${record.id})">Âà†Èô§</button>
                    </td>
                `;
                
                // Â¶ÇÊûúÊòØ‰ªäÂ§©ÁöÑËÆ∞ÂΩïÔºåÈ´ò‰∫ÆÊòæÁ§∫
                if (record.date === today) {
                    row.classList.add('highlight');
                }
                
                fragment.appendChild(row);
            });
            
            tbody.appendChild(fragment);
            
            // Â¶ÇÊûúÊúâÊõ¥Â§öÊï∞ÊçÆÊú™ÊòæÁ§∫ÔºåÊ∑ªÂä†ÊèêÁ§∫
            if (sortedData.length > maxDisplayCount) {
                const moreRow = tbody.insertRow();
                moreRow.innerHTML = `
                    <td colspan="10" style="text-align: center; color: #666; font-style: italic;">
                        ÊòæÁ§∫Ââç${maxDisplayCount}Êù°ËÆ∞ÂΩïÔºåÂÖ±${sortedData.length}Êù°ËÆ∞ÂΩï
                    </td>
                `;
            }
            
            // Êõ¥Êñ∞ËÆ∞ÂΩïËÆ°Êï∞
            updateTableRecordCount();
        }

        // Êõ¥Êñ∞Ë°®Ê†ºËÆ∞ÂΩïËÆ°Êï∞
        function updateTableRecordCount() {
            const count = getSalesData().length;
            const countElement = document.getElementById('tableRecordCount');
            if (countElement) {
                countElement.textContent = `ÂÖ± ${count} Êù°ËÆ∞ÂΩï`;
            }
        }

        // Âà∑Êñ∞Ë°®Ê†º
        function refreshTable() {
            clearSearch(); // Ê∏ÖÈô§ÊêúÁ¥¢Áä∂ÊÄÅ
            loadTableData();
            updateStatistics();
        }

        // ÊêúÁ¥¢ÂÆ¢Êà∑ÂäüËÉΩ
        function searchCustomer() {
            const searchInput = document.getElementById('customerSearchInput');
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm) {
                alert('ËØ∑ËæìÂÖ•Ë¶ÅÊêúÁ¥¢ÁöÑÂÆ¢Êà∑Âêç');
                searchInput.focus();
                return;
            }
            
            const allData = getSalesData();
            const filteredData = allData.filter(record => 
                record.customer && record.customer.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            displayFilteredResults(filteredData, searchTerm);
            
            // ÊòæÁ§∫Ê∏ÖÈô§ÊåâÈíÆ
            document.querySelector('.clear-search-btn').style.display = 'flex';
            
            // Êõ¥Êñ∞ËÆ∞ÂΩïËÆ°Êï∞
            const countElement = document.getElementById('tableRecordCount');
            if (countElement) {
                countElement.textContent = `ÊêúÁ¥¢Âà∞ ${filteredData.length} Êù°ËÆ∞ÂΩï`;
                countElement.style.color = '#ff4757';
                countElement.style.fontWeight = 'bold';
            }
        }

        // ÊòæÁ§∫ËøáÊª§ÂêéÁöÑÁªìÊûú
        function displayFilteredResults(filteredData, searchTerm) {
            const tbody = document.querySelector('#salesTable tbody');
            tbody.innerHTML = '';
            
            if (filteredData.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="10" class="search-no-results">
                        üòî Êú™ÊâæÂà∞ÂåÖÂê´ "${searchTerm}" ÁöÑÂÆ¢Êà∑ËÆ∞ÂΩï
                    </td>
                `;
                return;
            }
            
            // ÊåâÊó•ÊúüÂÄíÂ∫èÊéíÂàó
            const sortedData = filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedData.forEach(record => {
                const row = tbody.insertRow();
                
                // È´ò‰∫ÆÊòæÁ§∫ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
                const highlightedCustomer = highlightSearchTerm(record.customer, searchTerm);
                
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${highlightedCustomer}</td>
                    <td>${record.customerSource || ''}</td>
                    <td>${record.businessType}</td>
                    <td>¬•${record.amount.toLocaleString()}</td>
                    <td>${record.incomeType}</td>
                    <td>${record.salesperson}</td>
                    <td>¬•${(record.contractAmount || record.amount).toLocaleString()}</td>
                    <td>${record.remarks || ''}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteRecord('${record.id}')">Âà†Èô§</button>
                    </td>
                `;
                
                // Â¶ÇÊûúÊòØ‰ªäÂ§©ÁöÑËÆ∞ÂΩïÔºåÊ∑ªÂä†È´ò‰∫Æ
                const today = new Date().toISOString().split('T')[0];
                if (record.date === today) {
                    row.classList.add('highlight');
                }
            });
        }

        // È´ò‰∫ÆÊòæÁ§∫ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
        function highlightSearchTerm(text, searchTerm) {
            if (!text || !searchTerm) return text;
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // Ê∏ÖÈô§ÊêúÁ¥¢
        function clearSearch() {
            const searchInput = document.getElementById('customerSearchInput');
            searchInput.value = '';
            
            // ÈöêËóèÊ∏ÖÈô§ÊåâÈíÆ
            document.querySelector('.clear-search-btn').style.display = 'none';
            
            // ÈáçÊñ∞Âä†ËΩΩÂÆåÊï¥Êï∞ÊçÆ
            loadTableData();
            
            // ÊÅ¢Â§çËÆ∞ÂΩïËÆ°Êï∞Ê†∑Âºè
            const countElement = document.getElementById('tableRecordCount');
            if (countElement) {
                countElement.style.color = '#666';
                countElement.style.fontWeight = '500';
            }
        }

        // Ê∑ªÂä†ÂõûËΩ¶ÈîÆÊêúÁ¥¢ÊîØÊåÅ
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('customerSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchCustomer();
                    }
                });
                
                // ÂÆûÊó∂ÊêúÁ¥¢ÔºàËæìÂÖ•Êó∂Ëá™Âä®ÊêúÁ¥¢Ôºâ
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    
                    const searchTerm = this.value.trim();
                    if (searchTerm === '') {
                        clearSearch();
                        return;
                    }
                    
                    // Âª∂ËøüÊêúÁ¥¢ÔºåÈÅøÂÖçÈ¢ëÁπÅËß¶Âèë
                    searchTimeout = setTimeout(() => {
                        if (searchTerm.length >= 1) { // Ëá≥Â∞ëËæìÂÖ•1‰∏™Â≠óÁ¨¶ÊâçÂºÄÂßãÊêúÁ¥¢
                            searchCustomer();
                        }
                    }, 300);
                });
            }
        });

        // Âà†Èô§ËÆ∞ÂΩïÔºàÊîπËøõÁâàÔºåÊîØÊåÅ‰∫ëÁ´ØÂêåÊ≠•Ôºâ
        async function deleteRecord(id) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü')) {
                // Ëé∑ÂèñË¶ÅÂà†Èô§ÁöÑËÆ∞ÂΩï‰ø°ÊÅØÔºàÁî®‰∫éÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞ÂºπÁ™óÔºâ
                const currentData = getSalesData();
                const deletedRecord = currentData.find(record => record.id === id);
                
                // Ë∞ÉÁî®Êñ∞ÁöÑÂà†Èô§ÂáΩÊï∞ÔºåÂêåÊó∂Âà†Èô§Êú¨Âú∞Âíå‰∫ëÁ´ØËÆ∞ÂΩï
                const success = await deleteSalesRecord(id);
                
                if (success) {
                    // Êõ¥Êñ∞ÁïåÈù¢
                    loadTableData();
                    updateStatistics();
                    updateSalaryDetails();
                    
                    // Â¶ÇÊûúÂΩìÂâçÂú®ÁªüËÆ°ÂàÜÊûêÊ†áÁ≠æÔºåÂàôÊõ¥Êñ∞ÁªüËÆ°
                    if (document.getElementById('statistics').classList.contains('active')) {
                        setTimeout(() => updateAllStatistics(), 50);
                    }
                    
                    // Â¶ÇÊûúÂñúÊä•ÂºπÁ™óÂΩìÂâçÊòæÁ§∫Ôºå‰∏îÂà†Èô§ÁöÑËÆ∞ÂΩïÊòØÂêå‰∏Ä‰∏™ÈîÄÂîÆ‰∫∫ÂëòÁöÑÔºåÂàôÊõ¥Êñ∞ÂºπÁ™óÁªüËÆ°
                    updateCelebrationModalIfOpen(deletedRecord);
                    
                    showToast('ËÆ∞ÂΩïÂ∑≤Âà†Èô§', 'success');
                } else {
                    showToast('Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
                }
            }
        }

        // Êõ¥Êñ∞ÂºπÁ™óÁªüËÆ°Êï∞ÊçÆÔºàÂ¶ÇÊûúÂºπÁ™óÂΩìÂâçÊòæÁ§∫Ôºâ
        function updateCelebrationModalIfOpen(deletedRecord) {
            const modal = document.getElementById('celebrationModal');
            const detailsElement = document.getElementById('celebrationDetails');
            
            // Ê£ÄÊü•ÂºπÁ™óÊòØÂê¶ÂΩìÂâçÊòæÁ§∫
            if (modal && modal.style.display === 'block' && detailsElement && deletedRecord) {
                // ‰ªéÂºπÁ™ó‰∏≠ÊèêÂèñÂΩìÂâçÊòæÁ§∫ÁöÑÈîÄÂîÆ‰∫∫ÂëòÂßìÂêç
                const currentSalesperson = extractSalespersonFromModal(detailsElement);
                
                // Â¶ÇÊûúÂà†Èô§ÁöÑËÆ∞ÂΩïÊòØÂêå‰∏Ä‰∏™ÈîÄÂîÆ‰∫∫ÂëòÁöÑÔºåÊõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
                if (currentSalesperson && deletedRecord.salesperson === currentSalesperson) {
                    refreshCelebrationModalStats(currentSalesperson, detailsElement);
                }
            }
        }

        // ‰ªéÂºπÁ™ó‰∏≠ÊèêÂèñÈîÄÂîÆ‰∫∫ÂëòÂßìÂêç
        function extractSalespersonFromModal(detailsElement) {
            // ‰ªéÊñ∞Â∏ÉÂ±ÄÁöÑÂÖ≥ÈîÆ‰ø°ÊÅØÂå∫ÂüüÊèêÂèñÈîÄÂîÆ‰∫∫ÂëòÂßìÂêç
            const salespersonElements = detailsElement.querySelectorAll('.key-info-item');
            
            for (let element of salespersonElements) {
                const label = element.querySelector('.key-label');
                const value = element.querySelector('.key-value');
                
                if (label && label.textContent.trim() === 'ÈîÄÂîÆÂëò' && value) {
                    return value.textContent.trim();
                }
            }
            return null;
        }

        // Âà∑Êñ∞ÂºπÁ™ó‰∏≠ÁöÑÁªüËÆ°Êï∞ÊçÆ
        function refreshCelebrationModalStats(salesperson, detailsElement) {
            // ÈáçÊñ∞ËÆ°ÁÆóËØ•ÈîÄÂîÆ‰∫∫ÂëòÁöÑÁªüËÆ°Êï∞ÊçÆ
            const salespersonRecords = salesData.filter(record => record.salesperson === salesperson);
            const totalAmount = salespersonRecords.reduce((sum, record) => sum + record.amount, 0);
            const totalDeals = salespersonRecords.length;
            const avgDealAmount = totalDeals > 0 ? totalAmount / totalDeals : 0;
            
            // ËÆ°ÁÆóÊú¨Êúà‰∏öÁª©
            const currentMonth = new Date().toISOString().substring(0, 7);
            const monthRecords = salespersonRecords.filter(record => record.date.startsWith(currentMonth));
            const monthAmount = monthRecords.reduce((sum, record) => sum + record.amount, 0);
            const monthDeals = monthRecords.length;
            
            // Êõ¥Êñ∞Êñ∞ÂûÇÁõ¥Â∏ÉÂ±Ä‰∏ãÁöÑÁªüËÆ°Êï∞ÊçÆÊòæÁ§∫
            const statsElements = {
                // ÂéÜÂè≤ÊÄª‰∏öÁª©Êï∞ÊçÆ
                totalAmount: detailsElement.querySelector('.celebration-column:nth-child(2) .stat-number'),
                totalDeals: detailsElement.querySelector('.celebration-column:nth-child(2) .stat-small:nth-child(1) .stat-small-num'),
                avgDeal: detailsElement.querySelector('.celebration-column:nth-child(2) .stat-small:nth-child(2) .stat-small-num'),
                // Êú¨Êúà‰∏öÁª©Êï∞ÊçÆ
                monthAmount: detailsElement.querySelector('.celebration-column:nth-child(3) .stat-number'),
                monthDeals: detailsElement.querySelector('.celebration-column:nth-child(3) .stat-small:nth-child(1) .stat-small-num'),
                completion: detailsElement.querySelector('.celebration-column:nth-child(3) .stat-small:nth-child(2) .stat-small-num')
            };
            
            // Êõ¥Êñ∞ÊòæÁ§∫ÁöÑÊï∞ÂÄº
            if (statsElements.totalAmount) statsElements.totalAmount.textContent = `¬•${totalAmount.toLocaleString()}`;
            if (statsElements.totalDeals) statsElements.totalDeals.textContent = totalDeals;
            if (statsElements.avgDeal) statsElements.avgDeal.textContent = `¬•${avgDealAmount.toLocaleString()}`;
            if (statsElements.monthAmount) statsElements.monthAmount.textContent = `¬•${monthAmount.toLocaleString()}`;
            if (statsElements.monthDeals) statsElements.monthDeals.textContent = monthDeals;
            if (statsElements.completion) {
                const completionRate = totalDeals > 0 ? ((monthDeals / totalDeals) * 100).toFixed(1) : 0;
                statsElements.completion.textContent = `${completionRate}%`;
            }
            
            console.log(`‚úÖ Â∑≤Êõ¥Êñ∞ÂºπÁ™ó‰∏≠ ${salesperson} ÁöÑÁªüËÆ°Êï∞ÊçÆ`);
        }

        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStatistics() {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().toISOString().substring(0, 7);
            
            const todayRecords = salesData.filter(record => record.date === today);
            const monthRecords = salesData.filter(record => record.date.startsWith(currentMonth));
            
            const todayTotal = todayRecords.reduce((sum, record) => sum + record.amount, 0);
            const monthTotal = monthRecords.reduce((sum, record) => sum + record.amount, 0);
            
            document.getElementById('todayTotal').textContent = `¬•${todayTotal.toFixed(2)}`;
            document.getElementById('monthTotal').textContent = `¬•${monthTotal.toFixed(2)}`;
            document.getElementById('recordCount').textContent = salesData.length;
        }

        // Êõ¥Êñ∞ÊâÄÊúâÁªüËÆ°ÂàÜÊûê
        function updateAllStatistics() {
            updateKPICards();
            updateTrendAnalysis();
            updateChartVisualizations();
            updateSmartInsights();
        }

        // Êó∂Èó¥Âë®ÊúüÈÄâÊã©Âô®
        function updateAnalyticsPeriod() {
            const period = document.getElementById('analyticsPeriod').value;
            console.log('ÂàáÊç¢ÂàÜÊûêÂë®Êúü:', period);
            updateAllStatistics();
        }

        // Âç°ÁâáÂ±ïÂºÄ/ÊäòÂè†ÊéßÂà∂
        function toggleCardContent(cardId) {
            const content = document.getElementById(cardId + 'Content');
            const toggle = content.parentElement.querySelector('.card-toggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = '‚àí';
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '+';
            }
        }

        // Ëé∑ÂèñÂàÜÊûêÂë®ÊúüÊï∞ÊçÆ
        function getAnalyticsData() {
            const period = document.getElementById('analyticsPeriod')?.value || 'month';
            const now = new Date();
            let startDate;
            
            switch (period) {
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'quarter':
                    const quarterStart = Math.floor(now.getMonth() / 3) * 3;
                    startDate = new Date(now.getFullYear(), quarterStart, 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    startDate = new Date(2000, 0, 1); // ÂÖ®ÈÉ®Êï∞ÊçÆ
            }
            
            return salesData.filter(record => new Date(record.date) >= startDate);
        }

        // 1. Êõ¥Êñ∞KPIÂç°Áâá
        function updateKPICards() {
            const currentData = getAnalyticsData();
            const previousPeriodData = getPreviousPeriodData();
            
            // ÊÄªÊî∂ÂÖ•
            const totalRevenue = currentData.reduce((sum, record) => sum + record.amount, 0);
            const prevRevenue = previousPeriodData.reduce((sum, record) => sum + record.amount, 0);
            const revenueChange = prevRevenue > 0 ? ((totalRevenue - prevRevenue) / prevRevenue * 100) : 0;
            
            document.getElementById('kpiTotalRevenue').textContent = `¬•${totalRevenue.toLocaleString()}`;
            updateKPIChange('kpiRevenueChange', revenueChange);
            
            // Êàê‰∫§Á¨îÊï∞
            const totalDeals = currentData.length;
            const prevDeals = previousPeriodData.length;
            const dealsChange = prevDeals > 0 ? ((totalDeals - prevDeals) / prevDeals * 100) : 0;
            
            document.getElementById('kpiTotalDeals').textContent = totalDeals;
            updateKPIChange('kpiDealsChange', dealsChange);
            
            // Ê¥ªË∑ÉÈîÄÂîÆ‰∫∫Âëò
            const activeSales = new Set(currentData.map(record => record.salesperson)).size;
            const prevActiveSales = new Set(previousPeriodData.map(record => record.salesperson)).size;
            const salesChange = prevActiveSales > 0 ? ((activeSales - prevActiveSales) / prevActiveSales * 100) : 0;
            
            document.getElementById('kpiActiveSales').textContent = `${activeSales}‰∫∫`;
            updateKPIChange('kpiSalesChange', salesChange);
            
            // Á∫øÁ¥¢Êàê‰∫§ÔºàËøêËê•Á∫øÁ¥¢ÂíåËøêËê•ËΩ¨‰ªãÁªçÁöÑÁªºÂêàÔºâ
            const leadSources = ['ËøêËê•Á∫øÁ¥¢', 'ËøêËê•ËΩ¨‰ªãÁªç'];
            const leadConversions = currentData.filter(record => 
                leadSources.includes(record.customerSource)
            ).length;
            const prevLeadConversions = previousPeriodData.filter(record => 
                leadSources.includes(record.customerSource)
            ).length;
            const leadChange = prevLeadConversions > 0 ? ((leadConversions - prevLeadConversions) / prevLeadConversions * 100) : 0;
            
            document.getElementById('kpiLeadConversion').textContent = `${leadConversions}Á¨î`;
            updateKPIChange('kpiLeadChange', leadChange);
            
            // Ê¨†Ê¨æÊÄªÈáëÈ¢ùÔºàÂêàÂêåÈáëÈ¢ù - Êî∂ÂÖ•ÈáëÈ¢ùÔºâ
            const unpaidAmount = currentData.reduce((sum, record) => {
                const contractAmount = record.contractAmount || record.amount;
                const receivedAmount = record.amount || 0;
                return sum + Math.max(0, contractAmount - receivedAmount);
            }, 0);
            const prevUnpaidAmount = previousPeriodData.reduce((sum, record) => {
                const contractAmount = record.contractAmount || record.amount;
                const receivedAmount = record.amount || 0;
                return sum + Math.max(0, contractAmount - receivedAmount);
            }, 0);
            const unpaidAmountChange = prevUnpaidAmount > 0 ? ((unpaidAmount - prevUnpaidAmount) / prevUnpaidAmount * 100) : 0;
            
            document.getElementById('kpiUnpaidAmount').textContent = `¬•${unpaidAmount.toLocaleString()}`;
            updateKPIChange('kpiUnpaidAmountChange', unpaidAmountChange);
            
            // Ê¨†Ê¨æÊï∞ÈáèÔºàÂêàÂêåÈáëÈ¢ùÂ§ß‰∫éÊî∂ÂÖ•ÈáëÈ¢ùÁöÑËÆ∞ÂΩïÊï∞Ôºâ
            const unpaidCount = currentData.filter(record => {
                const contractAmount = record.contractAmount || record.amount;
                const receivedAmount = record.amount || 0;
                return contractAmount > receivedAmount;
            }).length;
            const prevUnpaidCount = previousPeriodData.filter(record => {
                const contractAmount = record.contractAmount || record.amount;
                const receivedAmount = record.amount || 0;
                return contractAmount > receivedAmount;
            }).length;
            const unpaidCountChange = prevUnpaidCount > 0 ? ((unpaidCount - prevUnpaidCount) / prevUnpaidCount * 100) : 0;
            
            document.getElementById('kpiUnpaidCount').textContent = `${unpaidCount}Á¨î`;
            updateKPIChange('kpiUnpaidCountChange', unpaidCountChange);
        }
        
        function updateKPIChange(elementId, changePercent) {
            const element = document.getElementById(elementId);
            const isPositive = changePercent >= 0;
            
            element.textContent = `${isPositive ? '+' : ''}${changePercent.toFixed(1)}%`;
            element.className = `kpi-change ${isPositive ? '' : 'negative'}`;
        }
        
        function getPreviousPeriodData() {
            const period = document.getElementById('analyticsPeriod')?.value || 'month';
            const now = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'quarter':
                    const quarterStart = Math.floor(now.getMonth() / 3) * 3;
                    startDate = new Date(now.getFullYear(), quarterStart - 3, 1);
                    endDate = new Date(now.getFullYear(), quarterStart, 0);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear() - 1, 0, 1);
                    endDate = new Date(now.getFullYear() - 1, 11, 31);
                    break;
                default:
                    return []; // ÂÖ®ÈÉ®Êï∞ÊçÆÊó∂‰∏çÊØîËæÉ
            }
            
            return salesData.filter(record => {
                const date = new Date(record.date);
                return date >= startDate && date <= endDate;
            });
        }

        // 2. Êõ¥Êñ∞Ë∂ãÂäøÂàÜÊûê
        function updateTrendAnalysis() {
            updateMonthlyTrends();
            updateWeeklyTrends();
        }
        
        function updateMonthlyTrends() {
            const monthlyData = {};
            
            salesData.forEach(record => {
                const month = record.date.substring(0, 7);
                if (!monthlyData[month]) {
                    monthlyData[month] = { amount: 0, count: 0 };
                }
                monthlyData[month].amount += record.amount;
                monthlyData[month].count += 1;
            });
            
            const monthlyTrendsDiv = document.getElementById('monthlyTrends');
            monthlyTrendsDiv.innerHTML = '';
            
            const months = Object.keys(monthlyData).sort().reverse().slice(0, 6);
            if (months.length === 0) {
                monthlyTrendsDiv.innerHTML = '<div class="stat-item-compact"><span class="stat-label-compact">ÊöÇÊó†Êï∞ÊçÆ</span></div>';
                return;
            }
            
            months.forEach(month => {
                const data = monthlyData[month];
                const avg = data.count > 0 ? data.amount / data.count : 0;
                
                const statItem = document.createElement('div');
                statItem.className = 'stat-item-compact';
                statItem.innerHTML = `
                    <span class="stat-label-compact">${month}</span>
                    <div>
                        <span class="stat-value-compact">¬•${data.amount.toLocaleString()}</span>
                        <span class="stat-percentage">(${data.count}Á¨î, Âùá¬•${avg.toLocaleString()})</span>
                    </div>
                `;
                monthlyTrendsDiv.appendChild(statItem);
            });
        }
        
        function updateWeeklyTrends() {
            const currentData = getAnalyticsData();
            const period = document.getElementById('analyticsPeriod')?.value || 'month';
            
            const weeklyData = {};
            currentData.forEach(record => {
                const date = new Date(record.date);
                let weekKey;
                
                if (period === 'month') {
                    const weekNumber = Math.ceil(date.getDate() / 7);
                    weekKey = `Á¨¨${weekNumber}Âë®`;
                } else {
                    const weekOfYear = getWeekOfYear(date);
                    weekKey = `Á¨¨${weekOfYear}Âë®`;
                }
                
                if (!weeklyData[weekKey]) {
                    weeklyData[weekKey] = { amount: 0, count: 0 };
                }
                weeklyData[weekKey].amount += record.amount;
                weeklyData[weekKey].count += 1;
            });
            
            const weeklyTrendsDiv = document.getElementById('weeklyTrends');
            weeklyTrendsDiv.innerHTML = '';
            
            if (Object.keys(weeklyData).length === 0) {
                weeklyTrendsDiv.innerHTML = '<div class="stat-item-compact"><span class="stat-label-compact">ÊöÇÊó†Êï∞ÊçÆ</span></div>';
                return;
            }
            
            Object.keys(weeklyData).forEach(week => {
                const data = weeklyData[week];
                const avg = data.count > 0 ? data.amount / data.count : 0;
                
                const statItem = document.createElement('div');
                statItem.className = 'stat-item-compact';
                statItem.innerHTML = `
                    <span class="stat-label-compact">${week}</span>
                    <div>
                        <span class="stat-value-compact">¬•${data.amount.toLocaleString()}</span>
                        <span class="stat-percentage">(${data.count}Á¨î, Âùá¬•${avg.toLocaleString()})</span>
                    </div>
                `;
                weeklyTrendsDiv.appendChild(statItem);
            });
        }
        
        function getWeekOfYear(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }





        // 3. Êõ¥Êñ∞ÂõæË°®ÂèØËßÜÂåñ
        function updateChartVisualizations() {
            updatePieChart();
            updateCustomerSourceAnalysis();
            updatePerformanceRanking();
            updateUnpaidStats();
        }
        
        // È•ºÂõæ - ‰∏öÂä°Á±ªÂûãÂàÜÂ∏É
        function updatePieChart() {
            const currentData = getAnalyticsData();
            const businessTypeData = {};
            
            currentData.forEach(record => {
                businessTypeData[record.businessType] = (businessTypeData[record.businessType] || 0) + record.amount;
            });
            
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#FFB347', '#98D8C8'];
            const sortedTypes = Object.keys(businessTypeData).sort((a, b) => businessTypeData[b] - businessTypeData[a]);
            const total = Object.values(businessTypeData).reduce((sum, val) => sum + val, 0);
            
            // ÂàõÂª∫È•ºÂõæÊ∏êÂèòËâ≤
            let currentAngle = 0;
            const gradientSegments = sortedTypes.map((type, index) => {
                const percentage = (businessTypeData[type] / total) * 100;
                const angle = (percentage / 100) * 360;
                const segment = `${colors[index % colors.length]} ${currentAngle}deg ${currentAngle + angle}deg`;
                currentAngle += angle;
                return segment;
            }).join(', ');
            
            const pieChart = document.getElementById('businessTypePieChart');
            if (pieChart) {
                pieChart.style.background = `conic-gradient(from 0deg, ${gradientSegments})`;
            }
            
            // ÂàõÂª∫Âõæ‰æã
            const legend = document.getElementById('pieChartLegend');
            if (legend) {
                legend.innerHTML = sortedTypes.map((type, index) => `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${colors[index % colors.length]}"></div>
                        <span class="legend-label">${type}</span>
                        <span class="legend-value">¬•${businessTypeData[type].toLocaleString()}</span>
                    </div>
                `).join('');
            }
        }
        
        // ÂÆ¢Êà∑Êù•Ê∫êÁªüËÆ°ÂàÜÊûê
        function updateCustomerSourceAnalysis() {
            const currentData = getAnalyticsData();
            const sourceStats = {};
            const totalCustomers = currentData.length;
            
            // ÁªüËÆ°ÂêÑÊù•Ê∫êÁöÑÂÆ¢Êà∑Êï∞Èáè
            currentData.forEach(record => {
                const source = record.customerSource || 'Êú™ËÆæÁΩÆ';
                sourceStats[source] = (sourceStats[source] || 0) + 1;
            });
            
            // È¢ÑËÆæÁöÑÂÆ¢Êà∑Êù•Ê∫êÂíåÂõæÊ†á
            const sourceIcons = {
                'Ëá™ÊúâÂÆ¢Êà∑': 'üë§',
                'ËøêËê•Á∫øÁ¥¢': 'üìû', 
                'ËøêËê•ËΩ¨‰ªãÁªç': 'üîÑ',
                'ÂÆ¢Êà∑ËΩ¨‰ªãÁªç': 'ü§ù',
                'ÁÆ°ÁêÜÂÜÖÊé®': 'üëë'
            };
            
            const container = document.getElementById('customerSourceAnalysis');
            if (container) {
                if (totalCustomers === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; font-size: 14px; padding: 40px; grid-column: 1 / -1;">
                            ÊöÇÊó†ÂÆ¢Êà∑Êï∞ÊçÆ
                        </div>
                    `;
                } else {
                    // ÊåâÈ¢ÑËÆæÈ°∫Â∫èÊòæÁ§∫ÊâÄÊúâÊù•Ê∫ê
                    const allSources = ['Ëá™ÊúâÂÆ¢Êà∑', 'ËøêËê•Á∫øÁ¥¢', 'ËøêËê•ËΩ¨‰ªãÁªç', 'ÂÆ¢Êà∑ËΩ¨‰ªãÁªç', 'ÁÆ°ÁêÜÂÜÖÊé®'];
                    
                    container.innerHTML = allSources.map(source => {
                        const count = sourceStats[source] || 0;
                        const percentage = totalCustomers > 0 ? ((count / totalCustomers) * 100).toFixed(1) : '0.0';
                        const icon = sourceIcons[source] || 'üìä';
                        
                        return `
                            <div class="source-stat-card">
                                <div class="source-icon">${icon}</div>
                                <div class="source-title">${source}</div>
                                <div class="source-number">${count}</div>
                                <div class="source-percentage">${percentage}%</div>
                            </div>
                        `;
                    }).join('');
                }
            }
        }
        
        // ‰∏öÁª©ÊéíÂêç - Âõ¢Èòü‰∏öÁª©ÂØπÊØî
        function updatePerformanceRanking() {
            const currentData = getAnalyticsData();
            const salespersonData = {};
            const salespersonCount = {};
            
            currentData.forEach(record => {
                salespersonData[record.salesperson] = (salespersonData[record.salesperson] || 0) + record.amount;
                salespersonCount[record.salesperson] = (salespersonCount[record.salesperson] || 0) + 1;
            });
            
            const sortedPersons = Object.keys(salespersonData).sort((a, b) => salespersonData[b] - salespersonData[a]);
            
            const rankingContainer = document.getElementById('teamPerformanceRanking');
            if (rankingContainer) {
                if (sortedPersons.length === 0) {
                    rankingContainer.innerHTML = '<div class="ranking-empty">ÊöÇÊó†‰∏öÁª©Êï∞ÊçÆ</div>';
                    return;
                }
                
                rankingContainer.innerHTML = sortedPersons.map((person, index) => {
                    const amount = salespersonData[person];
                    const count = salespersonCount[person];
                    const ranking = index + 1;
                    
                    return `
                        <div class="ranking-item">
                            <div class="ranking-number">${ranking}</div>
                            <div class="ranking-info">
                                <div class="ranking-name">${person}</div>
                                <div class="ranking-stats">
                                    <div class="ranking-amount">¬•${amount.toLocaleString()}</div>
                                    <div class="ranking-count">${count}Á¨î</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        // Êú™Êî∂Ê¨æÁªüËÆ°
        function updateUnpaidStats() {
            const currentData = getAnalyticsData();
            const unpaidRecords = [];
            let totalUnpaid = 0;
            
            // ËÆ°ÁÆóÊú™Êî∂Ê¨æËÆ∞ÂΩï
            currentData.forEach(record => {
                const unpaidAmount = (record.contractAmount || 0) - (record.amount || 0);
                if (unpaidAmount > 0) {
                    unpaidRecords.push({
                        customer: record.customer,
                        salesperson: record.salesperson,
                        contractAmount: record.contractAmount,
                        receivedAmount: record.amount,
                        unpaidAmount: unpaidAmount,
                        date: record.date
                    });
                    totalUnpaid += unpaidAmount;
                }
            });
            
            // ÊåâÊú™Êî∂Ê¨æÈáëÈ¢ùÊéíÂ∫è
            unpaidRecords.sort((a, b) => b.unpaidAmount - a.unpaidAmount);
            
            const container = document.getElementById('unpaidStats');
            if (container) {
                if (unpaidRecords.length === 0) {
                    container.innerHTML = `
                        <div class="unpaid-summary">
                            <div class="unpaid-total">¬•0</div>
                            <div class="unpaid-label">ÊÅ≠ÂñúÔºÅÊó†Êú™Êî∂Ê¨æÈ°π</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="unpaid-summary">
                            <div class="unpaid-total">¬•${totalUnpaid.toLocaleString()}</div>
                            <div class="unpaid-label">ÊÄªÊú™Êî∂Ê¨æÈáëÈ¢ù ‚Ä¢ ${unpaidRecords.length}‰∏™ÂÆ¢Êà∑</div>
                        </div>
                        ${unpaidRecords.slice(0, 8).map(record => `
                            <div class="unpaid-detail">
                                <div class="unpaid-customer">${record.customer} (${record.salesperson})</div>
                                <div class="unpaid-amounts">
                                    <span class="contract-amount">ÂêàÂêå: ¬•${record.contractAmount.toLocaleString()}</span>
                                    <span class="received-amount">Â∑≤Êî∂: ¬•${record.receivedAmount.toLocaleString()}</span>
                                    <span class="unpaid-amount">Êú™Êî∂: ¬•${record.unpaidAmount.toLocaleString()}</span>
                                </div>
                            </div>
                        `).join('')}
                        ${unpaidRecords.length > 8 ? `<div style="text-align: center; color: #666; font-size: 12px; margin-top: 10px;">ËøòÊúâ ${unpaidRecords.length - 8} ‰∏™ÂÆ¢Êà∑...</div>` : ''}
                    `;
                }
            }
        }
        

        
        // Ëé∑ÂèñÂàÜÊûêÂë®ÊúüÊï∞ÊçÆÁöÑËæÖÂä©ÂáΩÊï∞
        function getAnalyticsData() {
            const period = document.getElementById('analyticsPeriod')?.value || 'month';
            const now = new Date();
            
            switch (period) {
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return salesData.filter(record => new Date(record.date) >= weekAgo);
                    
                case 'month':
                    const currentMonth = now.toISOString().substring(0, 7);
                    return salesData.filter(record => record.date.startsWith(currentMonth));
                    
                case 'quarter':
                    const currentQuarter = Math.floor(now.getMonth() / 3) + 1;
                    const quarterStart = new Date(now.getFullYear(), (currentQuarter - 1) * 3, 1);
                    return salesData.filter(record => new Date(record.date) >= quarterStart);
                    
                case 'year':
                    const currentYear = now.getFullYear().toString();
                    return salesData.filter(record => record.date.startsWith(currentYear));
                    
                case 'all':
                default:
                    return salesData;
            }
        }
        
        // Ëé∑Âèñ‰∏ä‰∏ÄÂë®ÊúüÊï∞ÊçÆÁî®‰∫éÂØπÊØî
        function getPreviousPeriodData() {
            const period = document.getElementById('analyticsPeriod')?.value || 'month';
            const now = new Date();
            
            switch (period) {
                case 'week':
                    const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
                    const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return salesData.filter(record => {
                        const recordDate = new Date(record.date);
                        return recordDate >= twoWeeksAgo && recordDate < oneWeekAgo;
                    });
                    
                case 'month':
                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const lastMonthStr = lastMonth.toISOString().substring(0, 7);
                    return salesData.filter(record => record.date.startsWith(lastMonthStr));
                    
                case 'quarter':
                    const currentQuarter = Math.floor(now.getMonth() / 3) + 1;
                    const lastQuarter = currentQuarter === 1 ? 4 : currentQuarter - 1;
                    const lastQuarterYear = currentQuarter === 1 ? now.getFullYear() - 1 : now.getFullYear();
                    const lastQuarterStart = new Date(lastQuarterYear, (lastQuarter - 1) * 3, 1);
                    const lastQuarterEnd = new Date(lastQuarterYear, lastQuarter * 3, 0);
                    return salesData.filter(record => {
                        const recordDate = new Date(record.date);
                        return recordDate >= lastQuarterStart && recordDate <= lastQuarterEnd;
                    });
                    
                case 'year':
                    const lastYear = (now.getFullYear() - 1).toString();
                    return salesData.filter(record => record.date.startsWith(lastYear));
                    
                case 'all':
                default:
                    return [];
            }
        }

        // 4. Êõ¥Êñ∞Êô∫ËÉΩÊ¥ûÂØü
        function updateSmartInsights() {
            const currentData = getAnalyticsData();
            const previousData = getPreviousPeriodData();
            const insights = [];
            
            if (currentData.length === 0) {
                insights.push({
                    icon: 'üìä',
                    text: 'ÊöÇÊó†Êï∞ÊçÆÔºåËØ∑Ê∑ªÂä†ÈîÄÂîÆËÆ∞ÂΩïÂºÄÂßãÂàÜÊûê'
                });
            } else {
                // Âü∫‰∫éÊ†∏ÂøÉ‰∏öÁª©ÊåáÊ†áËøõË°åÊ∑±Â∫¶ÂàÜÊûê
                const kpiData = calculateKPIData(currentData);
                const prevKpiData = calculateKPIData(previousData);
                
                // 1. ÊÄªÊî∂ÂÖ•ÂàÜÊûê
                const revenueGrowth = prevKpiData.totalRevenue > 0 ? 
                    ((kpiData.totalRevenue - prevKpiData.totalRevenue) / prevKpiData.totalRevenue * 100) : 0;
                    
                if (revenueGrowth > 30) {
                    insights.push({
                        icon: 'üöÄ',
                        text: `ÊÄªÊî∂ÂÖ•Êö¥Ê∂® ${revenueGrowth.toFixed(1)}%ÔºÅ‰∏öÁª©ÁàÜÂèëÂºèÂ¢ûÈïøÔºåÂª∫ËÆÆËøÖÈÄüÊâ©Â§ßÂõ¢ÈòüËßÑÊ®°ÔºåÊä¢Âç†Â∏ÇÂú∫‰ªΩÈ¢ù„ÄÇ`
                    });
                } else if (revenueGrowth > 15) {
                    insights.push({
                        icon: 'üìà',
                        text: `ÊÄªÊî∂ÂÖ•Âº∫Âä≤Â¢ûÈïø ${revenueGrowth.toFixed(1)}%ÔºåÂèëÂ±ïÂäøÂ§¥ËâØÂ•Ω„ÄÇÂª∫ËÆÆÂä†Â§ß‰ºòË¥®Ê∏†ÈÅìÊäïÂÖ•ÔºåÂ∑©Âõ∫Â¢ûÈïøÂü∫Á°Ä„ÄÇ`
                    });
                } else if (revenueGrowth > 0) {
                    insights.push({
                        icon: '‚úÖ',
                        text: `ÊÄªÊî∂ÂÖ•Ê∏©ÂíåÂ¢ûÈïø ${revenueGrowth.toFixed(1)}%Ôºå‰øùÊåÅÁ®≥ÂÆö„ÄÇÂª∫ËÆÆÂàÜÊûêÂ¢ûÈïøÁì∂È¢àÔºåÂØªÊâæÊñ∞ÁöÑÁ™ÅÁ†¥ÁÇπ„ÄÇ`
                    });
                } else if (revenueGrowth < -10) {
                    insights.push({
                        icon: 'üî•',
                        text: `ÊÄªÊî∂ÂÖ•‰∏ãÈôç ${Math.abs(revenueGrowth).toFixed(1)}%ÔºåÈúÄÁ¥ßÊÄ•Ë°åÂä®ÔºÅÂª∫ËÆÆÁ´ãÂç≥Âè¨ÂºÄ‰∏öÂä°Â§çÁõò‰ºöËÆÆÔºåÂà∂ÂÆöÊåΩÂõûÁ≠ñÁï•„ÄÇ`
                    });
                }
                
                // 2. Êàê‰∫§Á¨îÊï∞ÂàÜÊûê
                const dealGrowth = prevKpiData.totalDeals > 0 ? 
                    ((kpiData.totalDeals - prevKpiData.totalDeals) / prevKpiData.totalDeals * 100) : 0;
                    
                if (kpiData.totalDeals === 0) {
                    insights.push({
                        icon: '‚ö†Ô∏è',
                        text: 'Êàê‰∫§Á¨îÊï∞‰∏∫Èõ∂Ôºå‰∏öÂä°ÂÅúÊªûÔºÅÂª∫ËÆÆÁ´ãÂç≥ÂêØÂä®ÂÆ¢Êà∑ÂºÄÂèëËÆ°ÂàíÔºåÊøÄÊ¥ªÈîÄÂîÆÊ¥ªÂä®„ÄÇ'
                    });
                } else if (dealGrowth > 20) {
                    insights.push({
                        icon: 'üéØ',
                        text: `Êàê‰∫§Á¨îÊï∞ÊøÄÂ¢û ${dealGrowth.toFixed(1)}%ÔºåÂÆ¢Êà∑ÂºÄÂèëÊàêÊïàÊòæËëó„ÄÇÂª∫ËÆÆ‰ºòÂåñÊàê‰∫§ÊµÅÁ®ãÔºåÊèêÂçáËΩ¨ÂåñÊïàÁéá„ÄÇ`
                    });
                } else if (dealGrowth < -15) {
                    insights.push({
                        icon: 'üìû',
                        text: `Êàê‰∫§Á¨îÊï∞ÂáèÂ∞ë ${Math.abs(dealGrowth).toFixed(1)}%ÔºåÂÆ¢Êà∑ÂºÄÂèë‰πèÂäõ„ÄÇÂª∫ËÆÆÂä†Âº∫Á∫øÁ¥¢Ëé∑ÂèñÔºåÊèêÂçáË∑üËøõÈ¢ëÁéá„ÄÇ`
                    });
                }
                
                // 3. Ê¥ªË∑ÉÈîÄÂîÆÂàÜÊûê
                if (kpiData.activeSalespeople === 0) {
                    insights.push({
                        icon: 'üö®',
                        text: 'Âõ¢ÈòüÊó†Ê¥ªË∑ÉÈîÄÂîÆ‰∫∫ÂëòÔºåÁªÑÁªáËøêËΩ¨ÂºÇÂ∏∏ÔºÅÂª∫ËÆÆÁ´ãÂç≥Ê£ÄÊü•Âõ¢ÈòüÁä∂ÊÄÅÔºåÈáçÊñ∞ÊøÄÊ¥ªÈîÄÂîÆÂä®Âäõ„ÄÇ'
                    });
                } else if (kpiData.activeSalespeople === 1) {
                    insights.push({
                        icon: '‚ö°',
                        text: '‰ªÖ1‰∫∫Ê¥ªË∑ÉÈîÄÂîÆÔºåÂõ¢Èòü‰æùËµñÈ£éÈô©È´ò„ÄÇÂª∫ËÆÆÂä†Âº∫Âõ¢ÈòüÂüπËÆ≠ÔºåÊèêÂçáÊï¥‰ΩìÂèÇ‰∏éÂ∫¶„ÄÇ'
                    });
                } else if (kpiData.activeSalespeople >= 5) {
                    insights.push({
                        icon: 'üë•',
                        text: `${kpiData.activeSalespeople}‰∫∫Ê¥ªË∑ÉÈîÄÂîÆÔºåÂõ¢ÈòüÂä®ÂäõÂÖÖÊ≤õÔºÅÂª∫ËÆÆËÆæÁΩÆÂõ¢ÈòüÁ´ûËµõÔºåËøõ‰∏ÄÊ≠•ÊøÄÂèëÊΩúËÉΩ„ÄÇ`
                    });
                }
                
                // 4. Á∫øÁ¥¢Êàê‰∫§ÂàÜÊûêÔºàËøêËê•Á∫øÁ¥¢+ËøêËê•ËΩ¨‰ªãÁªçÔºâ
                const leadConversionRate = kpiData.totalDeals > 0 ? (kpiData.leadDeals / kpiData.totalDeals * 100) : 0;
                
                if (leadConversionRate > 60) {
                    insights.push({
                        icon: 'üéñÔ∏è',
                        text: `Á∫øÁ¥¢Êàê‰∫§Âç†ÊØî ${leadConversionRate.toFixed(1)}%ÔºåËøêËê•ÊïàÊûú‰ºòÁßÄÔºÅÂª∫ËÆÆÊâ©Â§ßÁ∫øÁ¥¢ÊäïÂÖ•ÔºåÊîæÂ§ßËøêËê•‰ºòÂäø„ÄÇ`
                    });
                } else if (leadConversionRate > 30) {
                    insights.push({
                        icon: 'üåü',
                        text: `Á∫øÁ¥¢Êàê‰∫§Âç†ÊØî ${leadConversionRate.toFixed(1)}%ÔºåËøêËê•Ë¥°ÁåÆÁ®≥ÂÆö„ÄÇÂª∫ËÆÆ‰ºòÂåñÁ∫øÁ¥¢Ë¥®ÈáèÔºåÊèêÂçáËΩ¨ÂåñÁ≤æÂ∫¶„ÄÇ`
                    });
                } else if (leadConversionRate < 10) {
                    insights.push({
                        icon: 'üîç',
                        text: `Á∫øÁ¥¢Êàê‰∫§Âç†ÊØî‰ªÖ ${leadConversionRate.toFixed(1)}%ÔºåËøêËê•ÊïàÊûúÂæÖÊèêÂçá„ÄÇÂª∫ËÆÆÈáçÊñ∞ËØÑ‰º∞Á∫øÁ¥¢Ê∏†ÈÅìË¥®Èáè„ÄÇ`
                    });
                }
                
                // 5. Ê¨†Ê¨æÈ£éÈô©ÂàÜÊûê
                const debtRatio = kpiData.totalRevenue > 0 ? (kpiData.totalDebt / kpiData.totalRevenue * 100) : 0;
                
                if (kpiData.totalDebt === 0) {
                    insights.push({
                        icon: 'üíé',
                        text: 'Êó†Ê¨†Ê¨æËÆ∞ÂΩïÔºåËµÑÈáëÂõûÊî∂ÂÆåÁæéÔºÅË¥¢Âä°ÂÅ•Â∫∑Áä∂ÂÜµ‰ºòÁßÄÔºåÁé∞ÈáëÊµÅÂÖÖÊ≤õ„ÄÇ'
                    });
                } else if (debtRatio > 50) {
                    insights.push({
                        icon: '‚ö†Ô∏è',
                        text: `Ê¨†Ê¨æÊØî‰æãÈ´òËææ ${debtRatio.toFixed(1)}%ÔºåËµÑÈáëÈ£éÈô©‰∏•ÈáçÔºÅÂª∫ËÆÆÁ´ãÂç≥ÂêØÂä®ÂÇ¨Êî∂ËÆ°ÂàíÔºåÂä†Âº∫ÂêàÂêå‰ªòÊ¨æÊù°Ê¨æ„ÄÇ`
                    });
                } else if (debtRatio > 30) {
                    insights.push({
                        icon: 'üí∞',
                        text: `Ê¨†Ê¨æÊØî‰æã ${debtRatio.toFixed(1)}%ÔºåÈúÄÂÖ≥Ê≥®ÂõûÊ¨æËøõÂ∫¶„ÄÇÂª∫ËÆÆ‰ºòÂåñ‰ªòÊ¨æÊµÅÁ®ãÔºåÊèêÂçáÂÆ¢Êà∑‰ªòÊ¨æ‰ΩìÈ™å„ÄÇ`
                    });
                } else if (debtRatio < 15) {
                    insights.push({
                        icon: '‚ú®',
                        text: `Ê¨†Ê¨æÊØî‰æã‰ªÖ ${debtRatio.toFixed(1)}%ÔºåÂõûÊ¨æÁÆ°ÁêÜËâØÂ•Ω„ÄÇË¥¢Âä°È£éÈô©ÊéßÂà∂‰ºòÁßÄÔºåÂÄºÂæóÁª¥ÊåÅ„ÄÇ`
                    });
                }
                
                // 6. Âπ≥ÂùáËÆ¢Âçï‰ª∑ÂÄºÂàÜÊûê
                const avgOrderValue = kpiData.totalDeals > 0 ? kpiData.totalRevenue / kpiData.totalDeals : 0;
                
                if (avgOrderValue > 50000) {
                    insights.push({
                        icon: 'üëë',
                        text: `Âπ≥ÂùáËÆ¢Âçï‰ª∑ÂÄºËææ ¬•${avgOrderValue.toLocaleString()}ÔºåÈ´òÁ´ØÂÆ¢Êà∑ÈõÜ‰∏≠„ÄÇÂª∫ËÆÆÊ∑±ËÄïÂ§ßÂÆ¢Êà∑Â∏ÇÂú∫ÔºåÊèê‰æõÂÆöÂà∂ÂåñÊúçÂä°„ÄÇ`
                    });
                } else if (avgOrderValue > 20000) {
                    insights.push({
                        icon: 'üíº',
                        text: `Âπ≥ÂùáËÆ¢Âçï‰ª∑ÂÄº ¬•${avgOrderValue.toLocaleString()}Ôºå‰∏≠È´òÁ´ØÂÆ¢Êà∑‰∏∫‰∏ª„ÄÇÂª∫ËÆÆÂπ≥Ë°°ÂèëÂ±ïÔºåÊâ©Â§ßÂÆ¢Êà∑Áæ§‰Ωì„ÄÇ`
                    });
                } else if (avgOrderValue < 5000) {
                    insights.push({
                        icon: 'üìà',
                        text: `Âπ≥ÂùáËÆ¢Âçï‰ª∑ÂÄº‰ªÖ ¬•${avgOrderValue.toLocaleString()}ÔºåÂÆ¢Âçï‰ª∑ÂÅè‰Ωé„ÄÇÂª∫ËÆÆÂºÄÂèëÈ´ò‰ª∑ÂÄº‰∫ßÂìÅÔºåÊèêÂçáÂÆ¢Âçï‰ª∑„ÄÇ`
                    });
                }
                
                // 7. ÁªºÂêàÂÅ•Â∫∑Â∫¶ËØÑ‰º∞
                const healthScore = calculateBusinessHealthScore(kpiData, revenueGrowth, dealGrowth);
                
                if (healthScore >= 85) {
                    insights.push({
                        icon: 'üèÜ',
                        text: `‰∏öÂä°ÂÅ•Â∫∑Â∫¶ ${healthScore}ÂàÜÔºåË°®Áé∞ÂçìË∂äÔºÅÂª∫ËÆÆ‰øùÊåÅÂΩìÂâçÁ≠ñÁï•ÔºåÈÄÇÂ∫¶Êâ©Âº†ËßÑÊ®°ÔºåÂ∑©Âõ∫Á´û‰∫â‰ºòÂäø„ÄÇ`
                    });
                } else if (healthScore >= 70) {
                    insights.push({
                        icon: 'üí™',
                        text: `‰∏öÂä°ÂÅ•Â∫∑Â∫¶ ${healthScore}ÂàÜÔºåËøêËê•ËâØÂ•Ω„ÄÇÂª∫ËÆÆÈáçÁÇπ‰ºòÂåñËñÑÂº±ÁéØËäÇÔºåÊèêÂçáÊï¥‰ΩìÊ∞¥Âπ≥„ÄÇ`
                    });
                } else if (healthScore >= 50) {
                    insights.push({
                        icon: '‚öñÔ∏è',
                        text: `‰∏öÂä°ÂÅ•Â∫∑Â∫¶ ${healthScore}ÂàÜÔºåÂèëÂ±ïÂπ≥Á®≥„ÄÇÂª∫ËÆÆÂà∂ÂÆöÊîπËøõËÆ°ÂàíÔºåÈáçÁÇπÁ™ÅÁ†¥ÂÖ≥ÈîÆÊåáÊ†á„ÄÇ`
                    });
                } else {
                    insights.push({
                        icon: 'üîß',
                        text: `‰∏öÂä°ÂÅ•Â∫∑Â∫¶ ${healthScore}ÂàÜÔºåÈúÄË¶ÅÊîπËøõÔºÅÂª∫ËÆÆÂÖ®Èù¢ÂÆ°ËßÜ‰∏öÂä°ÊµÅÁ®ãÔºåÂà∂ÂÆöÁ¥ßÊÄ•‰ºòÂåñÊñπÊ°à„ÄÇ`
                    });
                }
                
                // 8. ÂÆ¢Êà∑Êù•Ê∫ê‰ª∑ÂÄºÂàÜÊûê
                const sourceAnalysis = analyzeCustomerSources(currentData);
                if (sourceAnalysis.bestSource) {
                    insights.push({
                        icon: 'üéØ',
                        text: `${sourceAnalysis.bestSource}ÊòØÈªÑÈáëÊ∏†ÈÅìÔºåË¥°ÁåÆ ${sourceAnalysis.bestSourcePercent}% ‰∏öÁª©„ÄÇÂª∫ËÆÆÂä†Â§ßÊäïÂÖ•ÔºåÊ∑±Â∫¶ÊåñÊéò„ÄÇ`
                    });
                }
                
                // 9. ‰∏öÂä°ÁªìÊûÑÈ£éÈô©È¢ÑË≠¶
                const businessRisk = analyzeBusinessRisk(currentData);
                if (businessRisk.isHighRisk) {
                    insights.push({
                        icon: '‚ö†Ô∏è',
                        text: `${businessRisk.dominantType}‰∏öÂä°Âç†ÊØîËøáÈ´ò(${businessRisk.dominantPercent}%)ÔºåÂ≠òÂú®ÈõÜ‰∏≠È£éÈô©„ÄÇÂª∫ËÆÆÂàÜÊï£‰∏öÂä°ÁªìÊûÑ„ÄÇ`
                    });
                }
            }
            
            const smartInsightsDiv = document.getElementById('smartInsights');
            smartInsightsDiv.innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <span class="insight-icon">${insight.icon}</span>
                    <span class="insight-text">${insight.text}</span>
                </div>
            `).join('');
        }

        // ËÆ°ÁÆóKPIÊï∞ÊçÆÁöÑËæÖÂä©ÂáΩÊï∞
        function calculateKPIData(data) {
            if (!data || data.length === 0) {
                return {
                    totalRevenue: 0,
                    totalDeals: 0,
                    activeSalespeople: 0,
                    leadDeals: 0,
                    totalDebt: 0,
                    debtCount: 0
                };
            }

            const totalRevenue = data.reduce((sum, record) => sum + record.amount, 0);
            const totalDeals = data.length;
            
            // Ê¥ªË∑ÉÈîÄÂîÆ‰∫∫ÂëòÊï∞Èáè
            const salespeople = new Set();
            data.forEach(record => salespeople.add(record.salesperson));
            const activeSalespeople = salespeople.size;
            
            // Á∫øÁ¥¢Êàê‰∫§Êï∞ÈáèÔºàËøêËê•Á∫øÁ¥¢+ËøêËê•ËΩ¨‰ªãÁªçÔºâ
            const leadDeals = data.filter(record => {
                const source = record.customerSource || '';
                return source.includes('ËøêËê•Á∫øÁ¥¢') || source.includes('ËøêËê•ËΩ¨‰ªãÁªç');
            }).length;
            
            // Ê¨†Ê¨æÁªüËÆ°
            let totalDebt = 0;
            let debtCount = 0;
            data.forEach(record => {
                const debt = (record.contractAmount || 0) - (record.amount || 0);
                if (debt > 0) {
                    totalDebt += debt;
                    debtCount++;
                }
            });

            return {
                totalRevenue,
                totalDeals,
                activeSalespeople,
                leadDeals,
                totalDebt,
                debtCount
            };
        }

        // ËÆ°ÁÆó‰∏öÂä°ÂÅ•Â∫∑Â∫¶ËØÑÂàÜ
        function calculateBusinessHealthScore(kpiData, revenueGrowth, dealGrowth) {
            let score = 50; // Âü∫Á°ÄÂàÜ

            // Êî∂ÂÖ•Â¢ûÈïøËØÑÂàÜ (30ÂàÜ)
            if (revenueGrowth > 20) score += 30;
            else if (revenueGrowth > 10) score += 20;
            else if (revenueGrowth > 0) score += 10;
            else if (revenueGrowth > -10) score += 5;
            else score -= 10;

            // Êàê‰∫§Á¨îÊï∞ËØÑÂàÜ (20ÂàÜ)
            if (dealGrowth > 15) score += 20;
            else if (dealGrowth > 5) score += 15;
            else if (dealGrowth > 0) score += 10;
            else if (dealGrowth > -10) score += 5;
            else score -= 10;

            // Âõ¢ÈòüÊ¥ªË∑ÉÂ∫¶ËØÑÂàÜ (20ÂàÜ)
            if (kpiData.activeSalespeople >= 5) score += 20;
            else if (kpiData.activeSalespeople >= 3) score += 15;
            else if (kpiData.activeSalespeople >= 2) score += 10;
            else if (kpiData.activeSalespeople >= 1) score += 5;
            else score -= 20;

            // Ê¨†Ê¨æÈ£éÈô©ËØÑÂàÜ (20ÂàÜ)
            const debtRatio = kpiData.totalRevenue > 0 ? (kpiData.totalDebt / kpiData.totalRevenue) : 0;
            if (debtRatio === 0) score += 20;
            else if (debtRatio < 0.1) score += 15;
            else if (debtRatio < 0.3) score += 10;
            else if (debtRatio < 0.5) score += 5;
            else score -= 10;

            // Á∫øÁ¥¢ËΩ¨ÂåñËØÑÂàÜ (10ÂàÜ)
            const leadConversionRate = kpiData.totalDeals > 0 ? (kpiData.leadDeals / kpiData.totalDeals) : 0;
            if (leadConversionRate > 0.5) score += 10;
            else if (leadConversionRate > 0.3) score += 8;
            else if (leadConversionRate > 0.1) score += 5;
            else score += 2;

            return Math.max(0, Math.min(100, Math.round(score)));
        }

        // ÂàÜÊûêÂÆ¢Êà∑Êù•Ê∫ê‰ª∑ÂÄº
        function analyzeCustomerSources(data) {
            const sources = {};
            let totalRevenue = 0;

            data.forEach(record => {
                const source = record.customerSource || 'Êú™ËÆæÁΩÆ';
                sources[source] = (sources[source] || 0) + record.amount;
                totalRevenue += record.amount;
            });

            if (totalRevenue === 0 || Object.keys(sources).length === 0) {
                return { bestSource: null, bestSourcePercent: 0 };
            }

            const sortedSources = Object.keys(sources).sort((a, b) => sources[b] - sources[a]);
            const bestSource = sortedSources[0];
            const bestSourcePercent = ((sources[bestSource] / totalRevenue) * 100).toFixed(1);

            // Âè™ÊúâÂΩìÊúÄ‰Ω≥Êù•Ê∫ê‰∏çÊòØ"Êú™ËÆæÁΩÆ"‰∏îÂç†ÊØîË∂ÖËøá15%Êó∂ÊâçÊé®Ëçê
            if (bestSource !== 'Êú™ËÆæÁΩÆ' && parseFloat(bestSourcePercent) > 15) {
                return { bestSource, bestSourcePercent };
            }

            return { bestSource: null, bestSourcePercent: 0 };
        }

        // ÂàÜÊûê‰∏öÂä°ÁªìÊûÑÈ£éÈô©
        function analyzeBusinessRisk(data) {
            const businessTypes = {};
            let totalRevenue = 0;

            data.forEach(record => {
                businessTypes[record.businessType] = (businessTypes[record.businessType] || 0) + record.amount;
                totalRevenue += record.amount;
            });

            if (totalRevenue === 0 || Object.keys(businessTypes).length === 0) {
                return { isHighRisk: false, dominantType: null, dominantPercent: 0 };
            }

            const sortedTypes = Object.keys(businessTypes).sort((a, b) => businessTypes[b] - businessTypes[a]);
            const dominantType = sortedTypes[0];
            const dominantPercent = ((businessTypes[dominantType] / totalRevenue) * 100).toFixed(1);

            // ÂΩìÊüê‰∏Ä‰∏öÂä°Á±ªÂûãÂç†ÊØîË∂ÖËøá70%Êó∂ËÆ§‰∏∫ÊòØÈ´òÈ£éÈô©
            const isHighRisk = parseFloat(dominantPercent) > 70;

            return { isHighRisk, dominantType, dominantPercent };
        }

        // Êõ¥Êñ∞Â∑•ËµÑËÆ°ÁÆó
        function updateSalaryDetails() {
            const currentMonth = new Date().toISOString().substring(0, 7);
            const monthRecords = salesData.filter(record => record.date.startsWith(currentMonth));
            
            const salaryData = {};
            
            // ÂàùÂßãÂåñÊâÄÊúâÈîÄÂîÆ‰∫∫ÂëòÁöÑÊï∞ÊçÆ
            systemSettings.salespeople.forEach(person => {
                salaryData[person.name] = {
                        totalSales: 0,
                    baseSalary: person.baseSalary,
                    commissionType: person.commissionType,
                    fixedRate: person.fixedRate || 0,
                    ladderRates: person.ladderRates || [],
                        commission: 0,
                        totalSalary: 0
                    };
            });
            
            // ÁªüËÆ°ÈîÄÂîÆÈ¢ù
            monthRecords.forEach(record => {
                if (salaryData[record.salesperson]) {
                salaryData[record.salesperson].totalSales += record.amount;
                }
            });
            
            // ËÆ°ÁÆóÊèêÊàêÂíåÊÄªÂ∑•ËµÑ
            Object.keys(salaryData).forEach(person => {
                const data = salaryData[person];
                
                if (data.commissionType === 'ladder' && data.ladderRates.length > 0) {
                    // Èò∂Ê¢ØÂºèÊèêÊàêËÆ°ÁÆó
                    data.commission = calculateLadderCommission(data.totalSales, data.ladderRates);
                } else {
                    // Âõ∫ÂÆöÊØî‰æãÊèêÊàê
                    data.commission = data.totalSales * data.fixedRate;
                }
                
                data.totalSalary = data.baseSalary + data.commission;
            });
            
            const salaryDetailsDiv = document.getElementById('salaryDetails');
            salaryDetailsDiv.innerHTML = '';
            
            Object.keys(salaryData).forEach(person => {
                const data = salaryData[person];
                let commissionText = '';
                let commissionDetail = '';
                
                if (data.commissionType === 'ladder') {
                    commissionText = 'Èò∂Ê¢ØÂºè';
                    // ÁîüÊàêÈò∂Ê¢ØÂºèÊèêÊàêËÆ°ÁÆóËØ¶ÊÉÖ
                    if (data.totalSales > 0 && data.ladderRates.length > 0) {
                        const ladderDetails = calculateLadderCommissionDetails(data.totalSales, data.ladderRates);
                        commissionDetail = `<div style="font-size: 12px; color: #666; margin-top: 5px;">${ladderDetails}</div>`;
                    }
                } else {
                    commissionText = `${(data.fixedRate*100).toFixed(1)}%`;
                }
                
                const detailDiv = document.createElement('div');
                detailDiv.style.marginBottom = '20px';
                detailDiv.style.padding = '15px';
                detailDiv.style.backgroundColor = '#f8f9fa';
                detailDiv.style.borderRadius = '8px';
                detailDiv.innerHTML = `
                    <h4>${person}</h4>
                    <div class="stat-item">
                        <span class="stat-label">ÈîÄÂîÆ‰∏öÁª©:</span>
                        <span class="stat-value">¬•${data.totalSales.toFixed(2)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Âü∫Á°ÄÂ∑•ËµÑ:</span>
                        <span class="stat-value">¬•${data.baseSalary.toFixed(2)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ÊèêÊàê (${commissionText}):</span>
                        <span class="stat-value">¬•${data.commission.toFixed(2)}</span>
                    </div>
                    ${commissionDetail}
                    <div class="stat-item">
                        <span class="stat-label">ÊÄªÂ∑•ËµÑ:</span>
                        <span class="stat-value" style="font-size: 1.2em; color: #4CAF50;">¬•${data.totalSalary.toFixed(2)}</span>
                    </div>
                `;
                salaryDetailsDiv.appendChild(detailDiv);
            });
        }
        
        // ËÆ°ÁÆóÈò∂Ê¢ØÂºèÊèêÊàêÔºàÁ¥ØËøõÂºèËÆ°ÁÆóÔºâ
        function calculateLadderCommission(totalSales, ladderRates) {
            if (!ladderRates || ladderRates.length === 0) {
                return 0;
            }
            
            let commission = 0;
            
            // ÊåâÈáëÈ¢ù‰ªéÂ∞èÂà∞Â§ßÊéíÂ∫è
            const sortedRates = ladderRates.sort((a, b) => a.minAmount - b.minAmount);
            
            for (let i = 0; i < sortedRates.length; i++) {
                const current = sortedRates[i];
                const next = sortedRates[i + 1];
                
                // Â¶ÇÊûúÈîÄÂîÆÈ¢ùËøòÊ≤°ËææÂà∞ÂΩìÂâçÈò∂Ê¢ØÁöÑËµ∑ÂßãÈáëÈ¢ùÔºåË∑≥Ëøá
                if (totalSales <= current.minAmount) {
                    break;
                }
                
                // ËÆ°ÁÆóÂΩìÂâçÈò∂Ê¢ØÈÄÇÁî®ÁöÑÈáëÈ¢ù
                let applicableAmount;
                if (next) {
                    // Êúâ‰∏ã‰∏Ä‰∏™Èò∂Ê¢ØÔºåËÆ°ÁÆóÂà∞‰∏ã‰∏Ä‰∏™Èò∂Ê¢ØËµ∑ÂßãÈáëÈ¢ùÁöÑÈÉ®ÂàÜ
                    applicableAmount = Math.min(totalSales, next.minAmount) - current.minAmount;
                } else {
                    // ÊúÄÈ´òÈò∂Ê¢ØÔºåËÆ°ÁÆóË∂ÖÂá∫ÂΩìÂâçÈò∂Ê¢ØËµ∑ÂßãÈáëÈ¢ùÁöÑÊâÄÊúâÈÉ®ÂàÜ
                    applicableAmount = totalSales - current.minAmount;
                }
                
                // Â¶ÇÊûúÈÄÇÁî®ÈáëÈ¢ùÂ§ß‰∫é0ÔºåËÆ°ÁÆóÊèêÊàê
                if (applicableAmount > 0) {
                    commission += applicableAmount * current.rate;
                }
            }
            
            return commission;
        }

        // ËÆ°ÁÆóÈò∂Ê¢ØÂºèÊèêÊàêÂπ∂ËøîÂõûËØ¶ÁªÜËÆ°ÁÆóËøáÁ®ã
        function calculateLadderCommissionDetails(totalSales, ladderRates) {
            if (!ladderRates || ladderRates.length === 0) {
                return 'Êú™ËÆæÁΩÆÈò∂Ê¢Ø';
            }
            
            let details = [];
            let commission = 0;
            
            // ÊåâÈáëÈ¢ù‰ªéÂ∞èÂà∞Â§ßÊéíÂ∫è
            const sortedRates = ladderRates.sort((a, b) => a.minAmount - b.minAmount);
            
            for (let i = 0; i < sortedRates.length; i++) {
                const current = sortedRates[i];
                const next = sortedRates[i + 1];
                
                // Â¶ÇÊûúÈîÄÂîÆÈ¢ùËøòÊ≤°ËææÂà∞ÂΩìÂâçÈò∂Ê¢ØÁöÑËµ∑ÂßãÈáëÈ¢ùÔºåË∑≥Ëøá
                if (totalSales <= current.minAmount) {
                    break;
                }
                
                // ËÆ°ÁÆóÂΩìÂâçÈò∂Ê¢ØÈÄÇÁî®ÁöÑÈáëÈ¢ù
                let applicableAmount;
                if (next) {
                    // Êúâ‰∏ã‰∏Ä‰∏™Èò∂Ê¢ØÔºåËÆ°ÁÆóÂà∞‰∏ã‰∏Ä‰∏™Èò∂Ê¢ØËµ∑ÂßãÈáëÈ¢ùÁöÑÈÉ®ÂàÜ
                    applicableAmount = Math.min(totalSales, next.minAmount) - current.minAmount;
                } else {
                    // ÊúÄÈ´òÈò∂Ê¢ØÔºåËÆ°ÁÆóË∂ÖÂá∫ÂΩìÂâçÈò∂Ê¢ØËµ∑ÂßãÈáëÈ¢ùÁöÑÊâÄÊúâÈÉ®ÂàÜ
                    applicableAmount = totalSales - current.minAmount;
                }
                
                // Â¶ÇÊûúÈÄÇÁî®ÈáëÈ¢ùÂ§ß‰∫é0ÔºåËÆ°ÁÆóÊèêÊàêÂπ∂ËÆ∞ÂΩïËØ¶ÊÉÖ
                if (applicableAmount > 0) {
                    const stepCommission = applicableAmount * current.rate;
                    commission += stepCommission;
                    
                    const amountText = (applicableAmount / 10000).toFixed(2);
                    const rateText = (current.rate * 100).toFixed(1);
                    const commissionText = stepCommission.toFixed(2);
                    
                    details.push(`${amountText}‰∏á√ó${rateText}%=${commissionText}ÂÖÉ`);
                }
            }
            
            return details.length > 0 ? `ËÆ°ÁÆó: ${details.join(' + ')}` : 'ÊöÇÊó†ÊèêÊàê';
        }

        // ÁîüÊàêÊó•Êä•
        function generateDailySummary() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = salesData.filter(record => record.date === today);
            
            if (todayRecords.length === 0) {
                alert('‰ªäÊó•ÊöÇÊó†ÂÖ•Ë¥¶ËÆ∞ÂΩïÔºÅ');
                    return;
                }

            const totalAmount = todayRecords.reduce((sum, record) => sum + record.amount, 0);
            const salespersonSummary = {};
            
            todayRecords.forEach(record => {
                if (!salespersonSummary[record.salesperson]) {
                    salespersonSummary[record.salesperson] = 0;
                }
                salespersonSummary[record.salesperson] += record.amount;
            });
            
            let summaryText = `üìÖ ${today} Êó•ÂÖ•Ë¥¶ÁªüËÆ°\n\n`;
            summaryText += `üí∞ ‰ªäÊó•ÊÄªÂÖ•Ë¥¶: ¬•${totalAmount.toFixed(2)}\n`;
            summaryText += `üìä ÂÖ•Ë¥¶Á¨îÊï∞: ${todayRecords.length}Á¨î\n\n`;
            summaryText += `üë• ÈîÄÂîÆ‰∏öÁª©:\n`;
            
            Object.keys(salespersonSummary).forEach(person => {
                summaryText += `   ${person}: ¬•${salespersonSummary[person].toFixed(2)}\n`;
            });
            
            document.getElementById('summaryContent').innerHTML = summaryText.replace(/\n/g, '<br>');
            document.getElementById('dailySummary').style.display = 'block';
            
            // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáèÔºåÁî®‰∫éÂ§çÂà∂
            window.currentSummary = summaryText;
        }

        // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
        function copyToClipboard() {
            if (window.currentSummary) {
                navigator.clipboard.writeText(window.currentSummary).then(() => {
                    alert('‚úÖ Êó•Êä•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ');
                });
            }
        }

        // Ê†áÁ≠æÈ°µÂàáÊç¢Ôºà‰ºòÂåñÊÄßËÉΩ + ÂØÜÁ†Å‰øùÊä§Ôºâ
        function showTab(tabName) {
            // ÈúÄË¶ÅÂØÜÁ†Å‰øùÊä§ÁöÑÈ°µÈù¢
            const protectedTabs = ['statistics', 'salary', 'settings'];
            
            if (protectedTabs.includes(tabName)) {
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÈ™åËØÅËøáÂØÜÁ†Å
                const isAuthenticated = sessionStorage.getItem('adminAuthenticated') === 'true';
                
                if (!isAuthenticated) {
                    // ÂºπÂá∫ÂØÜÁ†ÅËæìÂÖ•Ê°Ü
                    const password = prompt('üîí ËØ∑ËæìÂÖ•ÁÆ°ÁêÜÂëòÂØÜÁ†ÅËÆøÈóÆÊ≠§ÂäüËÉΩÔºö');
                    
                    // Áî®Êà∑ÂèñÊ∂àËæìÂÖ•
                    if (password === null) {
                        return;
                    }
                    
                    // Âõ∫ÂÆöÂØÜÁ†ÅÔºölitang688
                    if (password !== 'litang688') {
                        alert('‚ùå ÂØÜÁ†ÅÈîôËØØÔºåÊó†Ê≥ïËÆøÈóÆÊ≠§È°µÈù¢ÔºÅ\n\nÊèêÁ§∫ÔºöÂ¶ÇÈúÄËÆøÈóÆÊùÉÈôêÔºåËØ∑ËÅîÁ≥ªÁ≥ªÁªüÁÆ°ÁêÜÂëò„ÄÇ');
                        return;
                    }
                    
                    // ÂØÜÁ†ÅÊ≠£Á°ÆÔºåËÆæÁΩÆ‰ºöËØùÊ†áËÆ∞
                    sessionStorage.setItem('adminAuthenticated', 'true');
                    alert('‚úÖ È™åËØÅÊàêÂäüÔºÅÂ∑≤Ëé∑ÂæóÁÆ°ÁêÜÂëòÊùÉÈôê„ÄÇ\n\nÊ≥®ÊÑèÔºöÊùÉÈôêÂ∞ÜÂú®24Â∞èÊó∂ÂêéËá™Âä®ËøáÊúü„ÄÇ');
                    
                    // ÊòæÁ§∫ÁÆ°ÁêÜÂëòÁä∂ÊÄÅ
                    updateAdminStatus();
                    
                    // ËÆæÁΩÆ24Â∞èÊó∂ÂêéËá™Âä®ËøáÊúü
                    setTimeout(() => {
                        sessionStorage.removeItem('adminAuthenticated');
                        updateAdminStatus();
                        console.log('ÁÆ°ÁêÜÂëòÊùÉÈôêÂ∑≤ËøáÊúü');
                    }, 24 * 60 * 60 * 1000);
                }
            }
            
            // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÂÜÖÂÆπ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÁßªÈô§ÊâÄÊúâÊ†áÁ≠æÁöÑactiveÁä∂ÊÄÅ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Ê†πÊçÆ‰∏çÂêåÊ†áÁ≠æÈ°µÂä†ËΩΩÁõ∏Â∫îÊï∞ÊçÆ
            if (tabName === 'statistics') {
                // Âª∂ËøüËÆ°ÁÆóÁªüËÆ°Êï∞ÊçÆÔºåÈÅøÂÖçÈòªÂ°ûUI
                setTimeout(() => {
                    updateAllStatistics();
                }, 50);
            } else if (tabName === 'settings') {
                // ÂàáÊç¢Âà∞Á≥ªÁªüËÆæÁΩÆÊó∂ÈáçÊñ∞Âä†ËΩΩËÆæÁΩÆÊï∞ÊçÆ
                setTimeout(() => {
                    loadSettingsData();
                }, 50);
            } else if (tabName === 'salary') {
                // ÂàáÊç¢Âà∞Â∑•ËµÑËÆ°ÁÆóÊó∂Êõ¥Êñ∞Â∑•ËµÑËØ¶ÊÉÖ
                setTimeout(() => {
                    updateSalaryDetails();
                }, 50);
            }
        }

        // ÁÆ°ÁêÜÂëòÊùÉÈôêÁÆ°ÁêÜ
        function updateAdminStatus() {
            const adminStatus = document.getElementById('adminStatus');
            const isAuthenticated = sessionStorage.getItem('adminAuthenticated') === 'true';
            
            if (isAuthenticated) {
                adminStatus.style.display = 'flex';
            } else {
                adminStatus.style.display = 'none';
            }
        }

        function logoutAdmin() {
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁÆ°ÁêÜÂëòÊùÉÈôêÂêóÔºü\n\nÈÄÄÂá∫ÂêéÈúÄË¶ÅÈáçÊñ∞ËæìÂÖ•ÂØÜÁ†ÅÊâçËÉΩËÆøÈóÆÂèó‰øùÊä§ÁöÑÈ°µÈù¢„ÄÇ\nÊùÉÈôêÊúâÊïàÊúüÔºö24Â∞èÊó∂')) {
                sessionStorage.removeItem('adminAuthenticated');
                updateAdminStatus();
                
                // Â¶ÇÊûúÂΩìÂâçÂú®Âèó‰øùÊä§È°µÈù¢ÔºåËá™Âä®ÂàáÊç¢Âà∞Êï∞ÊçÆÂ±ïÁ§∫È°µÈù¢
                const currentTab = document.querySelector('.tab.active');
                if (currentTab && (currentTab.textContent.includes('ÁªüËÆ°ÂàÜÊûê') || 
                                  currentTab.textContent.includes('Â∑•ËµÑËÆ°ÁÆó') || 
                                  currentTab.textContent.includes('Á≥ªÁªüËÆæÁΩÆ'))) {
                    showTab('records');
                }
                
                alert('‚úÖ Â∑≤ÊàêÂäüÈÄÄÂá∫ÁÆ°ÁêÜÂëòÊùÉÈôêÔºÅ');
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ÁÆ°ÁêÜÂëòÁä∂ÊÄÅ
        document.addEventListener('DOMContentLoaded', function() {
            updateAdminStatus();
        });

        // ÈîÄÂîÆÂä±ÂøóÂêçË®ÄÂ∫ì
        const salesMottos = [
            "ÂáùÂøÉËÅöÂäõ Âãá‰∫âÁ¨¨‰∏Ä",
            "‰∏öÁª©‰∏∫Áéã Ê∞∏‰∏çÊúçËæì",
            "ÊãºÊêèÂ•ãÊñó ÂÖ±ÂàõËæâÁÖå",
            "Ë∂ÖË∂äËá™Êàë ËøΩÊ±ÇÂçìË∂ä",
            "Âõ¢ÁªìÂçè‰Ωú ÂãáÊîÄÈ´òÂ≥∞",
            "Á≤æËØöÊâÄËá≥ ÈáëÁü≥‰∏∫ÂºÄ",
            "ÂøóÂ≠òÈ´òËøú ËÑöË∏èÂÆûÂú∞",
            "Âä™Âäõ‰ªäÂ§© ÊàêÂ∞±ÊòéÂ§©",
            "‰∏ì‰∏ö‰∏ìÊ≥® Ê∞∏Âàõ‰Ω≥Áª©",
            "ÊøÄÊÉÖÁáÉÁÉß Ê¢¶ÊÉ≥ÊàêÁúü",
            "ÂãáÂæÄÁõ¥Ââç Ê∞∏‰∏çË®ÄË¥•",
            "ËØö‰ø°ÁªèËê• ÊúçÂä°Ëá≥‰∏ä",
            "ÂàõÊñ∞Á™ÅÁ†¥ ÂºïÈ¢ÜÊú™Êù•",
            "ÂéöÂæ∑ËΩΩÁâ© Ëá™Âº∫‰∏çÊÅØ",
            "ÂøÉÊó†ÊóÅÈ™õ ‰∏ìÊ≥®ÁõÆÊ†á",
            "ÁôæÊäò‰∏çÊå† ÂãáÂàõÊñ∞È´ò",
            "Á≤æÁõäÊ±ÇÁ≤æ ËøΩÊ±ÇÂÆåÁæé",
            "Êê∫ÊâãÂπ∂Ëøõ ÂÖ±Ëµ¢Êú™Êù•",
            "Êï¢‰∏∫‰∫∫ÂÖà ÂãáÁ´ãÊΩÆÂ§¥",
            "ÂùöÊåÅ‰∏çÊáà ÁªàËé∑ÊàêÂäü"
        ];

        // Ëé∑ÂèñÈöèÊú∫ÈîÄÂîÆÂêçË®Ä
        function getRandomMotto() {
            const randomIndex = Math.floor(Math.random() * salesMottos.length);
            return salesMottos[randomIndex];
        }

        // ÂñúÊä•ÂºπÁ™óÂäüËÉΩ
                // ÂÖ®Â±ÄÂ≠òÂÇ®ÂΩìÂâçÂºπÁ™óÁöÑËÆ∞ÂΩïÊï∞ÊçÆ
        let currentCelebrationRecord = null;

        function showCelebrationModal(recordData) {
            console.log('üéâ Ëß¶ÂèëÂñúÊä•ÂºπÁ™ó', recordData);
            
            // Â≠òÂÇ®ÂΩìÂâçËÆ∞ÂΩïÊï∞ÊçÆ
            currentCelebrationRecord = recordData;
            
            const modal = document.getElementById('celebrationModal');
            const timeElement = document.getElementById('celebrationTime');
            const detailsElement = document.getElementById('celebrationDetails');
            const mottoElement = document.getElementById('celebrationMotto');
                
            if (!modal) {
                console.error('‚ùå Êâæ‰∏çÂà∞ÂñúÊä•ÂºπÁ™óÂÖÉÁ¥†');
                    return;
                }

            // ËÆæÁΩÆÈöèÊú∫Âä±ÂøóÂêçË®Ä
            if (mottoElement) {
                mottoElement.textContent = getRandomMotto();
            }
            
            // ËÆæÁΩÆÊó∂Èó¥
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            timeElement.textContent = `ËÆ∞ÂΩïÊó∂Èó¥Ôºö${timeStr}`;
            
            // ËÆ°ÁÆóËØ•ÈîÄÂîÆ‰∫∫ÂëòÁöÑÊÄª‰∏öÁª©ÁªüËÆ°
            const salespersonRecords = salesData.filter(record => record.salesperson === recordData.salesperson);
            const totalAmount = salespersonRecords.reduce((sum, record) => sum + record.amount, 0);
            const totalDeals = salespersonRecords.length;
            const avgDealAmount = totalDeals > 0 ? totalAmount / totalDeals : 0;
            
            // ËÆ°ÁÆóÊú¨Êúà‰∏öÁª©
            const currentMonth = new Date().toISOString().substring(0, 7);
            const monthRecords = salespersonRecords.filter(record => record.date.startsWith(currentMonth));
            const monthAmount = monthRecords.reduce((sum, record) => sum + record.amount, 0);
            const monthDeals = monthRecords.length;
            
            // ËÆæÁΩÆËØ¶ÁªÜ‰ø°ÊÅØ - ‰ºòÂåñ‰∏∫ÊâãÊú∫9:16ÂûÇÁõ¥Â∏ÉÂ±Ä
            detailsElement.innerHTML = `
                <!-- ‰∏ªË¶Å‰ø°ÊÅØÂå∫Âüü -->
                <div class="celebration-main-info">
                    <div class="celebration-highlight-amount">
                        <div class="amount-label">Êú¨Á¨îÊî∂ÂÖ•</div>
                        <div class="amount-value">¬•${recordData.amount.toLocaleString()}</div>
                    </div>
                    <div class="celebration-key-info">
                        <div class="key-info-item">
                            <span class="key-label">ÂÆ¢Êà∑</span>
                            <span class="key-value">${recordData.customer}</span>
                        </div>
                        <div class="key-info-item">
                            <span class="key-label">ÈîÄÂîÆÂëò</span>
                            <span class="key-value">${recordData.salesperson}</span>
                        </div>
                        <div class="key-info-item">
                            <span class="key-label">‰∏öÂä°Á±ªÂûã</span>
                            <span class="key-value">${recordData.businessType}</span>
                        </div>
                    </div>
                </div>
                
                <!-- ÂûÇÁõ¥‰ø°ÊÅØÂ∏ÉÂ±Ä -->
                <div class="celebration-three-columns">
                    <!-- ÂΩìÂâçËÆ∞ÂΩïËØ¶ÊÉÖ -->
                    <div class="celebration-column">
                        <h5 class="column-title">üìã Êú¨Ê¨°ËÆ∞ÂΩïËØ¶ÊÉÖ</h5>
                        <div class="mini-info-grid">
                            <div class="mini-info-item">
                                <span class="mini-label">Êù•Ê∫ê</span>
                                <span class="mini-value">${recordData.customerSource}</span>
                            </div>
                            <div class="mini-info-item">
                                <span class="mini-label">Á±ªÂûã</span>
                                <span class="mini-value">${recordData.incomeType}</span>
                            </div>
                            ${recordData.contractAmount ? `
                            <div class="mini-info-item">
                                <span class="mini-label">ÂêàÂêå</span>
                                <span class="mini-value">¬•${recordData.contractAmount.toLocaleString()}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- ‰∏öÁª©ÁªüËÆ°Âç°Áâá - Ê®™ÂêëÊéíÂàó -->
                    <div class="performance-cards">
                        <!-- ÂéÜÂè≤ÊÄª‰∏öÁª©Âç°Áâá -->
                        <div class="performance-card">
                            <h5 class="card-title">üèÜ ÂéÜÂè≤ÊÄª‰∏öÁª©</h5>
                            <div class="card-stats">
                                <div class="card-stat-item">
                                    <div class="card-stat-number">¬•${totalAmount.toLocaleString()}</div>
                                    <div class="card-stat-desc">ÊÄªÊî∂ÂÖ•</div>
                                </div>
                                <div class="card-stat-item">
                                    <div class="card-stat-number">${totalDeals}</div>
                                    <div class="card-stat-desc">Á¨îÊï∞</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Êú¨Êúà‰∏öÁª©Âç°Áâá -->
                        <div class="performance-card">
                            <h5 class="card-title">üìÖ Êú¨Êúà‰∏öÁª©</h5>
                            <div class="card-stats">
                                <div class="card-stat-item">
                                    <div class="card-stat-number">¬•${monthAmount.toLocaleString()}</div>
                                    <div class="card-stat-desc">Êú¨ÊúàÊî∂ÂÖ•</div>
                                </div>
                                <div class="card-stat-item">
                                    <div class="card-stat-number">${monthDeals}</div>
                                    <div class="card-stat-desc">Á¨îÊï∞</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${recordData.remarks ? `
                <div class="celebration-remarks">
                    <span class="remarks-label">üí¨</span>
                    <span class="remarks-text">${recordData.remarks}</span>
                </div>
                ` : ''}
            `;
            
            // ÊòæÁ§∫ÂºπÁ™ó
            modal.style.display = 'block';
            
            // Êí≠ÊîæÊàêÂäüÈü≥ÊïàÔºàÂ¶ÇÊûúÊµèËßàÂô®ÊîØÊåÅÔºâ
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMcBjuX2fDGeSsFJoHO8deIOAcZaLvt559NEAxPqOPwt2McBjuP2fDIfCsFJoHO8deIOAcZaLvt559NEAxPpuPwuGQcBjiR1/LMeS0FI3fH8N2QQAoUXrTp66hVFApGnt/zv2QcBjiR1/LNeSsFJYDO8daIOAcZaLvt559MEAxPpuPwuGQcBjiR1/LNeSsFJYDO8daIOAcZaLvt559MEAxPpuPwuGQcBjiR1/LNeSsFJYDO8daIOAcZaLvt559MEAxPpuPwuGQcBjiR1/LNeSsFJYDO8daIOA==');
                audio.play().catch(() => {}); // ÂøΩÁï•Êí≠ÊîæÂ§±Ë¥•
            } catch (e) {}
            
            // ÂºπÁ™óÂ∞ÜÊ∞∏‰πÖÊòæÁ§∫ÔºåÂè™ËÉΩÊâãÂä®ÂÖ≥Èó≠Ôºà‰æø‰∫éÁî®Êà∑Êà™ÂõæÔºâ
            console.log('üí° ÂñúÊä•ÂºπÁ™óÂ∑≤ÊòæÁ§∫ÔºåÂè™ËÉΩÊâãÂä®ÂÖ≥Èó≠Ôºå‰æø‰∫éÊà™Âõæ‰øùÂ≠ò');
        }

        function closeCelebrationModal() {
            const modal = document.getElementById('celebrationModal');
            modal.style.display = 'none';
            
            // Ê∏ÖÁêÜÂ≠òÂÇ®ÁöÑËÆ∞ÂΩïÊï∞ÊçÆ
            currentCelebrationRecord = null;
        }

        // Toast ÊèêÁ§∫ÂáΩÊï∞
        function showToast(message, type = 'info') {
            // ÂàõÂª∫toastÂÖÉÁ¥†
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 300px;
                animation: slideInRight 0.3s ease-out;
            `;
            toast.textContent = message;
            
            // Ê∑ªÂä†Ê†∑Âºè
            if (!document.getElementById('toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // 3ÁßíÂêéÁßªÈô§
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-in forwards';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // ËÆ∞ÂΩïhtml2canvasÂ§±Ë¥•Ê¨°Êï∞
        let html2canvasFailCount = parseInt(localStorage.getItem('html2canvasFailCount') || '0');
        
        // Â§çÂà∂Â∫ÜÁ•ùÂºπÁ™óÂõæÁâáÂà∞Ââ™Ë¥¥Êùø
        async function copyModalImage() {
            console.log('üìã Â§çÂà∂ÊåâÈíÆË¢´ÁÇπÂáª');
            
            try {
                const modal = document.querySelector('.celebration-content');
                if (!modal) {
                    throw new Error('ÂºπÁ™óÂÖÉÁ¥†Êú™ÊâæÂà∞');
                }

                // ÊòæÁ§∫Â§çÂà∂Áä∂ÊÄÅ
                const copyBtn = document.querySelector('.celebration-copy');
                if (!copyBtn) {
                    throw new Error('Â§çÂà∂ÊåâÈíÆÊú™ÊâæÂà∞');
                }
                
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '‚è≥';
                copyBtn.style.pointerEvents = 'none';
                
                console.log('üîÑ ÂºÄÂßãÂ§ÑÁêÜÊà™Âõæ...');
                showToast('Ê≠£Âú®ÁîüÊàêÊàòÊä•ÂõæÁâá...', 'info');
                
                // Êô∫ËÉΩÊ®°ÂºèÔºöÂ¶ÇÊûúhtml2canvasËøûÁª≠Â§±Ë¥•3Ê¨°‰ª•‰∏äÔºåÁõ¥Êé•‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°à
                if (html2canvasFailCount >= 3) {
                    console.log('üîÄ Ê£ÄÊµãÂà∞html2canvasÂ§öÊ¨°Â§±Ë¥•ÔºåÁõ¥Êé•‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°à');
                    showToast('‰ΩøÁî®‰ºòÂåñÊ®°ÂºèÁîüÊàêÂõæÁâá...', 'info');
                    
                    const currentRecord = extractRecordDataFromModal(modal);
                    const canvas = await createTextBasedReport(currentRecord);
                    console.log('‚úÖ Êô∫ËÉΩÈôçÁ∫ßÊñπÊ°àÁîüÊàêÂÆåÊàêÔºåÂ∞∫ÂØ∏:', canvas.width, 'x', canvas.height);
                    
                    await handleCanvasCopy(canvas, copyBtn, originalText);
                    return;
                }

                // Ê£ÄÊü•html2canvasÂ∫ì
                if (typeof html2canvas === 'undefined') {
                    console.log('‚è∞ Á≠âÂæÖhtml2canvasÂ∫ìÂä†ËΩΩ...');
                    showToast('Ê≠£Âú®Âä†ËΩΩÊà™ÂõæÂ∫ìÔºåËØ∑Á®çÂÄô...', 'info');
                    
                    try {
                        await waitForLibrary(() => typeof html2canvas !== 'undefined', 15000);
                        console.log('‚úÖ html2canvasÂ∫ìÂä†ËΩΩÊàêÂäü');
                        showToast('Êà™ÂõæÂ∫ìÂä†ËΩΩÊàêÂäüÔºÅ', 'success');
                    } catch (loadError) {
                        console.error('‚ùå html2canvasÂ∫ìÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°à');
                        showToast('Êà™ÂõæÂ∫ìÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®ÁÆÄÂåñÊ®°ÂºèÁîüÊàêÂõæÁâá...', 'info');
                        
                        // ‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°àÔºöÂàõÂª∫ÊñáÊú¨ÁâàÊàòÊä•
                        const currentRecord = extractRecordDataFromModal(modal);
                        
                        console.log('üìù ‰ΩøÁî®ÊñáÊú¨ÁâàÊàòÊä•ÁîüÊàê...');
                        const canvas = await createTextBasedReport(currentRecord);
                        console.log('‚úÖ ÊñáÊú¨ÁâàÊàòÊä•ÁîüÊàêÂÆåÊàêÔºåÂ∞∫ÂØ∏:', canvas.width, 'x', canvas.height);
                        
                        // Áõ¥Êé•Ë∑≥Âà∞Â§çÂà∂ÈÄªËæë
                        await handleCanvasCopy(canvas, copyBtn, originalText);
                        return;
                    }
                }

                let canvas;
                try {
                    // ‰∏¥Êó∂ÁßªÈô§ÂèØËÉΩÂπ≤Êâ∞Êà™ÂõæÁöÑÊ†∑Âºè
                    const originalStyles = {};
                    const elementsToFix = modal.querySelectorAll('*');
                    
                    // ‰øùÂ≠òÂπ∂‰øÆÊîπÊ†∑Âºè‰ª•Á°Æ‰øùhtml2canvasÂÖºÂÆπ
                    elementsToFix.forEach((el, index) => {
                        originalStyles[index] = {
                            backdropFilter: el.style.backdropFilter,
                            webkitBackdropFilter: el.style.webkitBackdropFilter,
                            filter: el.style.filter
                        };
                        
                        // ‰∏¥Êó∂ÁßªÈô§ÊØõÁéªÁíÉÊïàÊûú
                        el.style.backdropFilter = 'none';
                        el.style.webkitBackdropFilter = 'none';
                    });
                    
                    // ÂàõÂª∫È´òË¥®ÈáèÊà™Âõæ
                    console.log('üì∏ ÂºÄÂßãÊà™Âõæ...');
                    canvas = await html2canvas(modal, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        logging: false,
                        width: modal.offsetWidth,
                        height: modal.offsetHeight,
                        foreignObjectRendering: false,
                        removeContainer: false,
                        async: true,
                        proxy: null,
                        letterRendering: true,
                        imageTimeout: 0,
                        ignoreElements: function(element) {
                            // ÂøΩÁï•ÂèØËÉΩÂØºËá¥Ê∏≤ÊüìÈóÆÈ¢òÁöÑÂÖÉÁ¥†
                            return element.classList && (
                                element.classList.contains('celebration-close') ||
                                element.classList.contains('celebration-copy')
                            );
                        },
                        onclone: function(clonedDoc) {
                            // Âú®ÂÖãÈöÜÁöÑÊñáÊ°£‰∏≠Âº∫Âà∂Â∫îÁî®Ê≠£Á°ÆÁöÑÊ†∑Âºè
                            const clonedModal = clonedDoc.querySelector('.celebration-content');
                            if (clonedModal) {
                                // Âº∫Âà∂ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÊ†∑Âºè
                                clonedModal.style.cssText = `
                                    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
                                    border-radius: 28px !important;
                                    overflow: hidden !important;
                                    box-shadow: 0 24px 48px rgba(0, 0, 0, 0.15) !important;
                                    border: 1px solid rgba(0, 0, 0, 0.08) !important;
                                `;
                                
                                // Âº∫Âà∂ËÆæÁΩÆÂ§¥ÈÉ®Ê†∑Âºè
                                const header = clonedModal.querySelector('.celebration-header');
                                if (header) {
                                    header.style.cssText = `
                                        background: linear-gradient(135deg, #ff0022 0%, #fa5a5a 100%) !important;
                                        color: white !important;
                                        padding: 24px 20px 28px !important;
                                        text-align: center !important;
                                        position: relative !important;
                                        border-radius: 28px 28px 0 0 !important;
                                        backdrop-filter: none !important;
                                        -webkit-backdrop-filter: none !important;
                                    `;
                                    
                                    // Á°Æ‰øùÂ§¥ÈÉ®ÊñáÂ≠óÈ¢úËâ≤
                                    const headerElements = header.querySelectorAll('*');
                                    headerElements.forEach(el => {
                                        el.style.color = 'white !important';
                                    });
                                }
                                
                                // Âº∫Âà∂ËÆæÁΩÆË∫´‰ΩìÈÉ®ÂàÜÊ†∑Âºè
                                const body = clonedModal.querySelector('.celebration-body');
                                if (body) {
                                    body.style.cssText = `
                                        padding: 24px !important;
                                        background: transparent !important;
                                    `;
                                }
                                
                                // Âº∫Âà∂ËÆæÁΩÆÊú¨Ê¨°Êî∂ÂÖ•Ê†∑Âºè
                                const incomeHighlight = clonedModal.querySelector('.celebration-three-columns');
                                if (incomeHighlight) {
                                    incomeHighlight.style.cssText = `
                                        text-align: center !important;
                                        padding: 20px !important;
                                        background: linear-gradient(135deg, #f94141 0%, #f54c4c 100%) !important;
                                        border-radius: 16px !important;
                                        color: white !important;
                                        margin: 16px 0 !important;
                                    `;
                                    
                                    // Á°Æ‰øùÊî∂ÂÖ•ÊñáÂ≠óÈ¢úËâ≤
                                    const incomeElements = incomeHighlight.querySelectorAll('*');
                                    incomeElements.forEach(el => {
                                        el.style.color = 'white !important';
                                    });
                                }
                                
                                // ÁßªÈô§ÊâÄÊúâÂèØËÉΩÂπ≤Êâ∞ÁöÑÊïàÊûú
                                const allElements = clonedModal.querySelectorAll('*');
                                allElements.forEach(el => {
                                    el.style.backdropFilter = 'none !important';
                                    el.style.webkitBackdropFilter = 'none !important';
                                    el.style.filter = 'none !important';
                                    
                                    // ÁßªÈô§ÊåâÈíÆÔºàÈÅøÂÖçÂΩ±ÂìçÊà™ÂõæÔºâ
                                    if (el.classList.contains('celebration-close') || 
                                        el.classList.contains('celebration-copy')) {
                                        el.style.display = 'none !important';
                                    }
                                });
                            }
                        }
                    });
                    
                    // ÊÅ¢Â§çÂéüÂßãÊ†∑Âºè
                    elementsToFix.forEach((el, index) => {
                        if (originalStyles[index]) {
                            el.style.backdropFilter = originalStyles[index].backdropFilter || '';
                            el.style.webkitBackdropFilter = originalStyles[index].webkitBackdropFilter || '';
                            el.style.filter = originalStyles[index].filter || '';
                        }
                    });
                    
                    console.log('‚úÖ Êà™ÂõæÂÆåÊàêÔºåÂ∞∫ÂØ∏:', canvas.width, 'x', canvas.height);
                    
                    // Ê£ÄÊü•Êà™ÂõæÊòØÂê¶‰∏∫Á©∫ÁôΩÊàñÈ¢úËâ≤ÂºÇÂ∏∏
                    const ctx = canvas.getContext('2d');
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂΩ©Ëâ≤ÂÜÖÂÆπÔºàÁâπÂà´ÊòØÁ∫¢Ëâ≤Â§¥ÈÉ®Ôºâ
                    let hasColorContent = false;
                    let redPixelCount = 0;
                    let totalPixels = data.length / 4;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1]; 
                        const b = data[i + 2];
                        const a = data[i + 3];
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÊúâÁ∫¢Ëâ≤ÂÉèÁ¥†ÔºàÂ§¥ÈÉ®ËÉåÊôØÂ∫îËØ•ÊòØÁ∫¢Ëâ≤Ôºâ
                        if (a > 100 && r > 200 && g < 100 && b < 100) {
                            redPixelCount++;
                            hasColorContent = true;
                        }
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÖ∂‰ªñÈùûÁôΩËâ≤„ÄÅÈùûÁÅ∞Ëâ≤ÁöÑÂÜÖÂÆπ
                        if (a > 50 && (
                            (r > 50 && g < r - 50) || // Á∫¢Ëâ≤ÂÄæÂêë
                            (Math.abs(r - g) > 30 || Math.abs(r - b) > 30 || Math.abs(g - b) > 30) // ÂΩ©Ëâ≤ÂÜÖÂÆπ
                        )) {
                            hasColorContent = true;
                        }
                    }
                    
                    const redPixelRatio = redPixelCount / totalPixels;
                    
                    // Â¶ÇÊûúÊ≤°ÊúâÂΩ©Ëâ≤ÂÜÖÂÆπÊàñÁ∫¢Ëâ≤ÂÉèÁ¥†ÊØî‰æãÂ§™Â∞ëÔºåËØ¥ÊòéÊà™ÂõæË¥®Èáè‰∏ç‰Ω≥
                    if (!hasColorContent || redPixelRatio < 0.01) {
                        console.warn('‚ö†Ô∏è Ê£ÄÊµãÂà∞Êà™ÂõæÈ¢úËâ≤ÂºÇÂ∏∏ÊàñÂÜÖÂÆπ‰∏∫Á©∫ÁôΩÔºåÂàáÊç¢Âà∞ÈôçÁ∫ßÊñπÊ°à');
                        console.log(`Á∫¢Ëâ≤ÂÉèÁ¥†ÊØî‰æã: ${(redPixelRatio * 100).toFixed(2)}%, ÊúâÂΩ©Ëâ≤ÂÜÖÂÆπ: ${hasColorContent}`);
                        throw new Error('Êà™ÂõæÈ¢úËâ≤ÂºÇÂ∏∏Ôºå‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°à');
                    }
                    
                    console.log('‚úÖ Êà™ÂõæÂÜÖÂÆπÂíåÈ¢úËâ≤È™åËØÅÈÄöËøá', `Á∫¢Ëâ≤ÂÉèÁ¥†ÊØî‰æã: ${(redPixelRatio * 100).toFixed(2)}%`);
                    
                    // ÈáçÁΩÆÂ§±Ë¥•ËÆ°Êï∞
                    html2canvasFailCount = 0;
                    localStorage.setItem('html2canvasFailCount', '0');
                } catch (screenshotError) {
                    console.error('‚ùå Êà™ÂõæÂ§±Ë¥•Ôºå‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°à:', screenshotError);
                    showToast('Êà™ÂõæÂ§±Ë¥•Ôºå‰ΩøÁî®ÁÆÄÂåñÊ®°ÂºèÁîüÊàêÂõæÁâá...', 'info');
                    
                    // Â¢ûÂä†Â§±Ë¥•ËÆ°Êï∞
                    html2canvasFailCount++;
                    localStorage.setItem('html2canvasFailCount', html2canvasFailCount.toString());
                    console.log(`üìä html2canvasÂ§±Ë¥•ËÆ°Êï∞: ${html2canvasFailCount}`);
                    
                    // ‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°àÔºå‰ªéÂºπÁ™ó‰∏≠ÊèêÂèñÁúüÂÆûÊï∞ÊçÆ
                    const currentRecord = extractRecordDataFromModal(modal);
                    
                    canvas = await createTextBasedReport(currentRecord);
                    console.log('‚úÖ ÈôçÁ∫ßÊñπÊ°àÁîüÊàêÂÆåÊàêÔºåÂ∞∫ÂØ∏:', canvas.width, 'x', canvas.height);
                }

                // Â§ÑÁêÜCanvasÂ§çÂà∂
                await handleCanvasCopy(canvas, copyBtn, originalText);

            } catch (error) {
                console.error('‚ùå Â§çÂà∂ÂõæÁâáÂ§±Ë¥•:', error);
                
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                const copyBtn = document.querySelector('.celebration-copy');
                if (copyBtn) {
                    copyBtn.innerHTML = '‚ùå';
                    setTimeout(() => {
                        copyBtn.innerHTML = 'üìã';
                        copyBtn.style.pointerEvents = 'auto';
                    }, 2000);
                }
                
                showToast(`Â§çÂà∂Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // Â§ÑÁêÜCanvasÂ§çÂà∂ÁöÑËæÖÂä©ÂáΩÊï∞
        async function handleCanvasCopy(canvas, copyBtn, originalText) {
            try {
                // Â∞ÜcanvasËΩ¨Êç¢‰∏∫blob
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        throw new Error('ÂõæÁâáÁîüÊàêÂ§±Ë¥•');
                    }
                    
                    console.log('üñºÔ∏è ÂõæÁâáblobÁîüÊàêÊàêÂäüÔºåÂ§ßÂ∞è:', blob.size, 'bytes');
                    
                    try {
                        // Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅÂâ™Ë¥¥ÊùøAPI
                        if (navigator.clipboard && navigator.clipboard.write && window.ClipboardItem) {
                            console.log('üìã Â∞ùËØïÂ§çÂà∂Âà∞Ââ™Ë¥¥Êùø...');
                            await navigator.clipboard.write([
                                new ClipboardItem({ 'image/png': blob })
                            ]);
                            
                            console.log('‚úÖ Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÊàêÂäü');
                            
                            // ÊòæÁ§∫ÊàêÂäüÁä∂ÊÄÅ
                            copyBtn.innerHTML = '‚úÖ';
                            setTimeout(() => {
                                copyBtn.innerHTML = originalText;
                                copyBtn.style.pointerEvents = 'auto';
                            }, 2000);
                            
                            showToast('ÊàòÊä•ÂõæÁâáÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅÂèØ‰ª•Áõ¥Êé•Á≤òË¥¥ÂèëÈÄÅ', 'success');
                        } else {
                            console.log('üíæ Ââ™Ë¥¥ÊùøAPI‰∏çÊîØÊåÅÔºå‰ΩøÁî®‰∏ãËΩΩÊñπÊ°à');
                            // ÈôçÁ∫ßÊñπÊ°àÔºöÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                            const url = canvas.toDataURL('image/png');
                            const link = document.createElement('a');
                            const fileName = `ÈîÄÂîÆÊàòÊä•_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.png`;
                            link.download = fileName;
                            link.href = url;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            copyBtn.innerHTML = 'üíæ';
                            setTimeout(() => {
                                copyBtn.innerHTML = originalText;
                                copyBtn.style.pointerEvents = 'auto';
                            }, 2000);
                            
                            showToast(`ÂõæÁâáÂ∑≤‰øùÂ≠ò‰∏∫ ${fileName}`, 'success');
                        }
                    } catch (clipboardError) {
                        console.warn('‚ùå Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÂ§±Ë¥•ÔºåÂ∞ùËØï‰∏ãËΩΩ:', clipboardError);
                        
                        // ÈôçÁ∫ßÊñπÊ°àÔºöÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                        const url = canvas.toDataURL('image/png');
                        const link = document.createElement('a');
                        const fileName = `ÈîÄÂîÆÊàòÊä•_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.png`;
                        link.download = fileName;
                        link.href = url;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        copyBtn.innerHTML = 'üíæ';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalText;
                            copyBtn.style.pointerEvents = 'auto';
                        }, 2000);
                        
                        showToast(`ÂõæÁâáÂ∑≤‰øùÂ≠ò‰∏∫ ${fileName}`, 'success');
                    }
                }, 'image/png', 0.95);
            } catch (error) {
                console.error('‚ùå Â§ÑÁêÜCanvasÂ§çÂà∂Â§±Ë¥•:', error);
                
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                if (copyBtn) {
                    copyBtn.innerHTML = '‚ùå';
                    setTimeout(() => {
                        copyBtn.innerHTML = 'üìã';
                        copyBtn.style.pointerEvents = 'auto';
                    }, 2000);
                }
                
                showToast(`Â§çÂà∂Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // Á≠âÂæÖÂ∫ìÂä†ËΩΩÁöÑËæÖÂä©ÂáΩÊï∞
        function waitForLibrary(condition, timeout = 15000) {
            return new Promise((resolve, reject) => {
                console.log('‚è∞ ÂºÄÂßãÁ≠âÂæÖÂ∫ìÂä†ËΩΩ...');
                const startTime = Date.now();
                const checkInterval = setInterval(() => {
                    if (condition()) {
                        console.log('‚úÖ Â∫ìÂä†ËΩΩÂÆåÊàêÔºåËÄóÊó∂:', Date.now() - startTime, 'ms');
                        clearInterval(checkInterval);
                        resolve();
                    } else if (Date.now() - startTime > timeout) {
                        console.error('‚ùå Â∫ìÂä†ËΩΩË∂ÖÊó∂:', timeout, 'ms');
                        clearInterval(checkInterval);
                        reject(new Error('Â∫ìÂä†ËΩΩË∂ÖÊó∂'));
                    }
                }, 200);
            });
        }

        // ‰ªéÂºπÁ™ó‰∏≠ÊèêÂèñËÆ∞ÂΩïÊï∞ÊçÆ
        function extractRecordDataFromModal(modal) {
            try {
                console.log('üîç ÂºÄÂßã‰ªéÂºπÁ™óÊèêÂèñÊï∞ÊçÆ...');
                
                // ‰ºòÂÖà‰ΩøÁî®Â≠òÂÇ®ÁöÑÁúüÂÆûËÆ∞ÂΩïÊï∞ÊçÆ
                if (currentCelebrationRecord) {
                    console.log('‚úÖ ‰ΩøÁî®Â≠òÂÇ®ÁöÑÁúüÂÆûËÆ∞ÂΩïÊï∞ÊçÆ:', currentCelebrationRecord);
                    return {
                        customer: currentCelebrationRecord.customer || 'Êú™Áü•ÂÆ¢Êà∑',
                        customerSource: currentCelebrationRecord.customerSource || 'Êú™Áü•',
                        businessType: currentCelebrationRecord.businessType || 'ÈîÄÂîÆ‰∏öÂä°',
                        amount: currentCelebrationRecord.amount || 0,
                        incomeType: currentCelebrationRecord.incomeType || 'ÂõûÊ¨æ',
                        salesperson: currentCelebrationRecord.salesperson || 'ÈîÄÂîÆ‰∫∫Âëò',
                        contractAmount: currentCelebrationRecord.contractAmount || currentCelebrationRecord.amount || 0,
                        date: currentCelebrationRecord.date || new Date().toISOString().split('T')[0],
                        remarks: currentCelebrationRecord.remarks || 'ÈîÄÂîÆËÆ∞ÂΩï'
                    };
                }
                
                console.log('‚ö†Ô∏è Ê≤°ÊúâÂ≠òÂÇ®ÁöÑËÆ∞ÂΩïÊï∞ÊçÆÔºåÂ∞ùËØï‰ªéDOM‰∏≠ÊèêÂèñ...');
                
                let extractedData = {
                    customer: 'Êú™Áü•ÂÆ¢Êà∑',
                    customerSource: 'Êú™Áü•',
                    businessType: 'ÈîÄÂîÆ‰∏öÂä°',
                    amount: 0,
                    incomeType: 'ÂõûÊ¨æ',
                    salesperson: 'ÈîÄÂîÆ‰∫∫Âëò',
                    contractAmount: 0,
                    date: new Date().toISOString().split('T')[0],
                    remarks: 'ÈÄöËøáÂ§çÂà∂ÂäüËÉΩÁîüÊàê'
                };
                
                // ÊñπÊ≥ï1Ôºö‰ªé‰∏âÂàó‰ø°ÊÅØ‰∏≠ÊèêÂèñ
                const miniInfoItems = modal.querySelectorAll('.mini-info-item');
                console.log('ÊâæÂà∞mini-info-itemÊï∞Èáè:', miniInfoItems.length);
                
                miniInfoItems.forEach((item, index) => {
                    const label = item.querySelector('.mini-info-label')?.textContent?.trim();
                    const value = item.querySelector('.mini-info-value')?.textContent?.trim();
                    
                    console.log(`Á¨¨${index + 1}‰∏™‰ø°ÊÅØÈ°π - Ê†áÁ≠æ:`, label, 'ÂÄº:', value);
                    
                    if (label && value) {
                        if (label.includes('ÂÆ¢Êà∑')) {
                            extractedData.customer = value;
                        } else if (label.includes('ÈîÄÂîÆÂëò') || label.includes('ÈîÄÂîÆ‰∫∫Âëò')) {
                            extractedData.salesperson = value;
                        } else if (label.includes('‰∏öÂä°Á±ªÂûã')) {
                            extractedData.businessType = value;
                        }
                    }
                });
                
                // ÊñπÊ≥ï2Ôºö‰ªéÊú¨Ê¨°ËÆ∞ÂΩïËØ¶ÊÉÖ‰∏≠ÊèêÂèñ
                const detailInfoItems = modal.querySelectorAll('.detail-info-item');
                console.log('ÊâæÂà∞detail-info-itemÊï∞Èáè:', detailInfoItems.length);
                
                detailInfoItems.forEach((item, index) => {
                    const label = item.querySelector('.detail-info-label')?.textContent?.trim();
                    const value = item.querySelector('.detail-info-value')?.textContent?.trim();
                    
                    console.log(`ËØ¶ÊÉÖÁ¨¨${index + 1}‰∏™ - Ê†áÁ≠æ:`, label, 'ÂÄº:', value);
                    
                    if (label && value) {
                        if (label.includes('Êù•Ê∫ê')) {
                            extractedData.customerSource = value;
                        } else if (label.includes('Á±ªÂûã')) {
                            extractedData.incomeType = value;
                        } else if (label.includes('ÂêàÂêå')) {
                            const contractMatch = value.match(/[¬•Ôø•]?([0-9,]+)/);
                            if (contractMatch) {
                                extractedData.contractAmount = parseFloat(contractMatch[1].replace(/,/g, '')) || 0;
                            }
                        }
                    }
                });
                
                // ÊñπÊ≥ï3Ôºö‰ªéÈ´ò‰∫ÆÈáëÈ¢ùÂå∫ÂüüÊèêÂèñÊú¨Ê¨°Êî∂ÂÖ•
                const amountElement = modal.querySelector('.celebration-three-columns .amount');
                if (amountElement) {
                    const amountText = amountElement.textContent || amountElement.innerText || '';
                    console.log('ÈáëÈ¢ùÂÖÉÁ¥†ÊñáÊú¨:', amountText);
                    const amountMatch = amountText.match(/[¬•Ôø•]?([0-9,]+)/);
                    if (amountMatch) {
                        extractedData.amount = parseFloat(amountMatch[1].replace(/,/g, '')) || 0;
                    }
                }
                
                // ÊñπÊ≥ï4ÔºöÂ¶ÇÊûú‰∏äÈù¢Ê≤°ÊúâÊâæÂà∞ÈáëÈ¢ùÔºåÂ∞ùËØïÂÖ∂‰ªñÈÄâÊã©Âô®
                if (extractedData.amount === 0) {
                    const amountElements = modal.querySelectorAll('*');
                    for (let el of amountElements) {
                        if (el.textContent && el.textContent.includes('¬•') && el.textContent.match(/¬•[0-9,]+/)) {
                            const amountMatch = el.textContent.match(/¬•([0-9,]+)/);
                            if (amountMatch && parseFloat(amountMatch[1].replace(/,/g, '')) > 0) {
                                extractedData.amount = parseFloat(amountMatch[1].replace(/,/g, ''));
                                console.log('‰ªéÈÄöÁî®ÂÖÉÁ¥†‰∏≠ÊèêÂèñÂà∞ÈáëÈ¢ù:', extractedData.amount);
                                break;
                            }
                        }
                    }
                }
                
                // ÊñπÊ≥ï5Ôºö‰ªéÊó∂Èó¥ÂÖÉÁ¥†ÊèêÂèñÊó•Êúü
                const timeElement = modal.querySelector('.celebration-time');
                if (timeElement) {
                    const timeText = timeElement.textContent || timeElement.innerText || '';
                    console.log('Êó∂Èó¥ÂÖÉÁ¥†ÊñáÊú¨:', timeText);
                    const dateMatch = timeText.match(/(\d{4}[-/]\d{2}[-/]\d{2})/);
                    if (dateMatch) {
                        extractedData.date = dateMatch[1].replace(/\//g, '-');
                    }
                }
                
                // ÊñπÊ≥ï6Ôºö‰ªéÂ§áÊ≥®Âå∫ÂüüÊèêÂèñÂ§áÊ≥®
                const remarksElement = modal.querySelector('.celebration-remarks') || 
                                      modal.querySelector('[class*="remark"]') ||
                                      modal.querySelector('[class*="note"]');
                if (remarksElement) {
                    const remarksText = remarksElement.textContent?.trim();
                    if (remarksText && remarksText !== 'ÈÄöËøáÂ§çÂà∂ÂäüËÉΩÁîüÊàê') {
                        extractedData.remarks = remarksText;
                    }
                }
                
                // Â¶ÇÊûúÂêàÂêåÈáëÈ¢ùÊ≤°ÊúâÂÄºÔºå‰ΩøÁî®Êî∂ÂÖ•ÈáëÈ¢ù
                if (extractedData.contractAmount === 0 && extractedData.amount > 0) {
                    extractedData.contractAmount = extractedData.amount;
                }
                
                console.log('‚úÖ ÊúÄÁªàÊèêÂèñÁöÑËÆ∞ÂΩïÊï∞ÊçÆ:', extractedData);
                return extractedData;
                
            } catch (error) {
                console.error('‚ùå ÊèêÂèñÂºπÁ™óÊï∞ÊçÆÂ§±Ë¥•:', error);
                return {
                    customer: 'Êï∞ÊçÆÊèêÂèñÂ§±Ë¥•',
                    customerSource: 'Êú™Áü•',
                    businessType: 'Êú™Áü•‰∏öÂä°',
                    amount: 0,
                    incomeType: 'ÂõûÊ¨æ',
                    salesperson: 'Êú™Áü•ÈîÄÂîÆ',
                    contractAmount: 0,
                    date: new Date().toISOString().split('T')[0],
                    remarks: 'Êï∞ÊçÆÊèêÂèñËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ'
                };
            }
        }

        // ÂàõÂª∫ÊñáÊú¨ÊàòÊä•ÂõæÁâáÔºàÈôçÁ∫ßÊñπÊ°àÔºâ
        function createTextBasedReport(recordData) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // ËÆæÁΩÆÁîªÂ∏ÉÂ∞∫ÂØ∏ÔºåÂåπÈÖçÂºπÁ™óÊØî‰æã
                canvas.width = 720;
                canvas.height = 1280;
                
                // 1. ÁªòÂà∂ÁôΩËâ≤ËÉåÊôØ
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // 2. ÁªòÂà∂Â§¥ÈÉ®Á∫¢Ëâ≤Âå∫Âüü
                const headerHeight = 250;
                const headerGradient = ctx.createLinearGradient(0, 0, canvas.width, headerHeight);
                headerGradient.addColorStop(0, '#ff0022');
                headerGradient.addColorStop(1, '#fa5a5a');
                ctx.fillStyle = headerGradient;
                ctx.fillRect(0, 0, canvas.width, headerHeight);
                
                // 3. Â§¥ÈÉ®ÂÜÖÂÆπ
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.font = 'bold 48px Arial, "Microsoft YaHei"';
                ctx.fillText('üèÜ ÊàòÊä•', canvas.width/2, 80);
                
                ctx.font = 'bold 36px Arial, "Microsoft YaHei"';
                ctx.fillText('üéâ ÊÅ≠ÂñúÔºÅÈîÄÂîÆËÆ∞ÂΩïÊ∑ªÂä†ÊàêÂäü', canvas.width/2, 140);
                
                ctx.font = '24px Arial, "Microsoft YaHei"';
                ctx.fillText('ÂáùÂøÉËÅöÂäõ Âãá‰∫âÁ¨¨‰∏Ä', canvas.width/2, 180);
                
                // Êó∂Èó¥
                ctx.font = '20px Arial, "Microsoft YaHei"';
                ctx.fillText(`ËÆ∞ÂΩïÊó∂Èó¥Ôºö${recordData.date} ${new Date().toLocaleTimeString()}`, canvas.width/2, 220);
                
                // 4. Êú¨Ê¨°Êî∂ÂÖ•È´ò‰∫ÆÂå∫Âüü
                const incomeY = headerHeight + 40;
                const incomeHeight = 120;
                const incomeGradient = ctx.createLinearGradient(0, incomeY, canvas.width, incomeY + incomeHeight);
                incomeGradient.addColorStop(0, '#f94141');
                incomeGradient.addColorStop(1, '#f54c4c');
                ctx.fillStyle = incomeGradient;
                ctx.fillRect(50, incomeY, canvas.width - 100, incomeHeight);
                
                // Êî∂ÂÖ•ÈáëÈ¢ù
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.font = '24px Arial, "Microsoft YaHei"';
                ctx.fillText('Êú¨Ê¨°Êî∂ÂÖ•', canvas.width/2, incomeY + 30);
                ctx.font = 'bold 48px Arial, "Microsoft YaHei"';
                ctx.fillText(`¬•${recordData.amount.toLocaleString()}`, canvas.width/2, incomeY + 80);
                
                // 5. ËØ¶ÁªÜ‰ø°ÊÅØÂå∫Âüü
                let detailY = incomeY + incomeHeight + 60;
                const leftX = 80;
                const centerX = canvas.width / 2;
                const rightX = canvas.width - 80;
                
                // ËÆæÁΩÆËØ¶ÁªÜ‰ø°ÊÅØÊ†∑Âºè
                ctx.fillStyle = '#333333';
                ctx.textAlign = 'center';
                ctx.font = 'bold 28px Arial, "Microsoft YaHei"';
                
                // ‰∏âÂàó‰ø°ÊÅØ
                const col1X = leftX + 60;
                const col2X = centerX;
                const col3X = rightX - 60;
                
                // Ê†áÈ¢òË°å
                ctx.fillStyle = '#666666';
                ctx.font = '20px Arial, "Microsoft YaHei"';
                ctx.fillText('ÂÆ¢Êà∑', col1X, detailY);
                ctx.fillText('ÈîÄÂîÆÂëò', col2X, detailY);
                ctx.fillText('‰∏öÂä°Á±ªÂûã', col3X, detailY);
                
                // ÂÜÖÂÆπË°å
                detailY += 40;
                ctx.fillStyle = '#333333';
                ctx.font = 'bold 24px Arial, "Microsoft YaHei"';
                ctx.fillText(recordData.customer, col1X, detailY);
                ctx.fillText(recordData.salesperson, col2X, detailY);
                ctx.fillText(recordData.businessType, col3X, detailY);
                
                // 6. Êú¨Ê¨°ËÆ∞ÂΩïËØ¶ÊÉÖ
                detailY += 80;
                ctx.fillStyle = '#007AFF';
                ctx.textAlign = 'center';
                ctx.font = '22px Arial, "Microsoft YaHei"';
                ctx.fillText('üìã Êú¨Ê¨°ËÆ∞ÂΩïËØ¶ÊÉÖ', canvas.width/2, detailY);
                
                // ËØ¶ÊÉÖ‰ø°ÊÅØ
                detailY += 50;
                ctx.fillStyle = '#333333';
                ctx.textAlign = 'left';
                ctx.font = '24px Arial, "Microsoft YaHei"';
                
                const detailItems = [
                    { label: 'Êù•Ê∫ê', value: recordData.customerSource || 'Êú™Áü•' },
                    { label: 'Á±ªÂûã', value: recordData.incomeType },
                    { label: 'ÂêàÂêå', value: `¬•${recordData.contractAmount || recordData.amount}` }
                ];
                
                detailItems.forEach((item, index) => {
                    const itemX = 80 + (index * 180);
                    ctx.fillStyle = '#666666';
                    ctx.font = '18px Arial, "Microsoft YaHei"';
                    ctx.fillText(item.label, itemX, detailY);
                    
                    ctx.fillStyle = '#333333';
                    ctx.font = 'bold 22px Arial, "Microsoft YaHei"';
                    ctx.fillText(item.value, itemX, detailY + 30);
                });
                
                // 7. Â∫ïÈÉ®Â§áÊ≥®
                if (recordData.remarks && recordData.remarks !== 'ÈÄöËøáÂ§çÂà∂ÂäüËÉΩÁîüÊàê') {
                    detailY += 100;
                    ctx.fillStyle = '#999999';
                    ctx.textAlign = 'center';
                    ctx.font = '18px Arial, "Microsoft YaHei"';
                    ctx.fillText(`Â§áÊ≥®Ôºö${recordData.remarks}`, canvas.width/2, detailY);
                }
                
                // 8. Â∫ïÈÉ®Á•ùË¥∫
                ctx.fillStyle = '#007AFF';
                ctx.textAlign = 'center';
                ctx.font = 'bold 32px Arial, "Microsoft YaHei"';
                ctx.fillText('üéâ ÊÅ≠ÂñúÊàê‰∫§ÔºÅ', canvas.width/2, canvas.height - 80);
                
                resolve(canvas);
            });
        }

        // Á¶ÅÁî®ÁÇπÂáªÂºπÁ™óÂ§ñÈÉ®ÂÖ≥Èó≠ÂäüËÉΩÔºà‰øùÊä§Êà™ÂõæÊìç‰ΩúÔºâ
        window.onclick = function(event) {
            const modal = document.getElementById('celebrationModal');
            if (event.target == modal) {
                // ‰∏çÂÖ≥Èó≠ÂºπÁ™óÔºå‰øùÊåÅÊòæÁ§∫Áä∂ÊÄÅ‰æø‰∫éÊà™Âõæ
                console.log('üí° ÁÇπÂáªÂ§ñÈÉ®Âå∫Âüü‰∏ç‰ºöÂÖ≥Èó≠ÂºπÁ™óÔºåËØ∑ÁÇπÂáªÂÖ≥Èó≠ÊåâÈíÆ');
            }
        }

        // ÂØºÂá∫Âà∞Excel (.xlsxÊ†ºÂºè)
        function exportToExcel() {
            // Ê£ÄÊü•XLSXÂ∫ìÊòØÂê¶Âä†ËΩΩ
            if (typeof XLSX === 'undefined') {
                alert('‚ùå ExcelÂØºÂá∫ÂäüËÉΩÊöÇÊó∂‰∏çÂèØÁî®ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØïÊàñÊ£ÄÊü•ÁΩëÁªúËøûÊé•ÔºÅ');
                            return;
                        }

            try {
                // ÊòæÁ§∫ÂØºÂá∫ËøõÂ∫¶
                const exportBtn = event.target;
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<span>‚è≥</span><span>ÂØºÂá∫‰∏≠...</span>';
                exportBtn.disabled = true;
                
                // ÂàõÂª∫Â∑•‰ΩúÁ∞ø
                const wb = XLSX.utils.book_new();
                
                // 1. ÂáÜÂ§áÈîÄÂîÆËÆ∞ÂΩïÊï∞ÊçÆ
                const excelData = salesData.map(record => ({
                    'Êî∂Ê¨æÊó•Êúü': record.date,
                    'ÂÆ¢Êà∑Âêç': record.customer,
                    'ÂÆ¢Êà∑Êù•Ê∫ê': record.customerSource || 'Êú™ËÆæÁΩÆ',
                    '‰∏öÂä°Á±ªÂûã': record.businessType,
                    'Êî∂ÂÖ•ÈáëÈ¢ù': record.amount,
                    'Êî∂ÂÖ•Á±ªÂûã': record.incomeType,
                    'ÈîÄÂîÆ‰∫∫Âëò': record.salesperson,
                    'ÂêàÂêåÈáëÈ¢ù': record.contractAmount,
                    'Â§áÊ≥®': record.remarks || ''
                }));
                
                // ÂàõÂª∫ÈîÄÂîÆËÆ∞ÂΩïÂ∑•‰ΩúË°®
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // ËÆæÁΩÆÂàóÂÆΩ
                const colWidths = [
                    { wch: 12 }, // Êî∂Ê¨æÊó•Êúü
                    { wch: 15 }, // ÂÆ¢Êà∑Âêç
                    { wch: 12 }, // ÂÆ¢Êà∑Êù•Ê∫ê
                    { wch: 12 }, // ‰∏öÂä°Á±ªÂûã
                    { wch: 12 }, // Êî∂ÂÖ•ÈáëÈ¢ù
                    { wch: 12 }, // Êî∂ÂÖ•Á±ªÂûã
                    { wch: 10 }, // ÈîÄÂîÆ‰∫∫Âëò
                    { wch: 12 }, // ÂêàÂêåÈáëÈ¢ù
                    { wch: 20 }  // Â§áÊ≥®
                ];
                ws['!cols'] = colWidths;
                
                // ËÆæÁΩÆÊ†∑ÂºèÔºàË°®Â§¥Ôºâ
                if (ws['!ref']) {
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const address = XLSX.utils.encode_cell({ r: 0, c: C });
                        if (!ws[address]) continue;
                        ws[address].s = {
                            fill: { fgColor: { rgb: "4CAF50" } },
                            font: { color: { rgb: "FFFFFF" }, bold: true },
                            alignment: { horizontal: "center" }
                        };
                    }
                }
                
                // Ê∑ªÂä†ÈîÄÂîÆËÆ∞ÂΩïÂ∑•‰ΩúË°®Âà∞Â∑•‰ΩúÁ∞ø
                XLSX.utils.book_append_sheet(wb, ws, "ÈîÄÂîÆËÆ∞ÂΩï");
                
                // 2. ÂáÜÂ§áÂ∑•ËµÑËÆ°ÁÆóÊï∞ÊçÆ
                const currentMonth = new Date().toISOString().substring(0, 7);
                const monthRecords = salesData.filter(record => record.date.startsWith(currentMonth));
                
                // ËÆ°ÁÆóÂ∑•ËµÑÊï∞ÊçÆ
                const salaryData = {};
                
                // ÂàùÂßãÂåñÊâÄÊúâÈîÄÂîÆ‰∫∫ÂëòÁöÑÊï∞ÊçÆ
                systemSettings.salespeople.forEach(person => {
                    salaryData[person.name] = {
                        totalSales: 0,
                        baseSalary: person.baseSalary,
                        commissionType: person.commissionType,
                        fixedRate: person.fixedRate || 0,
                        ladderRates: person.ladderRates || [],
                        commission: 0,
                        totalSalary: 0
                    };
                });
                
                // ÁªüËÆ°ÈîÄÂîÆÈ¢ù
                monthRecords.forEach(record => {
                    if (salaryData[record.salesperson]) {
                        salaryData[record.salesperson].totalSales += record.amount;
                    }
                });
                
                // ËÆ°ÁÆóÊèêÊàêÂíåÊÄªÂ∑•ËµÑ
                const salaryExcelData = [];
                Object.keys(salaryData).forEach(person => {
                    const data = salaryData[person];
                    
                    if (data.commissionType === 'ladder' && data.ladderRates.length > 0) {
                        // Èò∂Ê¢ØÂºèÊèêÊàêËÆ°ÁÆó
                        data.commission = calculateLadderCommission(data.totalSales, data.ladderRates);
                        } else {
                        // Âõ∫ÂÆöÊØî‰æãÊèêÊàê
                        data.commission = data.totalSales * data.fixedRate;
                    }
                    
                    data.totalSalary = data.baseSalary + data.commission;
                    
                    // ÂáÜÂ§áExcelÊï∞ÊçÆ
                    let commissionTypeText = '';
                    let commissionDetailText = '';
                    
                    if (data.commissionType === 'ladder') {
                        commissionTypeText = 'Èò∂Ê¢ØÂºè';
                        if (data.totalSales > 0 && data.ladderRates.length > 0) {
                            commissionDetailText = calculateLadderCommissionDetails(data.totalSales, data.ladderRates);
                        } else {
                            commissionDetailText = 'Êó†ÈîÄÂîÆ‰∏öÁª©';
                        }
                    } else {
                        commissionTypeText = `Âõ∫ÂÆö${(data.fixedRate*100).toFixed(1)}%`;
                        commissionDetailText = `${data.totalSales.toFixed(2)} √ó ${(data.fixedRate*100).toFixed(1)}% = ${data.commission.toFixed(2)}ÂÖÉ`;
                    }
                    
                    salaryExcelData.push({
                        'ÈîÄÂîÆ‰∫∫Âëò': person,
                        'ÈîÄÂîÆ‰∏öÁª©(ÂÖÉ)': data.totalSales.toFixed(2),
                        'Âü∫Á°ÄÂ∑•ËµÑ(ÂÖÉ)': data.baseSalary.toFixed(2),
                        'ÊèêÊàêÁ±ªÂûã': commissionTypeText,
                        'ÊèêÊàêÈáëÈ¢ù(ÂÖÉ)': data.commission.toFixed(2),
                        'ÊÄªÂ∑•ËµÑ(ÂÖÉ)': data.totalSalary.toFixed(2),
                        'ÊèêÊàêËÆ°ÁÆóËØ¶ÊÉÖ': commissionDetailText
                    });
                });
                
                // ÂàõÂª∫Â∑•ËµÑËÆ°ÁÆóÂ∑•‰ΩúË°®
                const salaryWs = XLSX.utils.json_to_sheet(salaryExcelData);
                
                // ËÆæÁΩÆÂ∑•ËµÑËÆ°ÁÆóÂ∑•‰ΩúË°®ÂàóÂÆΩ
                const salaryColWidths = [
                    { wch: 12 }, // ÈîÄÂîÆ‰∫∫Âëò
                    { wch: 15 }, // ÈîÄÂîÆ‰∏öÁª©
                    { wch: 15 }, // Âü∫Á°ÄÂ∑•ËµÑ
                    { wch: 12 }, // ÊèêÊàêÁ±ªÂûã
                    { wch: 15 }, // ÊèêÊàêÈáëÈ¢ù
                    { wch: 15 }, // ÊÄªÂ∑•ËµÑ
                    { wch: 40 }  // ÊèêÊàêËÆ°ÁÆóËØ¶ÊÉÖ
                ];
                salaryWs['!cols'] = salaryColWidths;
                
                // ËÆæÁΩÆÂ∑•ËµÑËÆ°ÁÆóÂ∑•‰ΩúË°®Ê†∑Âºè
                if (salaryWs['!ref']) {
                    const salaryRange = XLSX.utils.decode_range(salaryWs['!ref']);
                    for (let C = salaryRange.s.c; C <= salaryRange.e.c; ++C) {
                        const address = XLSX.utils.encode_cell({ r: 0, c: C });
                        if (!salaryWs[address]) continue;
                        salaryWs[address].s = {
                            fill: { fgColor: { rgb: "FF9800" } },
                            font: { color: { rgb: "FFFFFF" }, bold: true },
                            alignment: { horizontal: "center" }
                        };
                    }
                }
                
                // Ê∑ªÂä†Â∑•ËµÑËÆ°ÁÆóÂ∑•‰ΩúË°®Âà∞Â∑•‰ΩúÁ∞ø
                XLSX.utils.book_append_sheet(wb, salaryWs, "Â∑•ËµÑËÆ°ÁÆó");
                
                // 3. ÂàõÂª∫ÁªüËÆ°Ê±áÊÄªÂ∑•‰ΩúË°®
                const monthTotal = monthRecords.reduce((sum, record) => sum + record.amount, 0);
                const todayTotal = salesData.filter(record => record.date === new Date().toISOString().split('T')[0])
                    .reduce((sum, record) => sum + record.amount, 0);
                const totalSalary = salaryExcelData.reduce((sum, row) => sum + parseFloat(row['ÊÄªÂ∑•ËµÑ(ÂÖÉ)']), 0);
                const totalCommission = salaryExcelData.reduce((sum, row) => sum + parseFloat(row['ÊèêÊàêÈáëÈ¢ù(ÂÖÉ)']), 0);
                
                const statsData = [
                    { 'ÁªüËÆ°È°πÁõÆ': 'Êú¨ÊúàÊÄªÂÖ•Ë¥¶', 'ÈáëÈ¢ù(ÂÖÉ)': monthTotal.toFixed(2), 'ËØ¥Êòé': `${currentMonth}Êúà‰ªΩ` },
                    { 'ÁªüËÆ°È°πÁõÆ': '‰ªäÊó•ÊÄªÂÖ•Ë¥¶', 'ÈáëÈ¢ù(ÂÖÉ)': todayTotal.toFixed(2), 'ËØ¥Êòé': new Date().toISOString().split('T')[0] },
                    { 'ÁªüËÆ°È°πÁõÆ': 'ËÆ∞ÂΩïÊÄªÊï∞', 'ÈáëÈ¢ù(ÂÖÉ)': salesData.length, 'ËØ¥Êòé': 'ÂÖ®ÈÉ®ËÆ∞ÂΩï' },
                    { 'ÁªüËÆ°È°πÁõÆ': 'Êú¨ÊúàËÆ∞ÂΩïÊï∞', 'ÈáëÈ¢ù(ÂÖÉ)': monthRecords.length, 'ËØ¥Êòé': `${currentMonth}Êúà‰ªΩ` },
                    { 'ÁªüËÆ°È°πÁõÆ': 'Êú¨ÊúàÊÄªÂ∑•ËµÑ', 'ÈáëÈ¢ù(ÂÖÉ)': totalSalary.toFixed(2), 'ËØ¥Êòé': 'Âü∫Á°ÄÂ∑•ËµÑ+ÊèêÊàê' },
                    { 'ÁªüËÆ°È°πÁõÆ': 'Êú¨ÊúàÊÄªÊèêÊàê', 'ÈáëÈ¢ù(ÂÖÉ)': totalCommission.toFixed(2), 'ËØ¥Êòé': 'ÊâÄÊúâÈîÄÂîÆ‰∫∫ÂëòÊèêÊàê' }
                ];
                
                const statsWs = XLSX.utils.json_to_sheet(statsData);
                statsWs['!cols'] = [{ wch: 15 }, { wch: 15 }, { wch: 15 }];
                
                // ËÆæÁΩÆÁªüËÆ°Ê±áÊÄªÂ∑•‰ΩúË°®Ê†∑Âºè
                if (statsWs['!ref']) {
                    const statsRange = XLSX.utils.decode_range(statsWs['!ref']);
                    for (let C = statsRange.s.c; C <= statsRange.e.c; ++C) {
                        const address = XLSX.utils.encode_cell({ r: 0, c: C });
                        if (!statsWs[address]) continue;
                        statsWs[address].s = {
                            fill: { fgColor: { rgb: "2196F3" } },
                            font: { color: { rgb: "FFFFFF" }, bold: true },
                            alignment: { horizontal: "center" }
                        };
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, statsWs, "ÁªüËÆ°Ê±áÊÄª");
                
                // Âª∂ËøüÂ§ÑÁêÜÔºåÈÅøÂÖçÈòªÂ°ûUI
                setTimeout(() => {
                    try {
                        // ‰∏ãËΩΩÊñá‰ª∂
                        const fileName = `ÈîÄÂîÆËÆ∞ÂΩï_${new Date().toISOString().split('T')[0]}.xlsx`;
                        XLSX.writeFile(wb, fileName);
                        
                        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                        exportBtn.innerHTML = originalText;
                        exportBtn.disabled = false;
                        
                        alert('‚úÖ ExcelÊñá‰ª∂ÂØºÂá∫ÊàêÂäüÔºÅÂåÖÂê´ÈîÄÂîÆËÆ∞ÂΩï„ÄÅÂ∑•ËµÑËÆ°ÁÆóÂíåÁªüËÆ°Ê±áÊÄª‰∏â‰∏™Â∑•‰ΩúË°®');
                    } catch (writeError) {
                        console.error('Êñá‰ª∂ÂÜôÂÖ•Â§±Ë¥•:', writeError);
                        exportBtn.innerHTML = originalText;
                        exportBtn.disabled = false;
                        alert('‚ùå Êñá‰ª∂‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®‰∏ãËΩΩÊùÉÈôêÔºÅ');
                    }
                }, 100);
                
            } catch (error) {
                console.error('ExcelÂØºÂá∫Â§±Ë¥•:', error);
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                if (typeof exportBtn !== 'undefined') {
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                }
                
                // Â∞ùËØïÂ§áÁî®ÊñπÊ°à
                if (confirm('È´òÁ∫ßExcelÂØºÂá∫Â§±Ë¥•ÔºåÊòØÂê¶‰ΩøÁî®ÁÆÄÂåñÁâàÂØºÂá∫Ôºü\nÁÆÄÂåñÁâàÂåÖÂê´Âü∫Êú¨Êï∞ÊçÆ‰ΩÜÊ≤°ÊúâÂ§öÂ∑•‰ΩúË°®ÂäüËÉΩ„ÄÇ')) {
                    exportToExcelSimple();
                } else {
                    alert('‚ùå ExcelÂØºÂá∫Â§±Ë¥•Ôºö' + error.message + '„ÄÇËØ∑Â∞ùËØïÂà∑Êñ∞È°µÈù¢ÈáçËØïÔºÅ');
                }
            }
        }

        // ÂØºÂá∫PDFÊä•Ë°® (ÊîØÊåÅ‰∏≠Êñá)
        function exportToPDF() {
            // ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
            const loadingAlert = document.createElement('div');
            loadingAlert.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
            `;
            loadingAlert.innerHTML = '<p>üìä Ê≠£Âú®ÁîüÊàêPDFÊä•Ë°®ÔºåËØ∑Á®çÂÄô...</p>';
            document.body.appendChild(loadingAlert);

            try {
            const currentMonth = new Date().toISOString().substring(0, 7);
            const monthRecords = salesData.filter(record => record.date.startsWith(currentMonth));
            const monthTotal = monthRecords.reduce((sum, record) => sum + record.amount, 0);
                const todayTotal = salesData.filter(record => record.date === new Date().toISOString().split('T')[0])
                    .reduce((sum, record) => sum + record.amount, 0);

                // ÂàõÂª∫‰∏¥Êó∂ÁöÑÊä•Ë°®HTML
                const reportHTML = createPDFReportHTML(currentMonth, monthRecords, monthTotal, todayTotal);
                
                // ÂàõÂª∫‰∏¥Êó∂ÂÖÉÁ¥†
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = reportHTML;
                tempDiv.style.cssText = `
                    position: absolute;
                    left: -10000px;
                    top: 0;
                    width: 800px;
                    background: white;
                    font-family: 'Microsoft YaHei', sans-serif;
                `;
                document.body.appendChild(tempDiv);

                // ‰ΩøÁî®html2canvas + jsPDF
                setTimeout(() => {
                    html2canvas(tempDiv, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff'
                    }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const { jsPDF } = window.jspdf;
                        
                        // ËÆ°ÁÆóPDFÂ∞∫ÂØ∏
                        const imgWidth = 210;
                        const pageHeight = 295;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        let heightLeft = imgHeight;
                        
                        const doc = new jsPDF('p', 'mm');
                        let position = 0;
                        
                        // Ê∑ªÂä†Á¨¨‰∏ÄÈ°µ
                        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                        
                        // Â¶ÇÊûúÂÜÖÂÆπË∂ÖËøá‰∏ÄÈ°µÔºåÊ∑ªÂä†Êõ¥Â§öÈ°µÈù¢
                        while (heightLeft >= 0) {
                            position = heightLeft - imgHeight;
                            doc.addPage();
                            doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= pageHeight;
                        }
                        
                        // ‰øùÂ≠òPDF
                        const fileName = `ÈîÄÂîÆÊä•Ë°®_${currentMonth}.pdf`;
                        doc.save(fileName);
                        
                        // Ê∏ÖÁêÜ
                        document.body.removeChild(tempDiv);
                        document.body.removeChild(loadingAlert);
                        alert('‚úÖ PDFÊä•Ë°®ÂØºÂá∫ÊàêÂäüÔºÅ');
                        
                }).catch(error => {
                        console.error('PDFÁîüÊàêÂ§±Ë¥•:', error);
                        document.body.removeChild(tempDiv);
                        document.body.removeChild(loadingAlert);
                        alert('‚ùå PDFÁîüÊàêÂ§±Ë¥•ÔºåËØ∑ÈáçËØïÔºÅ');
                    });
                }, 500);

            } catch (error) {
                console.error('PDFÂØºÂá∫Â§±Ë¥•:', error);
                document.body.removeChild(loadingAlert);
                alert('‚ùå PDFÂØºÂá∫Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅÔºÅ');
            }
        }

        // ÂàõÂª∫PDFÊä•Ë°®HTMLÂÜÖÂÆπ
        function createPDFReportHTML(currentMonth, monthRecords, monthTotal, todayTotal) {
            // ËÆ°ÁÆóÈîÄÂîÆ‰∫∫Âëò‰∏öÁª©
            const salespersonStats = {};
            monthRecords.forEach(record => {
                if (!salespersonStats[record.salesperson]) {
                    salespersonStats[record.salesperson] = 0;
                }
                salespersonStats[record.salesperson] += record.amount;
            });

            // ËÆ°ÁÆóÂ∑•ËµÑÊï∞ÊçÆ
            const salaryData = {};
            systemSettings.salespeople.forEach(person => {
                salaryData[person.name] = {
                    totalSales: 0,
                    baseSalary: person.baseSalary,
                    commissionType: person.commissionType,
                    fixedRate: person.fixedRate || 0,
                    ladderRates: person.ladderRates || [],
                    commission: 0,
                    totalSalary: 0
                };
            });

            // ÁªüËÆ°ÈîÄÂîÆÈ¢ù
            monthRecords.forEach(record => {
                if (salaryData[record.salesperson]) {
                    salaryData[record.salesperson].totalSales += record.amount;
                }
            });

            // ËÆ°ÁÆóÊèêÊàêÂíåÊÄªÂ∑•ËµÑ
            Object.keys(salaryData).forEach(person => {
                const data = salaryData[person];
                if (data.commissionType === 'ladder' && data.ladderRates.length > 0) {
                    data.commission = calculateLadderCommission(data.totalSales, data.ladderRates);
                } else {
                    data.commission = data.totalSales * data.fixedRate;
                }
                data.totalSalary = data.baseSalary + data.commission;
            });

            const totalSalarySum = Object.values(salaryData).reduce((sum, data) => sum + data.totalSalary, 0);
            const totalCommissionSum = Object.values(salaryData).reduce((sum, data) => sum + data.commission, 0);

            return `
                <div style="padding: 30px; font-family: 'Microsoft YaHei', sans-serif;">
                    <!-- Êä•Ë°®Ê†áÈ¢ò -->
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="color: #4CAF50; font-size: 28px; margin: 0;">üìä ÈîÄÂîÆÊä•Ë°®</h1>
                        <h2 style="color: #666; font-size: 18px; margin: 10px 0;">${currentMonth} Êúà‰ªΩÁªüËÆ°</h2>
                        <p style="color: #999; font-size: 12px;">ÁîüÊàêÊó∂Èó¥: ${new Date().toLocaleString()}</p>
                    </div>

                    <!-- ÁªüËÆ°Ê¶ÇËßà -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                        <h3 style="color: #333; margin-top: 0;">üìà ÁªüËÆ°Ê¶ÇËßà</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                                <div style="font-size: 12px; color: #666;">Êú¨ÊúàÊÄªÂÖ•Ë¥¶</div>
                                <div style="font-size: 18px; color: #4CAF50; font-weight: bold;">¬•${monthTotal.toFixed(2)}</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #2196F3;">
                                <div style="font-size: 12px; color: #666;">‰ªäÊó•ÊÄªÂÖ•Ë¥¶</div>
                                <div style="font-size: 18px; color: #2196F3; font-weight: bold;">¬•${todayTotal.toFixed(2)}</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #FF9800;">
                                <div style="font-size: 12px; color: #666;">Êú¨ÊúàËÆ∞ÂΩïÊï∞</div>
                                <div style="font-size: 18px; color: #FF9800; font-weight: bold;">${monthRecords.length} Á¨î</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #9C27B0;">
                                <div style="font-size: 12px; color: #666;">ÊÄªËÆ∞ÂΩïÊï∞</div>
                                <div style="font-size: 18px; color: #9C27B0; font-weight: bold;">${salesData.length} Á¨î</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #E91E63;">
                                <div style="font-size: 12px; color: #666;">Êú¨ÊúàÊÄªÂ∑•ËµÑ</div>
                                <div style="font-size: 18px; color: #E91E63; font-weight: bold;">¬•${totalSalarySum.toFixed(2)}</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #795548;">
                                <div style="font-size: 12px; color: #666;">Êú¨ÊúàÊÄªÊèêÊàê</div>
                                <div style="font-size: 18px; color: #795548; font-weight: bold;">¬•${totalCommissionSum.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>

                    <!-- ËØ¶ÁªÜËÆ∞ÂΩïË°®Ê†º -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #333;">üìã ËØ¶ÁªÜËÆ∞ÂΩï</h3>
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden;">
                            <thead>
                                <tr style="background: #4CAF50; color: white;">
                                    <th style="padding: 10px 6px; text-align: left; font-size: 11px;">Êî∂Ê¨æÊó•Êúü</th>
                                    <th style="padding: 10px 6px; text-align: left; font-size: 11px;">ÂÆ¢Êà∑Âêç</th>
                                    <th style="padding: 10px 6px; text-align: left; font-size: 11px;">ÂÆ¢Êà∑Êù•Ê∫ê</th>
                                    <th style="padding: 10px 6px; text-align: left; font-size: 11px;">‰∏öÂä°Á±ªÂûã</th>
                                    <th style="padding: 10px 6px; text-align: left; font-size: 11px;">Êî∂ÂÖ•ÈáëÈ¢ù</th>
                                    <th style="padding: 10px 6px; text-align: left; font-size: 11px;">Êî∂ÂÖ•Á±ªÂûã</th>
                                    <th style="padding: 10px 6px; text-align: left; font-size: 11px;">ÈîÄÂîÆ‰∫∫Âëò</th>
                                    <th style="padding: 10px 6px; text-align: left; font-size: 11px;">Â§áÊ≥®</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${monthRecords.map((record, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f9f9f9' : 'white'};">
                                        <td style="padding: 8px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${record.date}</td>
                                        <td style="padding: 8px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${record.customer}</td>
                                        <td style="padding: 8px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${record.customerSource || 'Êú™ËÆæÁΩÆ'}</td>
                                        <td style="padding: 8px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${record.businessType}</td>
                                        <td style="padding: 8px 6px; border-bottom: 1px solid #eee; font-size: 10px; color: #4CAF50; font-weight: bold;">¬•${record.amount.toFixed(2)}</td>
                                        <td style="padding: 8px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${record.incomeType}</td>
                                        <td style="padding: 8px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${record.salesperson}</td>
                                        <td style="padding: 8px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${record.remarks || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Â∑•ËµÑËÆ°ÁÆóÁªüËÆ° -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #333;">üí∞ Â∑•ËµÑËÆ°ÁÆóÁªüËÆ°</h3>
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden;">
                            <thead>
                                <tr style="background: #FF9800; color: white;">
                                    <th style="padding: 10px 6px; text-align: left; font-size: 11px;">ÈîÄÂîÆ‰∫∫Âëò</th>
                                    <th style="padding: 10px 6px; text-align: left; font-size: 11px;">ÈîÄÂîÆ‰∏öÁª©</th>
                                    <th style="padding: 10px 6px; text-align: left; font-size: 11px;">Âü∫Á°ÄÂ∑•ËµÑ</th>
                                    <th style="padding: 10px 6px; text-align: left; font-size: 11px;">ÊèêÊàêÁ±ªÂûã</th>
                                    <th style="padding: 10px 6px; text-align: left; font-size: 11px;">ÊèêÊàêÈáëÈ¢ù</th>
                                    <th style="padding: 10px 6px; text-align: left; font-size: 11px;">ÊÄªÂ∑•ËµÑ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.keys(salaryData).map((person, index) => {
                                    const data = salaryData[person];
                                    const commissionTypeText = data.commissionType === 'ladder' ? 'Èò∂Ê¢ØÂºè' : `Âõ∫ÂÆö${(data.fixedRate*100).toFixed(1)}%`;
                                    return `
                                        <tr style="background: ${index % 2 === 0 ? '#f9f9f9' : 'white'};">
                                            <td style="padding: 10px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${person}</td>
                                            <td style="padding: 10px 6px; border-bottom: 1px solid #eee; font-size: 10px; color: #4CAF50; font-weight: bold;">¬•${data.totalSales.toFixed(2)}</td>
                                            <td style="padding: 10px 6px; border-bottom: 1px solid #eee; font-size: 10px;">¬•${data.baseSalary.toFixed(2)}</td>
                                            <td style="padding: 10px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${commissionTypeText}</td>
                                            <td style="padding: 10px 6px; border-bottom: 1px solid #eee; font-size: 10px; color: #FF9800; font-weight: bold;">¬•${data.commission.toFixed(2)}</td>
                                            <td style="padding: 10px 6px; border-bottom: 1px solid #eee; font-size: 10px; color: #2196F3; font-weight: bold;">¬•${data.totalSalary.toFixed(2)}</td>
                                        </tr>
                                    `;
                                }).join('')}
                                <tr style="background: #e8f5e8; font-weight: bold;">
                                    <td style="padding: 12px 6px; border-top: 2px solid #4CAF50; font-size: 11px;">ÂêàËÆ°</td>
                                    <td style="padding: 12px 6px; border-top: 2px solid #4CAF50; font-size: 11px; color: #4CAF50;">¬•${monthTotal.toFixed(2)}</td>
                                    <td style="padding: 12px 6px; border-top: 2px solid #4CAF50; font-size: 11px;">-</td>
                                    <td style="padding: 12px 6px; border-top: 2px solid #4CAF50; font-size: 11px;">-</td>
                                    <td style="padding: 12px 6px; border-top: 2px solid #4CAF50; font-size: 11px; color: #FF9800;">¬•${totalCommissionSum.toFixed(2)}</td>
                                    <td style="padding: 12px 6px; border-top: 2px solid #4CAF50; font-size: 11px; color: #2196F3;">¬•${totalSalarySum.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- ÈîÄÂîÆ‰∫∫Âëò‰∏öÁª©ÁªüËÆ° -->
                    <div>
                        <h3 style="color: #333;">üë• ÈîÄÂîÆ‰∫∫Âëò‰∏öÁª©ÁªüËÆ°</h3>
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden;">
                            <thead>
                                <tr style="background: #4CAF50; color: white;">
                                    <th style="padding: 12px; text-align: left;">ÈîÄÂîÆ‰∫∫Âëò</th>
                                    <th style="padding: 12px; text-align: left;">ÈîÄÂîÆÈáëÈ¢ù</th>
                                    <th style="padding: 12px; text-align: left;">Âç†ÊØî</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.keys(salespersonStats).map((person, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f9f9f9' : 'white'};">
                                        <td style="padding: 12px; border-bottom: 1px solid #eee;">${person}</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #eee; color: #4CAF50; font-weight: bold;">¬•${salespersonStats[person].toFixed(2)}</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #eee;">${monthTotal > 0 ? ((salespersonStats[person] / monthTotal) * 100).toFixed(1) : '0'}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- È°µËÑö -->
                    <div style="margin-top: 30px; text-align: center; color: #999; font-size: 12px;">
                        <p>ÈîÄÂîÆËÆ∞ÂΩïÁÆ°ÁêÜÁ≥ªÁªü Ëá™Âä®ÁîüÊàê | ÁîüÊàêÊó∂Èó¥: ${new Date().toLocaleString()}</p>
                    </div>
                </div>
            `;
        }

                // ÂØºÂá∫CSVÊ†ºÂºè (ÁÆÄÂçïÊï∞ÊçÆÊ†ºÂºè)
        function exportToCSV() {
            try {
                // Ê∑ªÂä†BOM‰ª•ÊîØÊåÅ‰∏≠Êñá
                let csvContent = "\uFEFF";
                csvContent += "Êî∂Ê¨æÊó•Êúü,ÂÆ¢Êà∑Âêç,ÂÆ¢Êà∑Êù•Ê∫ê,‰∏öÂä°Á±ªÂûã,Êî∂ÂÖ•ÈáëÈ¢ù,Êî∂ÂÖ•Á±ªÂûã,ÈîÄÂîÆ‰∫∫Âëò,ÂêàÂêåÈáëÈ¢ù,Â§áÊ≥®\n";
                
                salesData.forEach(record => {
                    csvContent += `${record.date},"${record.customer}","${record.customerSource || 'Êú™ËÆæÁΩÆ'}","${record.businessType}",${record.amount},"${record.incomeType}","${record.salesperson}",${record.contractAmount},"${record.remarks || ''}"\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `ÈîÄÂîÆËÆ∞ÂΩï_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                alert('‚úÖ CSVÊñá‰ª∂ÂØºÂá∫ÊàêÂäüÔºÅ');
            } catch (error) {
                console.error('CSVÂØºÂá∫Â§±Ë¥•:', error);
                alert('‚ùå CSVÂØºÂá∫Â§±Ë¥•ÔºÅ');
            }
        }

        // ÁÆÄÂåñÁâàExcelÂØºÂá∫ÔºàÂ§áÁî®ÊñπÊ°àÔºâ
        function exportToExcelSimple() {
            try {
                // ÂàõÂª∫HTMLË°®Ê†ºÊï∞ÊçÆ
                let htmlContent = `
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <style>
                            table { border-collapse: collapse; width: 100%; }
                            th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                            th { background-color: #4CAF50; color: white; }
                        </style>
                    </head>
                    <body>
                        <h2>ÈîÄÂîÆËÆ∞ÂΩï</h2>
                        <table>
                            <tr>
                                <th>Êî∂Ê¨æÊó•Êúü</th>
                                <th>ÂÆ¢Êà∑Âêç</th>
                                <th>ÂÆ¢Êà∑Êù•Ê∫ê</th>
                                <th>‰∏öÂä°Á±ªÂûã</th>
                                <th>Êî∂ÂÖ•ÈáëÈ¢ù</th>
                                <th>Êî∂ÂÖ•Á±ªÂûã</th>
                                <th>ÈîÄÂîÆ‰∫∫Âëò</th>
                                <th>ÂêàÂêåÈáëÈ¢ù</th>
                                <th>Â§áÊ≥®</th>
                            </tr>
                `;
                
                salesData.forEach(record => {
                    htmlContent += `
                        <tr>
                            <td>${record.date}</td>
                            <td>${record.customer}</td>
                            <td>${record.customerSource || 'Êú™ËÆæÁΩÆ'}</td>
                            <td>${record.businessType}</td>
                            <td>${record.amount}</td>
                            <td>${record.incomeType}</td>
                            <td>${record.salesperson}</td>
                            <td>${record.contractAmount}</td>
                            <td>${record.remarks || ''}</td>
                        </tr>
                    `;
                });
                
                                  htmlContent += `
                          </table>
                `;
                
                const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `ÈîÄÂîÆËÆ∞ÂΩï_${new Date().toISOString().split('T')[0]}.xls`;
            link.click();
                
                alert('‚úÖ ExcelÊñá‰ª∂ÂØºÂá∫ÊàêÂäüÔºÅÔºàÁÆÄÂåñÁâàÔºâ');
            } catch (error) {
                console.error('ÁÆÄÂåñExcelÂØºÂá∫Â§±Ë¥•:', error);
                alert('‚ùå ÂØºÂá∫Â§±Ë¥•ÔºÅ');
            }
        }

        // Â§á‰ªΩÊï∞ÊçÆ
        function backupData() {
            const backupData = {
                timestamp: new Date().toISOString(),
                data: salesData
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ÈîÄÂîÆÊï∞ÊçÆÂ§á‰ªΩ_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // ÂØºÂÖ•Êï∞ÊçÆ
        function importData() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.data && Array.isArray(importedData.data)) {
                        salesData = importedData.data;
                        localStorage.setItem('salesData', JSON.stringify(salesData));
                        loadTableData();
                        updateStatistics();
                        updateSalaryDetails();
                        
                        // Â¶ÇÊûúÂΩìÂâçÂú®ÁªüËÆ°ÂàÜÊûêÊ†áÁ≠æÔºåÂàôÊõ¥Êñ∞ÁªüËÆ°
                        if (document.getElementById('statistics').classList.contains('active')) {
                            setTimeout(() => updateAllStatistics(), 50);
                        }
                        
                        // ÂÖ≥Èó≠ÂèØËÉΩÂ≠òÂú®ÁöÑÂñúÊä•ÂºπÁ™óÔºàÂõ†‰∏∫Êï∞ÊçÆÂ∑≤ÂÖ®ÈáèÊõøÊç¢Ôºâ
                        closeCelebrationModal();
                        
                        alert('‚úÖ Êï∞ÊçÆÂØºÂÖ•ÊàêÂäüÔºÅ');
                    } else {
                        alert('‚ùå ÂØºÂÖ•Êñá‰ª∂Ê†ºÂºèÈîôËØØÔºÅ');
                    }
                } catch (error) {
                    alert('‚ùå ÂØºÂÖ•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂Ê†ºÂºèÔºÅ');
                }
            };
            reader.readAsText(file);
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ
        function clearAllData() {
            if (confirm('‚ö†Ô∏è Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                salesData = [];
                localStorage.removeItem('salesData');
                loadTableData();
                updateStatistics();
                updateSalaryDetails();
                
                // Â¶ÇÊûúÂΩìÂâçÂú®ÁªüËÆ°ÂàÜÊûêÊ†áÁ≠æÔºåÂàôÊõ¥Êñ∞ÁªüËÆ°
                if (document.getElementById('statistics').classList.contains('active')) {
                    setTimeout(() => updateAllStatistics(), 50);
                }
                
                // ÂÖ≥Èó≠ÂèØËÉΩÂ≠òÂú®ÁöÑÂñúÊä•ÂºπÁ™óÔºàÂõ†‰∏∫Êï∞ÊçÆÂ∑≤ÂÖ®ÈÉ®Ê∏ÖÁ©∫Ôºâ
                closeCelebrationModal();
                
                alert('‚úÖ ÊâÄÊúâÊï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫ÔºÅ');
            }
        }

        // ===== Á≥ªÁªüËÆæÁΩÆÁõ∏ÂÖ≥ÂáΩÊï∞ =====
        
        // ‰øùÂ≠òÁ≥ªÁªüËÆæÁΩÆ
        function saveSystemSettings() {
            localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
        }
        
        // Êõ¥Êñ∞Ë°®ÂçïÈÄâÈ°π
        function updateFormOptions() {
            console.log('Ê≠£Âú®Êõ¥Êñ∞Ë°®ÂçïÈÄâÈ°π...', systemSettings);
            
            // Êõ¥Êñ∞‰∏öÂä°Á±ªÂûãÈÄâÈ°π
            const businessTypeSelect = document.getElementById('businessType');
            if (businessTypeSelect) {
                businessTypeSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©‰∏öÂä°Á±ªÂûã</option>';
                if (systemSettings.businessTypes && systemSettings.businessTypes.length > 0) {
                    systemSettings.businessTypes.forEach(type => {
                        businessTypeSelect.innerHTML += `<option value="${type}">${type}</option>`;
                    });
                }
                console.log('‰∏öÂä°Á±ªÂûãÈÄâÈ°πÂ∑≤Êõ¥Êñ∞ÔºåÂÖ±', systemSettings.businessTypes?.length || 0, 'È°π');
            } else {
                console.error('Êâæ‰∏çÂà∞businessTypeÂÖÉÁ¥†');
            }
            
            // Êõ¥Êñ∞Êî∂ÂÖ•Á±ªÂûãÈÄâÈ°π
            const incomeTypeSelect = document.getElementById('incomeType');
            if (incomeTypeSelect) {
                incomeTypeSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Êî∂ÂÖ•Á±ªÂûã</option>';
                if (systemSettings.incomeTypes && systemSettings.incomeTypes.length > 0) {
                    systemSettings.incomeTypes.forEach(type => {
                        incomeTypeSelect.innerHTML += `<option value="${type}">${type}</option>`;
                    });
                }
                console.log('Êî∂ÂÖ•Á±ªÂûãÈÄâÈ°πÂ∑≤Êõ¥Êñ∞ÔºåÂÖ±', systemSettings.incomeTypes?.length || 0, 'È°π');
            } else {
                console.error('Êâæ‰∏çÂà∞incomeTypeÂÖÉÁ¥†');
            }
            
            // Êõ¥Êñ∞ÂÆ¢Êà∑Êù•Ê∫êÈÄâÈ°π
            const customerSourceSelect = document.getElementById('customerSource');
            if (customerSourceSelect) {
                customerSourceSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©ÂÆ¢Êà∑Êù•Ê∫ê</option>';
                if (systemSettings.customerSources && systemSettings.customerSources.length > 0) {
                    systemSettings.customerSources.forEach(source => {
                        customerSourceSelect.innerHTML += `<option value="${source}">${source}</option>`;
                    });
                }
                console.log('ÂÆ¢Êà∑Êù•Ê∫êÈÄâÈ°πÂ∑≤Êõ¥Êñ∞ÔºåÂÖ±', systemSettings.customerSources?.length || 0, 'È°π');
            } else {
                console.error('Êâæ‰∏çÂà∞customerSourceÂÖÉÁ¥†');
            }
            
            // Êõ¥Êñ∞ÈîÄÂîÆ‰∫∫ÂëòÈÄâÈ°π
            const salespersonSelect = document.getElementById('salesperson');
            if (salespersonSelect) {
                salespersonSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©ÈîÄÂîÆ‰∫∫Âëò</option>';
                if (systemSettings.salespeople && systemSettings.salespeople.length > 0) {
                    systemSettings.salespeople.forEach(person => {
                        salespersonSelect.innerHTML += `<option value="${person.name}">${person.name}</option>`;
                    });
                }
                salespersonSelect.innerHTML += '<option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>';
                console.log('ÈîÄÂîÆ‰∫∫ÂëòÈÄâÈ°πÂ∑≤Êõ¥Êñ∞ÔºåÂÖ±', systemSettings.salespeople?.length || 0, '‰∫∫');
            } else {
                console.error('Êâæ‰∏çÂà∞salespersonÂÖÉÁ¥†');
            }
            
            console.log('Ë°®ÂçïÈÄâÈ°πÊõ¥Êñ∞ÂÆåÊàê');
        }
        
        // Âä†ËΩΩËÆæÁΩÆÊï∞ÊçÆÂà∞ÁïåÈù¢
        function loadSettingsData() {
            console.log('ÂºÄÂßãÂä†ËΩΩËÆæÁΩÆÊï∞ÊçÆ...', systemSettings);
            
            // Á°Æ‰øùDOMÂÖÉÁ¥†Â∑≤ÁªèÂä†ËΩΩ
            if (document.readyState === 'loading') {
                console.log('DOMËøòÂú®Âä†ËΩΩ‰∏≠ÔºåÁ≠âÂæÖÂä†ËΩΩÂÆåÊàê...');
                document.addEventListener('DOMContentLoaded', loadSettingsData);
                return;
            }
            
            // Âº∫Âà∂Âà∑Êñ∞Êï∞ÊçÆ
            try {
                loadBusinessTypes();
                loadIncomeTypes();
                loadCustomerSources();
                loadSalespersonList();
                console.log('ËÆæÁΩÆÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê');
            } catch (error) {
                console.error('Âä†ËΩΩËÆæÁΩÆÊï∞ÊçÆÊó∂Âá∫Èîô:', error);
            }
        }
        
        // Âä†ËΩΩ‰∏öÂä°Á±ªÂûãÂàóË°®
        function loadBusinessTypes() {
            const list = document.getElementById('businessTypesList');
            if (!list) {
                console.error('Êâæ‰∏çÂà∞ businessTypesList ÂÖÉÁ¥†');
                return;
            }
            
            console.log('Âä†ËΩΩ‰∏öÂä°Á±ªÂûã:', systemSettings.businessTypes);
            list.innerHTML = '';
            
            if (systemSettings.businessTypes.length === 0) {
                list.innerHTML = '<div class="empty-state">ÊöÇÊó†‰∏öÂä°Á±ªÂûãÔºåËØ∑Ê∑ªÂä†</div>';
                return;
            }
            
            systemSettings.businessTypes.forEach((type, index) => {
                const item = document.createElement('div');
                item.className = 'settings-item';
                item.innerHTML = `
                    <div class="settings-item-content">
                        <span class="item-index">${index + 1}</span>
                        <span class="item-text" id="businessType_${index}">${type}</span>
                    </div>
                    <div class="settings-item-actions">
                        <button class="btn btn-secondary btn-small" onclick="editBusinessType(${index})" title="ÁºñËæë">
                            <span>‚úèÔ∏è</span>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="removeBusinessType(${index})" title="Âà†Èô§">
                            <span>üóëÔ∏è</span>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
            console.log('‰∏öÂä°Á±ªÂûãÂàóË°®Â∑≤Âä†ËΩΩÔºåÂÖ±', systemSettings.businessTypes.length, 'È°π');
        }
        
        // Âä†ËΩΩÊî∂ÂÖ•Á±ªÂûãÂàóË°®
        function loadIncomeTypes() {
            const list = document.getElementById('incomeTypesList');
            if (!list) {
                console.error('Êâæ‰∏çÂà∞ incomeTypesList ÂÖÉÁ¥†');
                return;
            }
            
            console.log('Âä†ËΩΩÊî∂ÂÖ•Á±ªÂûã:', systemSettings.incomeTypes);
            list.innerHTML = '';
            
            if (systemSettings.incomeTypes.length === 0) {
                list.innerHTML = '<div class="empty-state">ÊöÇÊó†Êî∂ÂÖ•Á±ªÂûãÔºåËØ∑Ê∑ªÂä†</div>';
                return;
            }
            
            systemSettings.incomeTypes.forEach((type, index) => {
                const item = document.createElement('div');
                item.className = 'settings-item';
                item.innerHTML = `
                    <div class="settings-item-content">
                        <span class="item-index">${index + 1}</span>
                        <span class="item-text" id="incomeType_${index}">${type}</span>
                    </div>
                    <div class="settings-item-actions">
                        <button class="btn btn-secondary btn-small" onclick="editIncomeType(${index})" title="ÁºñËæë">
                            <span>‚úèÔ∏è</span>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="removeIncomeType(${index})" title="Âà†Èô§">
                            <span>üóëÔ∏è</span>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
            console.log('Êî∂ÂÖ•Á±ªÂûãÂàóË°®Â∑≤Âä†ËΩΩÔºåÂÖ±', systemSettings.incomeTypes.length, 'È°π');
        }
        
        // Âä†ËΩΩÈîÄÂîÆ‰∫∫ÂëòÂàóË°®
        function loadSalespersonList() {
            const list = document.getElementById('salespersonList');
            if (!list) {
                console.error('Êâæ‰∏çÂà∞ salespersonList ÂÖÉÁ¥†');
                return;
            }
            
            console.log('Âä†ËΩΩÈîÄÂîÆ‰∫∫Âëò:', systemSettings.salespeople);
            list.innerHTML = '';
            
            if (systemSettings.salespeople.length === 0) {
                list.innerHTML = '<div class="empty-state">ÊöÇÊó†ÈîÄÂîÆ‰∫∫ÂëòÔºåËØ∑Ê∑ªÂä†</div>';
                return;
            }
            
            systemSettings.salespeople.forEach((person, index) => {
                const item = document.createElement('div');
                item.className = 'settings-item';
                const commissionText = person.commissionType === 'ladder' ? 'Èò∂Ê¢ØÂºè' : `${(person.fixedRate*100).toFixed(1)}%`;
                
                item.innerHTML = `
                    <div class="settings-item-content">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="item-index">${index + 1}</span>
                            <div>
                                <div style="font-weight: bold; font-size: 16px; color: #333;">üë§ ${person.name}</div>
                                <div style="font-size: 13px; color: #666; margin-top: 4px;">
                                    üí∞ Âü∫Á°ÄÂ∑•ËµÑ: ¬•${person.baseSalary.toLocaleString()} | 
                                    üìä ÊèêÊàêÊñπÂºè: ${commissionText}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-item-actions">
                        <button class="btn btn-secondary btn-small" onclick="editSalesperson(${index})" title="ÁºñËæëÂü∫Êú¨‰ø°ÊÅØ">
                            <span>‚úèÔ∏è</span>
                        </button>
                        ${person.commissionType === 'ladder' ? 
                            `<button class="btn btn-warning btn-small" onclick="editLadder(${index})" title="ËÆæÁΩÆÈò∂Ê¢ØÊèêÊàê">
                                <span>üéØ</span>
                            </button>` : ''}
                        <button class="btn btn-tertiary btn-small" onclick="viewSalespersonStats(${index})" title="Êü•Áúã‰∏öÁª©">
                            <span>üìä</span>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="removeSalesperson(${index})" title="Âà†Èô§">
                            <span>üóëÔ∏è</span>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
            console.log('ÈîÄÂîÆ‰∫∫ÂëòÂàóË°®Â∑≤Âä†ËΩΩÔºåÂÖ±', systemSettings.salespeople.length, '‰∫∫');
        }
        
        // Ê∑ªÂä†‰∏öÂä°Á±ªÂûã
        function addBusinessType() {
            const input = document.getElementById('newBusinessType');
            const value = input.value.trim();
            
            if (!value) {
                alert('‚ö†Ô∏è ËØ∑ËæìÂÖ•‰∏öÂä°Á±ªÂûã');
                input.focus();
                return;
            }
            
            if (value.length > 20) {
                alert('‚ö†Ô∏è ‰∏öÂä°Á±ªÂûãÂêçÁß∞‰∏çËÉΩË∂ÖËøá20‰∏™Â≠óÁ¨¶');
                input.focus();
                return;
            }
            
            if (systemSettings.businessTypes.includes(value)) {
                alert('‚ö†Ô∏è ËØ•‰∏öÂä°Á±ªÂûãÂ∑≤Â≠òÂú®');
                input.focus();
                return;
            }
            
            systemSettings.businessTypes.push(value);
            saveSystemSettings();
            updateFormOptions();
            loadBusinessTypes();
            input.value = '';
            alert('‚úÖ ‰∏öÂä°Á±ªÂûãÊ∑ªÂä†ÊàêÂäüÔºÅ');
        }
        
        // Âà†Èô§‰∏öÂä°Á±ªÂûã
        function removeBusinessType(index) {
            const typeName = systemSettings.businessTypes[index];
            if (confirm(`‚ö†Ô∏è Á°ÆÂÆöË¶ÅÂà†Èô§‰∏öÂä°Á±ªÂûã"${typeName}"ÂêóÔºü\n\nÂà†Èô§ÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§çÔºÅ`)) {
                systemSettings.businessTypes.splice(index, 1);
                saveSystemSettings();
                updateFormOptions();
                loadBusinessTypes();
                alert('‚úÖ ‰∏öÂä°Á±ªÂûãÂ∑≤Âà†Èô§ÔºÅ');
            }
        }
        
        // Ê∑ªÂä†Êî∂ÂÖ•Á±ªÂûã
        function addIncomeType() {
            const input = document.getElementById('newIncomeType');
            const value = input.value.trim();
            
            if (!value) {
                alert('‚ö†Ô∏è ËØ∑ËæìÂÖ•Êî∂ÂÖ•Á±ªÂûã');
                input.focus();
                return;
            }
            
            if (value.length > 20) {
                alert('‚ö†Ô∏è Êî∂ÂÖ•Á±ªÂûãÂêçÁß∞‰∏çËÉΩË∂ÖËøá20‰∏™Â≠óÁ¨¶');
                input.focus();
                return;
            }
            
            if (systemSettings.incomeTypes.includes(value)) {
                alert('‚ö†Ô∏è ËØ•Êî∂ÂÖ•Á±ªÂûãÂ∑≤Â≠òÂú®');
                input.focus();
                return;
            }
            
            systemSettings.incomeTypes.push(value);
            saveSystemSettings();
            updateFormOptions();
            loadIncomeTypes();
            input.value = '';
            alert('‚úÖ Êî∂ÂÖ•Á±ªÂûãÊ∑ªÂä†ÊàêÂäüÔºÅ');
        }
        
        // Âà†Èô§Êî∂ÂÖ•Á±ªÂûã
        function removeIncomeType(index) {
            const typeName = systemSettings.incomeTypes[index];
            if (confirm(`‚ö†Ô∏è Á°ÆÂÆöË¶ÅÂà†Èô§Êî∂ÂÖ•Á±ªÂûã"${typeName}"ÂêóÔºü\n\nÂà†Èô§ÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§çÔºÅ`)) {
                systemSettings.incomeTypes.splice(index, 1);
                saveSystemSettings();
                updateFormOptions();
                loadIncomeTypes();
                alert('‚úÖ Êî∂ÂÖ•Á±ªÂûãÂ∑≤Âà†Èô§ÔºÅ');
            }
        }
        
        // Âä†ËΩΩÂÆ¢Êà∑Êù•Ê∫êÂàóË°®
        function loadCustomerSources() {
            const list = document.getElementById('customerSourcesList');
            if (!list) {
                console.error('Êâæ‰∏çÂà∞ customerSourcesList ÂÖÉÁ¥†');
                return;
            }
            
            console.log('Âä†ËΩΩÂÆ¢Êà∑Êù•Ê∫ê:', systemSettings.customerSources);
            list.innerHTML = '';
            
            if (systemSettings.customerSources.length === 0) {
                list.innerHTML = '<div class="empty-state">ÊöÇÊó†ÂÆ¢Êà∑Êù•Ê∫êÔºåËØ∑Ê∑ªÂä†</div>';
                return;
            }
            
            systemSettings.customerSources.forEach((source, index) => {
                const item = document.createElement('div');
                item.className = 'settings-item';
                item.innerHTML = `
                    <div class="settings-item-content">
                        <span class="item-index">${index + 1}</span>
                        <span class="item-text" id="customerSource_${index}">${source}</span>
                    </div>
                    <div class="settings-item-actions">
                        <button class="btn btn-secondary btn-small" onclick="editCustomerSource(${index})" title="ÁºñËæë">
                            <span>‚úèÔ∏è</span>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="removeCustomerSource(${index})" title="Âà†Èô§">
                            <span>üóëÔ∏è</span>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
            console.log('ÂÆ¢Êà∑Êù•Ê∫êÂàóË°®Â∑≤Âä†ËΩΩÔºåÂÖ±', systemSettings.customerSources.length, 'È°π');
        }
        
        // Ê∑ªÂä†ÂÆ¢Êà∑Êù•Ê∫ê
        function addCustomerSource() {
            const input = document.getElementById('newCustomerSource');
            const value = input.value.trim();
            
            if (!value) {
                alert('‚ö†Ô∏è ËØ∑ËæìÂÖ•ÂÆ¢Êà∑Êù•Ê∫ê');
                input.focus();
                return;
            }
            
            if (value.length > 20) {
                alert('‚ö†Ô∏è ÂÆ¢Êà∑Êù•Ê∫êÂêçÁß∞‰∏çËÉΩË∂ÖËøá20‰∏™Â≠óÁ¨¶');
                input.focus();
                return;
            }
            
            if (systemSettings.customerSources.includes(value)) {
                alert('‚ö†Ô∏è ËØ•ÂÆ¢Êà∑Êù•Ê∫êÂ∑≤Â≠òÂú®');
                input.focus();
                return;
            }
            
            systemSettings.customerSources.push(value);
            saveSystemSettings();
            updateFormOptions();
            loadCustomerSources();
            input.value = '';
            alert('‚úÖ ÂÆ¢Êà∑Êù•Ê∫êÊ∑ªÂä†ÊàêÂäüÔºÅ');
        }
        
        // Âà†Èô§ÂÆ¢Êà∑Êù•Ê∫ê
        function removeCustomerSource(index) {
            const sourceName = systemSettings.customerSources[index];
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîÄÂîÆËÆ∞ÂΩï‰ΩøÁî®Ê≠§ÂÆ¢Êà∑Êù•Ê∫ê
            const usedRecords = salesData.filter(record => record.customerSource === sourceName);
            
            let confirmMessage = `‚ö†Ô∏è Á°ÆÂÆöË¶ÅÂà†Èô§ÂÆ¢Êà∑Êù•Ê∫ê"${sourceName}"ÂêóÔºü\n\n`;
            if (usedRecords.length > 0) {
                confirmMessage += `Ê≥®ÊÑèÔºöÊúâ ${usedRecords.length} Êù°ÈîÄÂîÆËÆ∞ÂΩïÊ≠£Âú®‰ΩøÁî®Ê≠§ÂÆ¢Êà∑Êù•Ê∫ê„ÄÇ\nÂà†Èô§ÂêéËøô‰∫õËÆ∞ÂΩïÁöÑÂÆ¢Êà∑Êù•Ê∫êÂ∞ÜË¢´Ê∏ÖÁ©∫„ÄÇ\n\n`;
            }
            confirmMessage += 'Âà†Èô§ÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§çÔºÅ';
            
            if (confirm(confirmMessage)) {
                // Ê∏ÖÁ©∫Áõ∏ÂÖ≥ÈîÄÂîÆËÆ∞ÂΩïÁöÑÂÆ¢Êà∑Êù•Ê∫ê
                if (usedRecords.length > 0) {
                    salesData.forEach(record => {
                        if (record.customerSource === sourceName) {
                            record.customerSource = '';
                        }
                    });
                    localStorage.setItem('salesData', JSON.stringify(salesData));
                }
                
                systemSettings.customerSources.splice(index, 1);
                saveSystemSettings();
                updateFormOptions();
                loadCustomerSources();
                loadTableData(); // Âà∑Êñ∞Ë°®Ê†ºÊòæÁ§∫
                
                if (usedRecords.length > 0) {
                    alert(`‚úÖ ÂÆ¢Êà∑Êù•Ê∫êÂ∑≤Âà†Èô§ÔºÅÂ∑≤Ê∏ÖÁ©∫ ${usedRecords.length} Êù°ËÆ∞ÂΩïÁöÑÂÆ¢Êà∑Êù•Ê∫êÂ≠óÊÆµ„ÄÇ`);
                } else {
                    alert('‚úÖ ÂÆ¢Êà∑Êù•Ê∫êÂ∑≤Âà†Èô§ÔºÅ');
                }
            }
        }
        
        // ÁºñËæë‰∏öÂä°Á±ªÂûã
        function editBusinessType(index) {
            const currentValue = systemSettings.businessTypes[index];
            const newValue = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑ‰∏öÂä°Á±ªÂûãÂêçÁß∞:', currentValue);
            
            if (newValue && newValue.trim() !== '' && newValue !== currentValue) {
                const trimmedValue = newValue.trim();
                
                // Ê£ÄÊü•ÊòØÂê¶ÈáçÂ§ç
                if (systemSettings.businessTypes.includes(trimmedValue)) {
                    alert('ËØ•‰∏öÂä°Á±ªÂûãÂ∑≤Â≠òÂú®ÔºÅ');
                    return;
                }
                
                systemSettings.businessTypes[index] = trimmedValue;
                saveSystemSettings();
                updateFormOptions();
                loadBusinessTypes();
                alert('‚úÖ ‰∏öÂä°Á±ªÂûãÂ∑≤Êõ¥Êñ∞ÔºÅ');
            }
        }
        
        // ÁºñËæëÊî∂ÂÖ•Á±ªÂûã
        function editIncomeType(index) {
            const currentValue = systemSettings.incomeTypes[index];
            const newValue = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊî∂ÂÖ•Á±ªÂûãÂêçÁß∞:', currentValue);
            
            if (newValue && newValue.trim() !== '' && newValue !== currentValue) {
                const trimmedValue = newValue.trim();
                
                // Ê£ÄÊü•ÊòØÂê¶ÈáçÂ§ç
                if (systemSettings.incomeTypes.includes(trimmedValue)) {
                    alert('ËØ•Êî∂ÂÖ•Á±ªÂûãÂ∑≤Â≠òÂú®ÔºÅ');
                    return;
                }
                
                systemSettings.incomeTypes[index] = trimmedValue;
                saveSystemSettings();
                updateFormOptions();
                loadIncomeTypes();
                alert('‚úÖ Êî∂ÂÖ•Á±ªÂûãÂ∑≤Êõ¥Êñ∞ÔºÅ');
            }
        }
        
        // ÁºñËæëÂÆ¢Êà∑Êù•Ê∫ê
        function editCustomerSource(index) {
            const currentValue = systemSettings.customerSources[index];
            const newValue = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂÆ¢Êà∑Êù•Ê∫êÂêçÁß∞:', currentValue);
            
            if (newValue && newValue.trim() !== '' && newValue !== currentValue) {
                const trimmedValue = newValue.trim();
                
                // Ê£ÄÊü•ÊòØÂê¶ÈáçÂ§ç
                if (systemSettings.customerSources.includes(trimmedValue)) {
                    alert('ËØ•ÂÆ¢Êà∑Êù•Ê∫êÂ∑≤Â≠òÂú®ÔºÅ');
                    return;
                }
                
                systemSettings.customerSources[index] = trimmedValue;
                saveSystemSettings();
                updateFormOptions();
                loadCustomerSources();
                alert('‚úÖ ÂÆ¢Êà∑Êù•Ê∫êÂ∑≤Êõ¥Êñ∞ÔºÅ');
            }
        }
        
        // Êü•ÁúãÈîÄÂîÆ‰∫∫Âëò‰∏öÁª©
        function viewSalespersonStats(index) {
            const person = systemSettings.salespeople[index];
            const currentMonth = new Date().toISOString().substring(0, 7);
            const monthRecords = salesData.filter(record => 
                record.date.startsWith(currentMonth) && record.salesperson === person.name
            );
            
            const totalSales = monthRecords.reduce((sum, record) => sum + record.amount, 0);
            const recordCount = monthRecords.length;
            const avgSale = recordCount > 0 ? totalSales / recordCount : 0;
            
            // ËÆ°ÁÆóÊèêÊàê
            let commission = 0;
            if (person.commissionType === 'ladder' && person.ladderRates.length > 0) {
                commission = calculateLadderCommission(totalSales, person.ladderRates);
            } else {
                commission = totalSales * person.fixedRate;
            }
            
            const totalSalary = person.baseSalary + commission;
            
            alert(`üìä ${person.name} Êú¨Êúà‰∏öÁª©ÁªüËÆ°\n\n` +
                  `üèÜ ÈîÄÂîÆÊÄªÈ¢ù: ¬•${totalSales.toLocaleString()}\n` +
                  `üìà Êàê‰∫§Á¨îÊï∞: ${recordCount} Á¨î\n` +
                  `üí∞ Âπ≥ÂùáËÆ¢Âçï: ¬•${avgSale.toLocaleString()}\n` +
                  `üéØ ÊèêÊàêÈáëÈ¢ù: ¬•${commission.toLocaleString()}\n` +
                  `üíµ È¢ÑËÆ°ÊÄªÂ∑•ËµÑ: ¬•${totalSalary.toLocaleString()}`);
        }
        
        // ÂàáÊç¢ÊèêÊàêËæìÂÖ•Ê°ÜÊòæÁ§∫
        function toggleCommissionInput() {
            const typeSelect = document.getElementById('newCommissionType');
            const rateInput = document.getElementById('newFixedRate');
            
            if (typeSelect.value === 'fixed') {
                rateInput.style.display = 'inline-block';
                rateInput.placeholder = 'ÊèêÊàê%';
            } else {
                rateInput.style.display = 'none';
            }
        }

        // Ê∑ªÂä†ÈîÄÂîÆ‰∫∫Âëò
        function addSalesperson() {
            const nameInput = document.getElementById('newSalesperson');
            const salaryInput = document.getElementById('newBaseSalary');
            const typeSelect = document.getElementById('newCommissionType');
            const rateInput = document.getElementById('newFixedRate');
            
            const name = nameInput.value.trim();
            const baseSalary = parseFloat(salaryInput.value) || 0;
            const commissionType = typeSelect.value;
            const fixedRate = commissionType === 'fixed' ? (parseFloat(rateInput.value) || 6) / 100 : 0;
            
            if (!name) {
                alert('ËØ∑ËæìÂÖ•ÈîÄÂîÆ‰∫∫ÂëòÂßìÂêç');
                return;
            }
            
            if (baseSalary <= 0) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂü∫Á°ÄÂ∑•ËµÑ');
                return;
            }
            
            if (commissionType === 'fixed' && (parseFloat(rateInput.value) || 0) <= 0) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊèêÊàêÊØî‰æã');
                return;
            }
            
            if (systemSettings.salespeople.some(p => p.name === name)) {
                alert('ËØ•ÈîÄÂîÆ‰∫∫ÂëòÂ∑≤Â≠òÂú®');
                return;
            }
            
            const newPerson = {
                name: name,
                baseSalary: baseSalary,
                commissionType: commissionType,
                fixedRate: fixedRate,
                ladderRates: []
            };
            
            systemSettings.salespeople.push(newPerson);
            saveSystemSettings();
            updateFormOptions();
            loadSalespersonList();
            updateSalaryDetails();
            
            // Â¶ÇÊûúÂΩìÂâçÂú®ÁªüËÆ°ÂàÜÊûêÊ†áÁ≠æÔºåÂàôÊõ¥Êñ∞ÁªüËÆ°
            if (document.getElementById('statistics').classList.contains('active')) {
                setTimeout(() => updateAllStatistics(), 50);
            }
            
            // Ê∏ÖÁ©∫ËæìÂÖ•
            nameInput.value = '';
            salaryInput.value = '';
            rateInput.value = '';
            typeSelect.value = 'fixed';
            toggleCommissionInput();
        }
        
        // ÁºñËæëÈîÄÂîÆ‰∫∫Âëò
        function editSalesperson(index) {
            const person = systemSettings.salespeople[index];
            
            // ÂàõÂª∫ÁºñËæëË°®ÂçïÁöÑHTML
            const editForm = `
                <div style="background: white; padding: 20px; border-radius: 10px; max-width: 400px; margin: 20px auto;">
                    <h4>ÁºñËæëÈîÄÂîÆ‰∫∫Âëò</h4>
                    <div style="margin-bottom: 15px;">
                        <label>ÂßìÂêç:</label><br>
                        <input type="text" id="editName" value="${person.name}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>Âü∫Á°ÄÂ∑•ËµÑ:</label><br>
                        <input type="number" id="editSalary" value="${person.baseSalary}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>ÊèêÊàêÁ±ªÂûã:</label><br>
                        <select id="editCommissionType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onchange="toggleEditCommissionInput()">
                            <option value="fixed" ${person.commissionType === 'fixed' ? 'selected' : ''}>Âõ∫ÂÆöÊØî‰æã</option>
                            <option value="ladder" ${person.commissionType === 'ladder' ? 'selected' : ''}>Èò∂Ê¢ØÂºè</option>
                        </select>
                    </div>
                    <div id="editFixedRateDiv" style="margin-bottom: 15px; ${person.commissionType === 'fixed' ? '' : 'display: none;'}">
                        <label>ÊèêÊàêÊØî‰æã(%):</label><br>
                        <input type="number" id="editFixedRate" value="${(person.fixedRate * 100).toFixed(1)}" step="0.1" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="text-align: center;">
                        <button class="btn" onclick="saveEditPerson(${index})">‰øùÂ≠ò</button>
                        <button class="btn btn-secondary" onclick="closeEditForm()">ÂèñÊ∂à</button>
                    </div>
                </div>
            `;
            
            // ÂàõÂª∫Ê®°ÊÄÅÊ°Ü
            const modal = document.createElement('div');
            modal.id = 'editPersonModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            modal.innerHTML = editForm;
            document.body.appendChild(modal);
        }
        
        // ÂàáÊç¢ÁºñËæëÊó∂ÁöÑÊèêÊàêËæìÂÖ•Ê°Ü
        function toggleEditCommissionInput() {
            const typeSelect = document.getElementById('editCommissionType');
            const rateDiv = document.getElementById('editFixedRateDiv');
            
            if (typeSelect.value === 'fixed') {
                rateDiv.style.display = 'block';
            } else {
                rateDiv.style.display = 'none';
            }
        }
        
        // ‰øùÂ≠òÁºñËæëÁöÑÈîÄÂîÆ‰∫∫Âëò
        function saveEditPerson(index) {
            const person = systemSettings.salespeople[index];
            const newName = document.getElementById('editName').value.trim();
            const newBaseSalary = parseFloat(document.getElementById('editSalary').value) || 0;
            const newCommissionType = document.getElementById('editCommissionType').value;
            const newFixedRate = newCommissionType === 'fixed' ? (parseFloat(document.getElementById('editFixedRate').value) || 0) / 100 : person.fixedRate;
            
            if (!newName) {
                alert('ËØ∑ËæìÂÖ•ÈîÄÂîÆ‰∫∫ÂëòÂßìÂêç');
                return;
            }
            
            if (newBaseSalary <= 0) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂü∫Á°ÄÂ∑•ËµÑ');
                return;
            }
            
            if (newCommissionType === 'fixed' && newFixedRate <= 0) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊèêÊàêÊØî‰æã');
                return;
            }
            
            // Ê£ÄÊü•ÂßìÂêçÊòØÂê¶ÈáçÂ§ç
            if (newName !== person.name && systemSettings.salespeople.some(p => p.name === newName)) {
                alert('ËØ•ÈîÄÂîÆ‰∫∫ÂëòÂßìÂêçÂ∑≤Â≠òÂú®');
                return;
            }
            
            // Êõ¥Êñ∞Êï∞ÊçÆ
            person.name = newName;
            person.baseSalary = newBaseSalary;
            person.commissionType = newCommissionType;
            person.fixedRate = newFixedRate;
            
            // Â¶ÇÊûú‰ªéÈò∂Ê¢ØÂºèÊîπ‰∏∫Âõ∫ÂÆöÊØî‰æãÔºåÊ∏ÖÁ©∫Èò∂Ê¢ØÊï∞ÊçÆ
            if (newCommissionType === 'fixed') {
                person.ladderRates = [];
            }
            
            saveSystemSettings();
            updateFormOptions();
            loadSalespersonList();
            updateSalaryDetails();
            closeEditForm();
            
            // Â¶ÇÊûúÂΩìÂâçÂú®ÁªüËÆ°ÂàÜÊûêÊ†áÁ≠æÔºåÂàôÊõ¥Êñ∞ÁªüËÆ°
            if (document.getElementById('statistics').classList.contains('active')) {
                setTimeout(() => updateAllStatistics(), 50);
            }
        }
        
        // ÂÖ≥Èó≠ÁºñËæëË°®Âçï
        function closeEditForm() {
            const modal = document.getElementById('editPersonModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Âà†Èô§ÈîÄÂîÆ‰∫∫Âëò
        function removeSalesperson(index) {
            const person = systemSettings.salespeople[index];
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîÄÂîÆËÆ∞ÂΩï‰ΩøÁî®Ê≠§ÈîÄÂîÆ‰∫∫Âëò
            const usedRecords = salesData.filter(record => record.salesperson === person.name);
            
            let confirmMessage = `‚ö†Ô∏è Á°ÆÂÆöË¶ÅÂà†Èô§ÈîÄÂîÆ‰∫∫Âëò"${person.name}"ÂêóÔºü\n\n`;
            if (usedRecords.length > 0) {
                confirmMessage += `Ê≥®ÊÑèÔºöÊúâ ${usedRecords.length} Êù°ÈîÄÂîÆËÆ∞ÂΩïÂ±û‰∫éÊ≠§ÈîÄÂîÆ‰∫∫Âëò„ÄÇ\nÂà†Èô§ÂêéËøô‰∫õËÆ∞ÂΩïÁöÑÈîÄÂîÆ‰∫∫ÂëòÂ∞ÜËÆæÁΩÆ‰∏∫"ÂÖ∂‰ªñ"„ÄÇ\n\n`;
            }
            confirmMessage += 'Âà†Èô§ÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§çÔºÅ\nÁõ∏ÂÖ≥ÁöÑÂ∑•ËµÑËÆ°ÁÆóÂíåÁªüËÆ°Êï∞ÊçÆ‰πü‰ºöÂèóÂà∞ÂΩ±Âìç„ÄÇ';
            
            if (confirm(confirmMessage)) {
                // Â∞ÜÁõ∏ÂÖ≥ÈîÄÂîÆËÆ∞ÂΩïÁöÑÈîÄÂîÆ‰∫∫ÂëòËÆæÁΩÆ‰∏∫"ÂÖ∂‰ªñ"
                if (usedRecords.length > 0) {
                    salesData.forEach(record => {
                        if (record.salesperson === person.name) {
                            record.salesperson = 'ÂÖ∂‰ªñ';
                        }
                    });
                    localStorage.setItem('salesData', JSON.stringify(salesData));
                }
                
                systemSettings.salespeople.splice(index, 1);
                saveSystemSettings();
                updateFormOptions();
                loadSalespersonList();
                updateSalaryDetails();
                loadTableData(); // Âà∑Êñ∞Ë°®Ê†ºÊòæÁ§∫
                
                // Â¶ÇÊûúÂΩìÂâçÂú®ÁªüËÆ°ÂàÜÊûêÊ†áÁ≠æÔºåÂàôÊõ¥Êñ∞ÁªüËÆ°
                if (document.getElementById('statistics').classList.contains('active')) {
                    setTimeout(() => updateAllStatistics(), 50);
                }
                
                if (usedRecords.length > 0) {
                    alert(`‚úÖ ÈîÄÂîÆ‰∫∫ÂëòÂ∑≤Âà†Èô§ÔºÅÂ∑≤Â∞Ü ${usedRecords.length} Êù°ËÆ∞ÂΩïÁöÑÈîÄÂîÆ‰∫∫ÂëòËÆæÁΩÆ‰∏∫"ÂÖ∂‰ªñ"„ÄÇ`);
                } else {
                    alert('‚úÖ ÈîÄÂîÆ‰∫∫ÂëòÂ∑≤Âà†Èô§ÔºÅ');
                }
            }
        }
        
        // ÁºñËæëÈò∂Ê¢ØÂºèÊèêÊàê
        function editLadder(index) {
            currentEditPersonIndex = index;
            const person = systemSettings.salespeople[index];
            
            document.getElementById('currentEditPerson').textContent = person.name;
            document.getElementById('ladderModal').style.display = 'block';
            
            loadLadderEditor(person.ladderRates);
        }
        
        // Âä†ËΩΩÈò∂Ê¢ØÁºñËæëÂô®
        function loadLadderEditor(ladderRates) {
            const editor = document.getElementById('ladderEditor');
            editor.innerHTML = '';
            
            ladderRates.forEach((ladder, index) => {
                addLadderItem(ladder.minAmount, ladder.rate, index);
            });
            
            // Â¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆÈò∂Ê¢ØÔºåÂä†ËΩΩÊ†áÂáÜÈò∂Ê¢ØÊ®°Êùø
            if (ladderRates.length === 0) {
                addLadderItem(0, 0.06, 0);          // ‚â§ 3‰∏áÂÖÉÔºö6%
                addLadderItem(30000, 0.15, 1);      // 3‰∏á-10‰∏áÂÖÉÔºö15%
                addLadderItem(100000, 0.20, 2);     // 10‰∏á-20‰∏áÂÖÉÔºö20%
                addLadderItem(200000, 0.25, 3);     // > 20‰∏áÂÖÉÔºö25%
            }
        }
        
        // Ê∑ªÂä†Èò∂Ê¢ØÈ°πÁõÆ
        function addLadderItem(minAmount = 0, rate = 0.06, index = -1) {
            const editor = document.getElementById('ladderEditor');
            const item = document.createElement('div');
            item.className = 'ladder-item';
            // Â∞ÜÂ∞èÊï∞ËΩ¨Êç¢‰∏∫ÁôæÂàÜÊØîÊòæÁ§∫
            const displayRate = (rate * 100).toFixed(1);
            
            // Ê†πÊçÆÈáëÈ¢ùÊòæÁ§∫‰∏çÂêåÁöÑÊèêÁ§∫ÊñáÂ≠ó
            let amountLabel = '';
            if (minAmount === 0) {
                amountLabel = 'ÈîÄÂîÆÈ¢ù ‚â§ 3‰∏áÂÖÉ';
            } else if (minAmount === 30000) {
                amountLabel = 'ÈîÄÂîÆÈ¢ù > 3‰∏áÂÖÉ';
            } else if (minAmount === 100000) {
                amountLabel = 'ÈîÄÂîÆÈ¢ù > 10‰∏áÂÖÉ';
            } else if (minAmount === 200000) {
                amountLabel = 'ÈîÄÂîÆÈ¢ù > 20‰∏áÂÖÉ';
            } else {
                amountLabel = `ÈîÄÂîÆÈ¢ù ‚â• ${(minAmount/10000).toFixed(1)}‰∏áÂÖÉ`;
            }
            
            item.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                    <span style="min-width: 100px; font-size: 12px; color: #666;">${amountLabel}</span>
                    <input type="number" class="min-amount" value="${minAmount}" placeholder="Ëµ∑ÂßãÈáëÈ¢ù" style="width: 80px;">
                    <span>ÂÖÉÔºåÊèêÊàê:</span>
                    <input type="number" class="rate" value="${displayRate}" step="0.1" placeholder="ÊØî‰æã" min="0" style="width: 60px;">
                    <span>%</span>
                    <button class="btn btn-danger btn-small" onclick="removeLadderItem(this)">Âà†Èô§</button>
                </div>
            `;
            editor.appendChild(item);
        }
        
        // Âà†Èô§Èò∂Ê¢ØÈ°πÁõÆ
        function removeLadderItem(button) {
            button.parentElement.remove();
        }
        
        // Ê∑ªÂä†Êñ∞Èò∂Ê¢ØÁ≠âÁ∫ß
        function addLadderLevel() {
            addLadderItem();
        }

        // ËÆæÁΩÆÊ†áÂáÜÈò∂Ê¢Ø
        function setStandardLadder() {
            if (confirm('Á°ÆÂÆöË¶ÅËÆæÁΩÆ‰∏∫Ê†áÂáÜÈò∂Ê¢ØÂêóÔºüËøôÂ∞ÜÊ∏ÖÈô§ÂΩìÂâçÊâÄÊúâÈò∂Ê¢ØËÆæÁΩÆ„ÄÇ')) {
                const editor = document.getElementById('ladderEditor');
                editor.innerHTML = '';
                
                // Ê∑ªÂä†Ê†áÂáÜÈò∂Ê¢Ø
                addLadderItem(0, 0.06, 0);          // ‚â§ 3‰∏áÂÖÉÔºö6%
                addLadderItem(30000, 0.15, 1);      // 3‰∏á-10‰∏áÂÖÉÔºö15%
                addLadderItem(100000, 0.20, 2);     // 10‰∏á-20‰∏áÂÖÉÔºö20%
                addLadderItem(200000, 0.25, 3);     // > 20‰∏áÂÖÉÔºö25%
            }
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâÈò∂Ê¢Ø
        function clearAllLadders() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÈò∂Ê¢ØËÆæÁΩÆÂêóÔºü')) {
                const editor = document.getElementById('ladderEditor');
                editor.innerHTML = '';
            }
        }
        
        // ‰øùÂ≠òÈò∂Ê¢ØËÆæÁΩÆ
        function saveLadderSettings() {
            if (currentEditPersonIndex === -1) return;
            
            const items = document.querySelectorAll('.ladder-item');
            const ladderRates = [];
            
            items.forEach(item => {
                const minAmount = parseFloat(item.querySelector('.min-amount').value) || 0;
                const ratePercent = parseFloat(item.querySelector('.rate').value) || 0;
                const rate = ratePercent / 100; // Â∞ÜÁôæÂàÜÊØîËΩ¨Êç¢‰∏∫Â∞èÊï∞
                
                if (minAmount >= 0 && rate >= 0) {
                    ladderRates.push({ minAmount, rate });
                }
            });
            
            // ÊåâÊúÄ‰ΩéÈáëÈ¢ùÊéíÂ∫è
            ladderRates.sort((a, b) => a.minAmount - b.minAmount);
            
            systemSettings.salespeople[currentEditPersonIndex].ladderRates = ladderRates;
            saveSystemSettings();
            loadSalespersonList();
            updateSalaryDetails();
            closeLadderModal();
            
            // Â¶ÇÊûúÂΩìÂâçÂú®ÁªüËÆ°ÂàÜÊûêÊ†áÁ≠æÔºåÂàôÊõ¥Êñ∞ÁªüËÆ°
            if (document.getElementById('statistics').classList.contains('active')) {
                setTimeout(() => updateAllStatistics(), 50);
            }
            alert('‚úÖ Èò∂Ê¢ØÂºèÊèêÊàêËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
        }
        
        // ÂÖ≥Èó≠Èò∂Ê¢ØÊ®°ÊÄÅÊ°Ü
        function closeLadderModal() {
            document.getElementById('ladderModal').style.display = 'none';
            currentEditPersonIndex = -1;
        }

                // ÈáçÁΩÆÊâÄÊúâËÆæÁΩÆ
        function resetAllSettings() {
            if (confirm('‚ö†Ô∏è Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÁ≥ªÁªüËÆæÁΩÆÂêóÔºü\n\nËøôÂ∞Ü‰ºöÔºö\n‚Ä¢ ÊÅ¢Â§çÈªòËÆ§ÁöÑ‰∏öÂä°Á±ªÂûã„ÄÅÊî∂ÂÖ•Á±ªÂûã„ÄÅÂÆ¢Êà∑Êù•Ê∫ê\n‚Ä¢ Ê∏ÖÁ©∫ÊâÄÊúâÈîÄÂîÆ‰∫∫ÂëòËÆæÁΩÆ\n‚Ä¢ ‰∏ç‰ºöÂà†Èô§ÈîÄÂîÆËÆ∞ÂΩïÊï∞ÊçÆ\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                if (confirm('üî¥ ÊúÄÂêéÁ°ÆËÆ§ÔºöÁúüÁöÑË¶ÅÈáçÁΩÆÊâÄÊúâËÆæÁΩÆÂêóÔºü')) {
                    // ÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆ
                    systemSettings = {
                        businessTypes: ['Âí®ËØ¢ÊúçÂä°', 'Âí®ËØ¢È¶ñÊ¨æ', 'Âí®ËØ¢Â∞æÊ¨æ', 'Èô™Ë∑ëÊúçÂä°', 'Èô™Ë∑ëÈ¶ñ‰ªò', 'Èô™Ë∑ëÂ∞æÊ¨æ', 'ÂüπËÆ≠ÊúçÂä°', 'ÂüπËÆ≠Âç†‰Ωç', 'ÂÖ∂‰ªñ'],
                        incomeTypes: ['ÊäºÈáë', 'ÂüπËÆ≠Êî∂ÂÖ•', 'Êó•Á≠æÊî∂ÂÖ•', 'Ëã±Á≠æÊî∂ÂÖ•', 'ÁæéÁ≠æÊî∂ÂÖ•', 'Âä†Á≠æÊî∂ÂÖ•', 'Êæ≥Á≠æÊî∂ÂÖ•', 'Âí®ËØ¢Êî∂ÂÖ•', 'Êó•ÁßüÊî∂ÂÖ•', 'ÂÖ∂‰ªñÊî∂ÂÖ•'],
                        customerSources: ['Ëá™ÊúâÂÆ¢Êà∑', 'ËøêËê•Á∫øÁ¥¢', 'ËøêËê•ËΩ¨‰ªãÁªç', 'ÂÆ¢Êà∑ËΩ¨‰ªãÁªç', 'ÁÆ°ÁêÜÂÜÖÊé®'],
                        salespeople: []
                    };
                    
                    saveSystemSettings();
                    updateFormOptions();
                    loadSettingsData();
                    
                    alert('‚úÖ Á≥ªÁªüËÆæÁΩÆÂ∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§Áä∂ÊÄÅÔºÅ');
                }
            }
        }
        
        // ÂØºÂá∫ËÆæÁΩÆ
        function exportSettings() {
            const settingsData = {
                timestamp: new Date().toISOString(),
                version: '1.3',
                settings: systemSettings
            };
            
            const blob = new Blob([JSON.stringify(settingsData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Á≥ªÁªüËÆæÁΩÆ_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('‚úÖ Á≥ªÁªüËÆæÁΩÆÂ∑≤ÂØºÂá∫ÔºÅ');
        }
        
        // ÂØºÂÖ•ËÆæÁΩÆ
        function importSettings() {
            const file = document.getElementById('importSettingsFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.settings) {
                        if (confirm('Á°ÆÂÆöË¶ÅÂØºÂÖ•ËÆæÁΩÆÂêóÔºüËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÊâÄÊúâÁ≥ªÁªüËÆæÁΩÆÔºÅ')) {
                            systemSettings = importedData.settings;
                            
                            // Á°Æ‰øùÂøÖË¶ÅÂ≠óÊÆµÂ≠òÂú®
                            if (!systemSettings.businessTypes) systemSettings.businessTypes = [];
                            if (!systemSettings.incomeTypes) systemSettings.incomeTypes = [];
                            if (!systemSettings.customerSources) systemSettings.customerSources = [];
                            if (!systemSettings.salespeople) systemSettings.salespeople = [];
                            
                            saveSystemSettings();
                            updateFormOptions();
                            loadSettingsData();
                            updateSalaryDetails();
                            
                            alert('‚úÖ ËÆæÁΩÆÂØºÂÖ•ÊàêÂäüÔºÅ');
                        }
                    } else {
                        alert('‚ùå ÂØºÂÖ•Êñá‰ª∂Ê†ºÂºèÈîôËØØÔºÅ');
                    }
                } catch (error) {
                    console.error('ÂØºÂÖ•Â§±Ë¥•:', error);
                    alert('‚ùå ÂØºÂÖ•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂Ê†ºÂºèÔºÅ');
                }
            };
            reader.readAsText(file);
            
            // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©
            document.getElementById('importSettingsFile').value = '';
        }

        // Êï∞ÊçÆÂêåÊ≠•Ê£ÄÊü•Âíå‰øÆÂ§ç
        function syncDataConsistency() {
            console.log('=== ÂºÄÂßãÊï∞ÊçÆÂêåÊ≠•Ê£ÄÊü• ===');
            
            let hasChanges = false;
            let report = 'üìä Êï∞ÊçÆÂêåÊ≠•Êä•ÂëäÔºö\n\n';
            
            // Ê£ÄÊü•Âπ∂‰øÆÂ§çÈîÄÂîÆËÆ∞ÂΩï‰∏≠ÁöÑÊó†ÊïàÂÆ¢Êà∑Êù•Ê∫ê
            let invalidSourceCount = 0;
            salesData.forEach(record => {
                if (record.customerSource && !systemSettings.customerSources.includes(record.customerSource)) {
                    console.log(`ÂèëÁé∞Êó†ÊïàÂÆ¢Êà∑Êù•Ê∫ê: ${record.customerSource}`);
                    record.customerSource = ''; // Ê∏ÖÁ©∫Êó†ÊïàÁöÑÂÆ¢Êà∑Êù•Ê∫ê
                    invalidSourceCount++;
                    hasChanges = true;
                }
            });
            
            if (invalidSourceCount > 0) {
                report += `üîß ‰øÆÂ§ç‰∫Ü ${invalidSourceCount} Êù°ËÆ∞ÂΩïÁöÑÊó†ÊïàÂÆ¢Êà∑Êù•Ê∫ê\n`;
            }
            
            // Ê£ÄÊü•Âπ∂‰øÆÂ§çÈîÄÂîÆËÆ∞ÂΩï‰∏≠ÁöÑÊó†ÊïàÈîÄÂîÆ‰∫∫Âëò
            let invalidSalespersonCount = 0;
            const validSalespersonNames = systemSettings.salespeople.map(p => p.name).concat(['ÂÖ∂‰ªñ']);
            salesData.forEach(record => {
                if (record.salesperson && !validSalespersonNames.includes(record.salesperson)) {
                    console.log(`ÂèëÁé∞Êó†ÊïàÈîÄÂîÆ‰∫∫Âëò: ${record.salesperson}`);
                    record.salesperson = 'ÂÖ∂‰ªñ'; // ËÆæÁΩÆ‰∏∫"ÂÖ∂‰ªñ"
                    invalidSalespersonCount++;
                    hasChanges = true;
                }
            });
            
            if (invalidSalespersonCount > 0) {
                report += `üîß ‰øÆÂ§ç‰∫Ü ${invalidSalespersonCount} Êù°ËÆ∞ÂΩïÁöÑÊó†ÊïàÈîÄÂîÆ‰∫∫Âëò\n`;
            }
            
            // Ê£ÄÊü•Âπ∂‰øÆÂ§çÈîÄÂîÆËÆ∞ÂΩï‰∏≠ÁöÑÊó†Êïà‰∏öÂä°Á±ªÂûã
            let invalidBusinessTypeCount = 0;
            salesData.forEach(record => {
                if (record.businessType && !systemSettings.businessTypes.includes(record.businessType)) {
                    console.log(`ÂèëÁé∞Êó†Êïà‰∏öÂä°Á±ªÂûã: ${record.businessType}`);
                    // ‰øùÁïôÂéüÂÄº‰ΩÜÊ∑ªÂä†Âà∞Á≥ªÁªüËÆæÁΩÆ‰∏≠
                    if (record.businessType.trim()) {
                        systemSettings.businessTypes.push(record.businessType);
                        invalidBusinessTypeCount++;
                        hasChanges = true;
                    }
                }
            });
            
            if (invalidBusinessTypeCount > 0) {
                report += `üìù ÂèëÁé∞Âπ∂Ê∑ªÂä†‰∫Ü ${invalidBusinessTypeCount} ‰∏™Êñ∞ÁöÑ‰∏öÂä°Á±ªÂûã\n`;
            }
            
            // Ê£ÄÊü•Âπ∂‰øÆÂ§çÈîÄÂîÆËÆ∞ÂΩï‰∏≠ÁöÑÊó†ÊïàÊî∂ÂÖ•Á±ªÂûã
            let invalidIncomeTypeCount = 0;
            salesData.forEach(record => {
                if (record.incomeType && !systemSettings.incomeTypes.includes(record.incomeType)) {
                    console.log(`ÂèëÁé∞Êó†ÊïàÊî∂ÂÖ•Á±ªÂûã: ${record.incomeType}`);
                    // ‰øùÁïôÂéüÂÄº‰ΩÜÊ∑ªÂä†Âà∞Á≥ªÁªüËÆæÁΩÆ‰∏≠
                    if (record.incomeType.trim()) {
                        systemSettings.incomeTypes.push(record.incomeType);
                        invalidIncomeTypeCount++;
                        hasChanges = true;
                    }
                }
            });
            
            if (invalidIncomeTypeCount > 0) {
                report += `üìù ÂèëÁé∞Âπ∂Ê∑ªÂä†‰∫Ü ${invalidIncomeTypeCount} ‰∏™Êñ∞ÁöÑÊî∂ÂÖ•Á±ªÂûã\n`;
            }
            
            // ‰øùÂ≠ò‰øÆÂ§çÂêéÁöÑÊï∞ÊçÆ
            if (hasChanges) {
                localStorage.setItem('salesData', JSON.stringify(salesData));
                localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
                report += '\n‚úÖ ÊâÄÊúâÊï∞ÊçÆ‰∏ç‰∏ÄËá¥ÈóÆÈ¢òÂ∑≤‰øÆÂ§çÂπ∂‰øùÂ≠ò';
                console.log('Êï∞ÊçÆÂêåÊ≠•‰øÆÂ§çÂÆåÊàê');
            } else {
                report += '\n‚ú® Êï∞ÊçÆÊ£ÄÊü•ÂÆåÊàêÔºåÊú™ÂèëÁé∞‰∏ç‰∏ÄËá¥ÈóÆÈ¢ò';
                console.log('Êï∞ÊçÆÊ£ÄÊü•ÂÆåÊàêÔºåÊó†ÈúÄ‰øÆÂ§ç');
            }
            
            return { hasChanges, report };
        }
        
        // Âº∫Âà∂Âà∑Êñ∞ÊâÄÊúâÊï∞ÊçÆ
        function forceRefreshAll() {
            console.log('=== Âº∫Âà∂Âà∑Êñ∞ÊâÄÊúâÊï∞ÊçÆ ===');
            
            // È¶ñÂÖàËøõË°åÊï∞ÊçÆÂêåÊ≠•Ê£ÄÊü•
            const syncResult = syncDataConsistency();
            
            // ÈáçÊñ∞ËØªÂèñlocalStorage‰∏≠ÁöÑÊï∞ÊçÆ
            const storedSettings = localStorage.getItem('systemSettings');
            console.log('localStorage‰∏≠ÁöÑsystemSettings:', storedSettings);
            
            if (storedSettings) {
                try {
                    systemSettings = JSON.parse(storedSettings);
                    console.log('ÈáçÊñ∞Âä†ËΩΩÁöÑËÆæÁΩÆ:', systemSettings);
                } catch (error) {
                    console.error('Ëß£ÊûêlocalStorageÊï∞ÊçÆÂ§±Ë¥•:', error);
                }
            }
            
            // ÈáçÊñ∞ËØªÂèñÈîÄÂîÆÊï∞ÊçÆ
            const storedSalesData = localStorage.getItem('salesData');
            if (storedSalesData) {
                try {
                    salesData = JSON.parse(storedSalesData);
                    console.log('ÈáçÊñ∞Âä†ËΩΩÁöÑÈîÄÂîÆÊï∞ÊçÆ:', salesData.length, 'Êù°ËÆ∞ÂΩï');
                } catch (error) {
                    console.error('Ëß£ÊûêÈîÄÂîÆÊï∞ÊçÆÂ§±Ë¥•:', error);
                }
            }
            
            // Âº∫Âà∂Âà∑Êñ∞Ë°®ÂçïÈÄâÈ°π
            updateFormOptions();
            
            // Âº∫Âà∂Âà∑Êñ∞ËÆæÁΩÆÁïåÈù¢
            loadSettingsData();
            
            // Âà∑Êñ∞Ë°®Ê†ºÊï∞ÊçÆ
            loadTableData();
            updateStatistics();
            updateSalaryDetails();
            
            // Â¶ÇÊûúÂΩìÂâçÂú®ÁªüËÆ°ÂàÜÊûêÊ†áÁ≠æÔºåÂàôÊõ¥Êñ∞ÁªüËÆ°
            if (document.getElementById('statistics').classList.contains('active')) {
                setTimeout(() => updateAllStatistics(), 50);
            }
            
            const message = syncResult.hasChanges ? 
                `‚úÖ Âº∫Âà∂Âà∑Êñ∞ÂÆåÊàêÔºÅ\n\n${syncResult.report}` : 
                '‚úÖ Âº∫Âà∂Âà∑Êñ∞ÂÆåÊàêÔºÅÊï∞ÊçÆÁä∂ÊÄÅËâØÂ•Ω„ÄÇ';
            
            alert(message);
        }
        
        // Ë∞ÉËØïËÆæÁΩÆÊï∞ÊçÆÂä†ËΩΩ
        function debugSettingsData() {
            console.log('=== Á≥ªÁªüËÆæÁΩÆË∞ÉËØï‰ø°ÊÅØ ===');
            console.log('ÂΩìÂâçÁ≥ªÁªüËÆæÁΩÆ:', systemSettings);
            console.log('‰∏öÂä°Á±ªÂûãÊï∞Èáè:', systemSettings.businessTypes?.length || 0);
            console.log('Êî∂ÂÖ•Á±ªÂûãÊï∞Èáè:', systemSettings.incomeTypes?.length || 0);
            console.log('ÂÆ¢Êà∑Êù•Ê∫êÊï∞Èáè:', systemSettings.customerSources?.length || 0);
            console.log('ÈîÄÂîÆ‰∫∫ÂëòÊï∞Èáè:', systemSettings.salespeople?.length || 0);
            
            // Ê£ÄÊü•localStorage
            const storedSettings = localStorage.getItem('systemSettings');
            console.log('localStorage‰∏≠ÁöÑËÆæÁΩÆ:', storedSettings);
            
            // Ê£ÄÊü•Ë°®ÂçïÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
            const formElements = [
                'customerSource',
                'salesperson'
            ];
            
            formElements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`Ë°®ÂçïÂÖÉÁ¥† ${id}:`, element ? 'Â≠òÂú®' : '‚ùå‰∏çÂ≠òÂú®');
                if (element) {
                    console.log(`  - ÈÄâÈ°πÊï∞Èáè: ${element.options.length}`);
                    console.log(`  - ÈÄâÈ°πÂÜÖÂÆπ:`, Array.from(element.options).map(opt => opt.text));
                }
            });
            
            // Ê£ÄÊü•ËÆæÁΩÆÁïåÈù¢DOMÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
            const settingsElements = [
                'businessTypesList',
                'incomeTypesList', 
                'customerSourcesList',
                'salespersonList'
            ];
            
            settingsElements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`ËÆæÁΩÆÁïåÈù¢ÂÖÉÁ¥† ${id}:`, element ? 'Â≠òÂú®' : '‚ùå‰∏çÂ≠òÂú®');
                if (element) {
                    console.log(`  - ÂÜÖÂÆπÈïøÂ∫¶: ${element.innerHTML.length}`);
                    console.log(`  - Â≠êÂÖÉÁ¥†Êï∞Èáè: ${element.children.length}`);
                }
            });
            
            // ÊòæÁ§∫Ë∞ÉËØïÊëòË¶Å
            const summary = `
üîç Ë∞ÉËØïÊëòË¶ÅÔºö
‚Ä¢ ‰∏öÂä°Á±ªÂûã: ${systemSettings.businessTypes?.length || 0} È°π
‚Ä¢ Êî∂ÂÖ•Á±ªÂûã: ${systemSettings.incomeTypes?.length || 0} È°π  
‚Ä¢ ÂÆ¢Êà∑Êù•Ê∫ê: ${systemSettings.customerSources?.length || 0} È°π
‚Ä¢ ÈîÄÂîÆ‰∫∫Âëò: ${systemSettings.salespeople?.length || 0} ‰∫∫
‚Ä¢ Ë°®ÂçïÂÆ¢Êà∑Êù•Ê∫êÈÄâÈ°π: ${document.getElementById('customerSource')?.options.length || 0} ‰∏™
‚Ä¢ Ë°®ÂçïÈîÄÂîÆ‰∫∫ÂëòÈÄâÈ°π: ${document.getElementById('salesperson')?.options.length || 0} ‰∏™

ËØ¶ÁªÜ‰ø°ÊÅØËØ∑Êü•ÁúãÊéßÂà∂Âè∞Êó•Âøó„ÄÇ
            `;
            
            alert(summary);
            
            // Â∞ùËØïÈáçÊñ∞Âä†ËΩΩ
            console.log('ÈáçÊñ∞Âä†ËΩΩËÆæÁΩÆÊï∞ÊçÆ...');
            loadSettingsData();
            updateFormOptions();
        }

        // ÊµãËØïÈò∂Ê¢ØÂºèÊèêÊàêËÆ°ÁÆóÔºàÁî®‰∫éÈ™åËØÅËÆ°ÁÆóÊòØÂê¶Ê≠£Á°ÆÔºâ
        function testLadderCommission() {
            const testRates = [
                { minAmount: 0, rate: 0.06 },       // ‚â§ 3‰∏áÂÖÉÔºö6%
                { minAmount: 30000, rate: 0.15 },   // 3‰∏á-10‰∏áÂÖÉÔºö15%
                { minAmount: 100000, rate: 0.20 },  // 10‰∏á-20‰∏áÂÖÉÔºö20%
                { minAmount: 200000, rate: 0.25 }   // > 20‰∏áÂÖÉÔºö25%
            ];
            
            // ÊµãËØïÊ°à‰æã
            const testCases = [
                { sales: 30000, expected: 1800 },     // 3‰∏áÂÖÉ = 3‰∏á√ó6% = 1800ÂÖÉ
                { sales: 80000, expected: 9300 },     // 8‰∏áÂÖÉ = 3‰∏á√ó6% + 5‰∏á√ó15% = 1800+7500 = 9300ÂÖÉ
                { sales: 150000, expected: 22300 },   // 15‰∏áÂÖÉ = 3‰∏á√ó6% + 7‰∏á√ó15% + 5‰∏á√ó20% = 1800+10500+10000 = 22300ÂÖÉ
                { sales: 250000, expected: 44800 }    // 25‰∏áÂÖÉ = 3‰∏á√ó6% + 7‰∏á√ó15% + 10‰∏á√ó20% + 5‰∏á√ó25% = 1800+10500+20000+12500 = 44800ÂÖÉ
            ];
            
            console.log('=== Èò∂Ê¢ØÂºèÊèêÊàêËÆ°ÁÆóÊµãËØï ===');
            testCases.forEach(testCase => {
                const calculated = calculateLadderCommission(testCase.sales, testRates);
                const isCorrect = Math.abs(calculated - testCase.expected) < 0.01;
                                 console.log(`ÈîÄÂîÆÈ¢ù: ${testCase.sales}, ÊúüÊúõÊèêÊàê: ${testCase.expected}, ËÆ°ÁÆóÊèêÊàê: ${calculated.toFixed(2)}, ÁªìÊûú: ${isCorrect ? '‚úÖÊ≠£Á°Æ' : '‚ùåÈîôËØØ'}`);
             });
        }
        
        // Áã¨Á´ãÁöÑÊï∞ÊçÆ‰øÆÂ§çÂáΩÊï∞ÔºàÁî®‰∫éÊåâÈíÆË∞ÉÁî®Ôºâ
        function fixDataConsistency() {
            if (confirm('üîß Á°ÆÂÆöË¶ÅÊ£ÄÊü•Âπ∂‰øÆÂ§çÊï∞ÊçÆ‰∏ÄËá¥ÊÄßÈóÆÈ¢òÂêóÔºü\n\nÊ≠§Êìç‰ΩúÂ∞ÜÔºö\n‚Ä¢ Ê£ÄÊü•ÈîÄÂîÆËÆ∞ÂΩï‰∏≠ÁöÑÊó†ÊïàÊï∞ÊçÆ\n‚Ä¢ Ëá™Âä®‰øÆÂ§çÊàñÊ∏ÖÁêÜ‰∏ç‰∏ÄËá¥ÁöÑÊï∞ÊçÆ\n‚Ä¢ Á°Æ‰øùÊï∞ÊçÆÂÆåÊï¥ÊÄß\n\nÂª∫ËÆÆÂú®‰øÆÂ§çÂâçÂÖàÂ§á‰ªΩÊï∞ÊçÆ„ÄÇ')) {
                const result = syncDataConsistency();
                
                if (result.hasChanges) {
                    // ‰øÆÂ§çÂêéÂà∑Êñ∞ÊâÄÊúâÁïåÈù¢
                    updateFormOptions();
                    loadSettingsData();
                    loadTableData();
                    updateStatistics();
                    updateSalaryDetails();
                    
                    // Â¶ÇÊûúÂΩìÂâçÂú®ÁªüËÆ°ÂàÜÊûêÊ†áÁ≠æÔºåÂàôÊõ¥Êñ∞ÁªüËÆ°
                    if (document.getElementById('statistics').classList.contains('active')) {
                        setTimeout(() => updateAllStatistics(), 50);
                    }
                }
                
                alert(result.report);
            }
        }
        
        // ÂõæË°®ÂÜÖÂÆπÂàáÊç¢ÂáΩÊï∞
        function toggleCardContent(cardId) {
            const contentElement = document.getElementById(cardId + 'Content');
            const toggleButton = event.target;
            
            if (contentElement) {
                if (contentElement.style.display === 'none') {
                    contentElement.style.display = 'block';
                    toggleButton.textContent = '‚àí';
                } else {
                    contentElement.style.display = 'none';
                    toggleButton.textContent = '+';
                }
            }
        }



        // Â∞ÜÂøÖË¶ÅÂáΩÊï∞ÊåÇËΩΩÂà∞ÂÖ®Â±Ä
        window.debugSettingsData = debugSettingsData;
        window.toggleCardContent = toggleCardContent;
        window.syncDataConsistency = syncDataConsistency;
        window.fixDataConsistency = fixDataConsistency;
    </script>

    <!-- ÂñúÊä•ÂºπÁ™ó -->
    <div id="celebrationModal" class="celebration-modal">
        <div class="celebration-content">
            <div class="celebration-header">
                <button class="celebration-close" onclick="closeCelebrationModal()">√ó</button>
                <button class="celebration-copy" onclick="copyModalImage()" title="Â§çÂà∂ÊàòÊä•ÂõæÁâá">üìã</button>
                <div class="celebration-main-title">ÊàòÊä•</div>
                <div class="celebration-trophy">üèÜ</div>
                <h2 class="celebration-title">üéâ ÊÅ≠ÂñúÔºÅÈîÄÂîÆËÆ∞ÂΩïÊ∑ªÂä†ÊàêÂäü</h2>
                <div class="celebration-motto" id="celebrationMotto">Êñ∞ÂæÅÁ®ã¬∑Êñ∞Ë∑®Ë∂ä ÈÇÄÊÇ®‰∏ÄËµ∑ËßÅËØÅ</div>
            </div>
            <div class="celebration-body">
                <div class="celebration-time" id="celebrationTime"></div>
                <div class="celebration-details" id="celebrationDetails"></div>
            </div>
        </div>
    </div>



    <!-- È°µÈù¢Â∫ïÈÉ®ÁΩ≤Âêç -->
    <footer style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); color: #333; text-align: center; padding: 20px; margin-top: 30px; border-top: 1px solid #e9ecef;">
        <div style="font-size: 14px; opacity: 0.9;">
            <p style="margin: 0; padding: 5px 0;">
                üè¢ <strong>ÈîÄÂîÆËÆ∞ÂΩïÁÆ°ÁêÜÁ≥ªÁªü</strong> | ÁâàÊú¨ 1.3
            </p>
            <p style="margin: 0; padding: 5px 0; font-size: 12px;">
                Áî±ËøêËê•ÈÉ® <strong>Âê¥Áïè</strong> Âà∂‰ΩúÁºñÂà∂ | 2025Âπ¥6Êúà15Êó•
            </p>
            <p style="margin: 0; padding: 5px 0; font-size: 11px; opacity: 0.8;">
                ‰∏ì‰∏öÁöÑÈîÄÂîÆÊï∞ÊçÆÁÆ°ÁêÜ‰∏éÁªüËÆ°ÂàÜÊûêÂπ≥Âè∞
            </p>
        </div>
    </footer>
</body>
</html>


